---
title: "Metabolites_analysis_v5"
author: "Arnau Vich"
date: "6/27/2020"
output: html_document
---


Introduction
===

Untargeted metabolomics
---

In this project we aim to investigate the relation between fecal metabolites and inflammatory bowel diseases phenotypes. The cohort consist of 750 samples of different patients, devided in 255 controls from the population cohort LifeLines (NL), 270 patients with Crohns disease and 211 patients with ulcerative colitis from the 1000IBD cohort (NL). 

Metabolites were measured using METABOLON platform combining untargeted metabolite detection with short chain fatty acids measurments. Untargeted metabolite detection consisted on an ultrahigh performance liquid chromatography tandem mass spectrocopy (UPLC-MS/MS): 2 acidic positive ion condition (C18 columns) + 1 Basic negative ion optimazed (C18 column) + 1 Basic negative ionization (Hilic column).

Metabolites will be combined with the following data layers: matching shot-gun sequencing metagenomics (from the same sample), host phenotypes at time of sampling (including disease phenotypes), diet (food frequency questionnaires) & host genetics (GSA and WES data). 


SCFA quantification [METABOLON description]
---

Human feces samples are analyzed for eight short chain fatty acids: acetic acid (C2), propionic acid (C3), isobutyric acid (C4), butyric acid (C4), 2-methyl-butyric acid (C5), isovaleric acid (C5), valeric acid (C5) and caproic acid (hexanoic acid, C6) by LC-MS/MS.


Human feces samples are spiked with stable labelled internal standards and are homogenized and subjected to protein precipitation with an organic solvent. 

The peak area of the individual analyte product ions is measured against the peak area of the product ions of the corresponding internal standards. Quantitation is performed using a weighted linear least squares regression analysis generated from fortified calibration standards prepared immediately prior to each run.


The QC Endogenous was prepared from a single lot of human stool. All analytes are at the endogenous level except hexanoic acid, which was spiked in due to low levels in this lot. The other three levels of QC were prepared by spiking phosphate buffered saline (PBS) with all analytes to achieve the appropriate concentrations for each level.


Sample analysis was carried out in a 96-well plate format containing two calibration curves and eight QC samples (per plate) to monitor assay performance. Twelve batches were prepared and analyzed.


Precision was evaluated using the corresponding QC replicates in the sample runs. QCs met acceptance criteria at all levels for all analytes (Targeted acceptance criteria: at least 50% of QC samples at each concentration level per analyte should be within ±20.0% of the running mean, and at least 2/3 of all QC samples per analyte should fall within ±20.0% of the corresponding running mean.).


A total of 750 human stool samples were analyzed.
Analyte concentrations that fell below and above the limit of quantitation are extrapolated, and the reported values given a comment of BLOQ or ALOQ, respectively. 

Analytes that cannot be extrapolated below the limit of quantitation are considered not quantifiable and are noted as N/Q. Samples that did not have sufficient quantity are noted as QNS.


Load libraries
---

```{r, warning=F,message=FALSE, echo=TRUE}
library(corrplot)
library(plotly)
library(pheatmap)
library(NbClust)
library(reshape2)
library(ggrepel)
library(dplyr)
library(eulerr)
library(vegan)
library(ape)
library(ggridges)
library (UpSetR)
library(ggplot2)
library(psych)
library(ggord)
library(data.table)
library(mice)
library(caret)
library(factoextra)
library(Rtsne)
library(heatmaply)
library(ggpubr)
library(ggbiplot)
library(coin)
library(DT)
library(pvclust)
library(glmnet)
library(compositions)
library(RColorBrewer)
library(iClusterPlus)
library (ggvegan)
library (VIM)
```

Create functions
---

```{r}
####################################
#Inverse rank transformation function.
####################################

invrank= function(x) {qnorm((rank(x,na.last="keep")-0.5)/sum(!is.na(x)))}

###############################
#negate in (to exclude columns)
###############################

`%ni%` <- Negate(`%in%`)

#####################################
#Imputation and filtering metabolites
#####################################

impute_missing_values=function(x, samples_row=T, method="knn", missing_filter=0){
  #if samples are in columns transpose
  if (!samples_row){
    x=as.data.frame(t(x))
  } 
  #Exclude/keep columns that pass the missigness threshold
  if (missing_filter>1){
    stop("\n Hey! \n Values should be a proportion of missing values allowed per column: a value from 0 to 1") 
  }
  col_ori=ncol(x)
  col_keep=colnames(x)[colSums(!is.na(x))/nrow(x)>missing_filter]
  x=x[,col_keep]
  my_num_removed=col_ori-ncol(x)
  warning (paste(my_num_removed, "columns removed due to many missing values"))
  if (method=="zero"){
    x[is.na(x)]=0
  }
  else if (method=="min"){
    x[sapply(x, is.numeric)] <- lapply(x[sapply(x, is.numeric)], function(a) ifelse(is.na(a), min(a, na.rm = TRUE), a))
  }
  else if (method=="hfmin"){
    x[sapply(x, is.numeric)] <- lapply(x[sapply(x, is.numeric)], function(a) ifelse(is.na(a), min(a, na.rm = TRUE)/2, a))
  }
  else if (method=="mean"){
    x[sapply(x, is.numeric)] <- lapply(x[sapply(x, is.numeric)], function(a) ifelse(is.na(a), mean(a, na.rm = TRUE), a))
  }
  else if (method=="median"){
    x[sapply(x, is.numeric)] <- lapply(x[sapply(x, is.numeric)], function(a) ifelse(is.na(a), median(a, na.rm = TRUE), a))
  }
  else if (method=="knn"){
    x=kNN(x,k=10,metric = "euclidean", imp_var = F)
  }
  else if (method=="none"){
    x=x
  }
  else{
    stop("\n Hey! \n Method parameters for imputing missing values per column are: \n min -> min (col), hfmin -> min(col)/2, mean -> mean (col), median -> median(col), mice -> using mice package [Multivariate Imputation By Chained Equations] defaults \n")
  }
  return(as.data.frame(x))
}


##############################
# Summary stats
##############################

summary_stats=function(feature_matrix,pheno, missing_vals=0){
  a=1
  num_var=length(levels(pheno[,1]))
  print (paste("Number of phenotypes detected for summary statistics:", num_var))
  summary_met=matrix(nrow=ncol(feature_matrix),ncol=(9*(num_var+1))+1)
  for (i in 1:ncol(feature_matrix)){
    #print (colnames(feature_matrix)[i])
    if (missing_vals==0){
      pos=2
      summary_met[i,pos]=sum(feature_matrix[,i]!=0)
      pos=pos+1
      summary_met[i,pos]=sum(feature_matrix[,i]==0)
    }
    else {  
      pos=2
      summary_met[i,pos]=sum(is.na(feature_matrix[,i]))
      pos=pos+1
      summary_met[i,pos]=sum(!is.na(feature_matrix[,i]))
    }
    if (sum(is.na(feature_matrix[,i]) == nrow(feature_matrix))){
      pos=pos+1
      summary_met[i,pos]="NA"
      pos=pos+1
      summary_met[i,pos]="NA"
      pos=pos+1
      summary_met[i,pos]="NA"
      pos=pos+1
      summary_met[i,pos]="NA"
      pos=pos+1
      summary_met[i,pos]="NA"
      pos=pos+1
      summary_met[i,pos]="NA"
      pos=pos+1
      summary_met[i,pos]="NA"
    }
    else{
      pos=pos+1
      summary_met[i,pos]=min(feature_matrix[,i], na.rm = T)
      pos=pos+1
      summary_met[i,pos]=max(feature_matrix[,i], na.rm = T)
      pos=pos+1
      summary_met[i,pos]=mean(feature_matrix[,i], na.rm = T)
      pos=pos+1
      summary_met[i,pos]=median(feature_matrix[,i], na.rm = T)
      pos=pos+1
      summary_met[i,pos]=sd(feature_matrix[,i], na.rm = T)
      pos=pos+1
      summary_met[i,pos]=length(boxplot(feature_matrix[,i], plot=FALSE, range = 3)$out)
      if (sum(!is.na(feature_matrix[,i])) < 10){
        pos=pos+1
        summary_met[i,pos]="NA"
        } else {
        nor=shapiro.test(feature_matrix[,i])
        pos=pos+1
        summary_met[i,pos]=nor$p.value>=0.05
      }
    }
    for (x in levels (pheno[,1])){
      id_list=rownames(pheno)[pheno[,1]==x]
      tmp_all=feature_matrix[rownames(feature_matrix)%in%id_list,]
      pos=pos+1
      summary_met[i,pos]=sum(is.na(tmp_all[,i]))
      pos=pos+1
      summary_met[i,pos]=sum(!is.na(tmp_all[,i]))
      if (sum(is.na(tmp_all[,i]) == nrow(tmp_all))){
        pos=pos+1
        summary_met[i,pos]="NA"
        pos=pos+1
        summary_met[i,pos]="NA"
        pos=pos+1
        summary_met[i,pos]="NA"
        pos=pos+1
        summary_met[i,pos]="NA"
        pos=pos+1
        summary_met[i,pos]="NA"
        pos=pos+1
        summary_met[i,pos]="NA"
        pos=pos+1
        summary_met[i,pos]="NA"
      }else{
        pos=pos+1
        summary_met[i,pos]=min(tmp_all[,i], na.rm = T)
        pos=pos+1 
        summary_met[i,pos]=max(tmp_all[,i], na.rm = T)
        pos=pos+1 
        summary_met[i,pos]=mean(tmp_all[,i], na.rm = T)
        pos=pos+1
        summary_met[i,pos]=median(tmp_all[,i], na.rm = T)
        pos=pos+1 
        summary_met[i,pos]=sd(tmp_all[,i], na.rm = T)
        pos=pos+1 
        summary_met[i,pos]=length(boxplot(tmp_all[,i], plot=FALSE, range = 3)$out)
        if (sum(!is.na(tmp_all[,i])) < 10){
          pos=pos+1 
          summary_met[i,pos]="NA"
          } else {
          #nor=NA
          nor=shapiro.test(tmp_all[,i])
          pos=pos+1 
          summary_met[i,pos]=nor$p.value>=0.05
          }
        }
      }
    }
  summary_met[,1]=colnames(feature_matrix)
  my_colnames=c("Metabolite", "NAs","Non_NAs", "Min", "Max", "Mean", "Median","SD", "Outliers_x3IQR","Normal_distrib")
  for (o in levels (pheno[,1])){
    my_colnames=c(my_colnames,paste("NAs",o, sep="_"))
    my_colnames=c(my_colnames,paste("Non_NAs",o,sep="_"))
    my_colnames=c(my_colnames,paste("Min",o,sep="_"))
    my_colnames=c(my_colnames,paste("Max",o,sep="_"))
    my_colnames=c(my_colnames,paste("Mean",o,sep="_"))
    my_colnames=c(my_colnames,paste("Median",o,sep="_"))
    my_colnames=c(my_colnames,paste("SD",o,sep="_"))
    my_colnames=c(my_colnames,paste("Outliers_x3IQR",o,sep="_"))
    my_colnames=c(my_colnames,paste("Normal_distrib",o,sep="_"))
  }
  colnames(summary_met)=my_colnames
  return(summary_met)
}  



###############################################
# Filtering and transforming taxa             #
###############################################

transform_and_filter_taxa=function(x, samples_row=T, method="asin", missing_filter=0){
  x[x=="NA"]=0
  x[x=="NaN"]=0
  #if samples are in columns transpose
  if (!samples_row){
  
    x=as.data.frame(t(x))
  
  } 
  #Exclude/keep columns that pass the missigness threshold
  if (missing_filter>100){
  
    stop("\n Hey! \n Values should be a proportion of missing values allowed per column: a value from 0 to 100") 
  
  }
  
  x_filt=x[,((colSums(x !=0) / nrow(x)) *100 )>missing_filter]
  my_num_removed=ncol(x)-ncol(x_filt)
  print (paste(my_num_removed, "species removed due to many missing values"))
  
  if (method=="asin"){
    print ("ASIN")
    x_filt=x_filt/100
    x_filt=asin(sqrt(x_filt))

  } else if (method=="log"){
    print ("LOG10")
    #replace 0 by the half of the smallest value observed
    my_min=min(x_filt[x_filt>0])/2
    x_filt=x_filt+my_min
    x_filt=log10(x_filt)

  }else if (method=="clr"){
    print ("CLR")
    #Adapted from Alexander Kurilshikov 
    #x_filt=x_filt/100
    #replace 0 by the half of the smallest value observed
    my_min=min(x[x>0])/2
    x=x+my_min
    #Calculate geometric mean
    gm_mean = function(x, na.rm=TRUE){
      exp(sum(log(x), na.rm=na.rm) / length(x))
    }
    Gmean_core = apply(x, 1, gm_mean)
    data_prepared = cbind(Gmean_core,x)
    d <- t(apply(data_prepared, 1, function(b) {
      log(b/b[1])[-1]
    }))
    x=d
    x_filt=x[,colnames(x) %in%colnames(x_filt)]
  }
  return(as.data.frame(x_filt))
}



###############################################
# Calculate ratios                           #
###############################################


calculate_all_ratios=function(x,is_log=T,feature_in_column=T){
  print (paste("Number of features detected:",ncol(x)))
  if(feature_in_column==F){
    x=as.data.frame(t(x))
    print ("transposing")
  }
  if (is_log==T){
    flag=1
    n=1
    l=c()
    for (a in 1:(ncol(x)-1)){
      print (colnames(x)[a])
      for (b in (a+1):ncol(x)){
        my_ratio_names=paste(colnames(x)[a],colnames(x)[b], sep = "_vs_")
        l[[n]]=my_ratio_names
        n=n+1
        my_ratios=x[,a]-x[,b]
        if (flag==1){
          my_out=my_ratios
          #colnames(my_out)=my_ratio_names
            flag=5
        }else{
          my_out=cbind(my_out,my_ratios)
        }
      }
    }
  } else{
    flag=1
    n=1
    l=c()
    for (a in 1:(ncol(x)-1)){
      for (b in (a+1):ncol(x)){
        my_ratio_names=paste(colnames(x)[a],colnames(x)[b], sep = "_vs_")
        l[[n]]=my_ratio_names
        n=n+1
         my_ratios=log10(x[,a]/x[,b])
        if (flag==1){
          my_out=my_ratios
          #colnames(my_out)=my_ratio_names
            flag=5
        }else{
          my_out=cbind(my_out,my_ratios)
        }
      }
    }
  }
  my_out=as.data.frame(my_out)
  colnames(my_out)=l
  rownames(my_out)=row.names(x)
  return(my_out)
}
  



```


1. Import data
===

a) Metabolites: Here we use both raw values provided by Metabolon (metabolites AUC).


b) Short Chain Fatty Acids (SFCA): Together with the untargetted metabolite assessment, SCFA concentrations were measured in the same fecal samples (μg/g)


c) Host phenotypes: Information about the host (age,sex,BMI, diet, etc.). This consist of 3 files: phenotypes shared and used for the case-control analysis, phenotypes specific for the population controls & phenotypes specific for cases (disease location, activity, etc.)


d) Experiment variables: Different technical variables from the untargetted metabolic experiments. We will use this information as a potential counfounding factors. 


e) Genetics. 


f) Metagenomics taxa: MetaPhlan's profiles (v2.9)


g) Pathway annotation provided by Metabolon


h) ID's for each data modality: Allows to combine different datasets / information 

```{r, warning, message=F, echo=T}

# a) Raw values (AUC of peaks)
all_metabolites_raw <- read.delim("~/Desktop/Metabolomics_v2/1.Raw_data_Metabolon/all_metabolites_raw2.txt", row.names=1)
#all_metabolites_raw <- read.delim("~/Documents/Project_Metabolome/1.Input_files/all_metabolites_raw2.txt", row.names=1)

# b) SCFA

SCFA <- read.delim("~/Desktop/Metabolomics_v2/1.Raw_data_Metabolon/SCFA.txt")

# c) Phenotypes

phenos_ibd=read.delim("~/Desktop/Metabolomics_v2/1.Raw_data_Metabolon/Merged_IBD_phenos_clean_v2.txt",row.names = 1)
phenos_lld=read.delim("~/Desktop/Metabolomics_v2/1.Raw_data_Metabolon/Merged_LLD_phenos_clean_v2.txt", row.names=1)
cc_pheno=read.delim("~/Desktop/Metabolomics_v2/1.Raw_data_Metabolon/case_control_meta_v1.txt", row.names=1)
cc_stoma=cc_pheno[,c("ibd_CurrentStomaOrPouch"),drop=F]
montreal= read.delim("~/Desktop/Metabolomics_v2/1.Raw_data_Metabolon/only_montreal.txt", row.names=1)

# d) Experiment variables 

my_batch=read.delim("~/Desktop/Metabolomics_v2/1.Raw_data_Metabolon/Metabolon_preparation_v2.txt", row.names=1)


# e) Genetics


# f) Metagenomic taxa (add metagenomic genes/pathways)

#MetaPhlAn v3
my_taxa = read.delim("~/Documents/Project_Metabolome/2.taxa/taxa_metabolomics_samples_mpa3_3.txt", row.names=1, check.names = F)

# g) Metabolites annotation
annot <- read.delim("~/Desktop/Metabolomics_v2/1.Raw_data_Metabolon/info_metabolites_v2.txt", row.names=1)
annot$SUPER.PATHWAY.1=NULL


# h) ID's index (translate from different data modalities metabolomics <-> metagenomic <-> phenotypes)

IDs_LLD <- read.delim("~/Desktop/Metabolomics_v2/1.Raw_data_Metabolon/IDs_LLD.txt", header=FALSE)
IDs_IBD <- read.delim("~/Desktop/Metabolomics_v2/1.Raw_data_Metabolon/IDs_IBD.txt", header=FALSE)
```

Check phenotypes files (count NA's)
---

```{r}
na_count = sapply(cc_pheno, function(y) sum(length(which(is.na(y)))))
na_count=data.frame(na_count)
cc_pheno$host_BMI[is.na(cc_pheno$host_BMI)]=median(cc_pheno$host_BM, na.rm = T)
cc_pheno$med_ACE_inhibitor[is.na(cc_pheno$med_ACE_inhibitor)]="Non_user"
cc_pheno$med_PPI[is.na(cc_pheno$med_PPI)]="Non_user"

diet=colnames(cc_pheno)[grep("diet",colnames(cc_pheno))]

for (a in diet){
  cc_pheno[,a][is.na(cc_pheno[,a])]=median(cc_pheno[,a], na.rm = T)
}

cc_pheno$host_smk_current[is.na(cc_pheno$host_smk_current)]="no"

na_count = sapply(cc_pheno, function(y) sum(length(which(is.na(y)))))
na_count=data.frame(na_count)

```


Adjust all ids
---

__Translate all id's to the same id (easier to deal with multiple tables)__


```{r, warning=F,message=FALSE, echo=TRUE}

#Change Metabolon ids to UMCG ids to connect later to phenotypes 
all_raw=as.data.frame(t(all_metabolites_raw))

# Select IDs
IDs_IBD=IDs_IBD[,c(1,5)]
IDs_LLD$V2=NULL

# [IMPORTANT] Table with matching ids between UMCG and Metabolon
IDs=data.frame(rbind(as.matrix(IDs_IBD), as.matrix(IDs_LLD)))
rownames(IDs)=IDs$V1
IDs$V1=NULL

# Merge to replace the ids Metabolon => UMCG

all_new_ID_raw=merge(IDs,all_raw, by="row.names")
rownames(all_new_ID_raw)=all_new_ID_raw$V5
all_new_ID_raw$Row.names=NULL
all_new_ID_raw$V5=NULL

#Repeat for the batch information: Metabolon ID => UMCG ID

my_batch_id=merge(IDs,my_batch, by="row.names")
rownames(my_batch_id)=my_batch_id$V5
my_batch_id$Row.names=NULL
my_batch_id$V5=NULL

#In case that we use the transformed data provided by Metabolon

#all=as.data.frame(t(all_metabolites))
#all_new_ID=merge(IDs,all, by="row.names")
#row.names(all_new_ID)=all_new_ID$V5
#all_new_ID$V5=NULL
#all_new_ID$Row.names=NULL
#all_new_ID=all_new_ID[row.names(all_new_ID)%ni%remove_pouch_stoma,]
#all_new_ID_with_stoma=all_new_ID

tract_id=data.frame(row.names(all_new_ID_raw))
rownames(tract_id)=tract_id$row.names.all_new_ID_raw.
tract_id$In_metabolomics="Yes"
tract_id$row.names.all_new_ID_raw.=NULL
tract_id=merge(tract_id,cc_stoma, by="row.names")
rownames(tract_id)=tract_id$Row.names
tract_id$Row.names=NULL

```


2. Summary statistics
===


Annotation by METABOLON
---

Describe the categories of metabolites
---

```{r, warning=F,message=FALSE, echo=F}
met_2=as.data.frame(table(annot$SUPER.PATHWAY))
met_1=as.data.frame(table(annot$SUB.PATHWAY))

ggplot(met_2, aes(x = reorder(Var1, -Freq),Freq)) + geom_bar(stat = "identity", color="black") + theme_classic() + theme(axis.title.x = element_blank(),axis.text.y = element_text(size = 12)) + coord_flip() + xlab("") + ylab("Number of metabolites")

#ggplotly(yy)
```

```{r, warning=F,message=FALSE, echo=F,fig.height=20}
xx=ggplot(met_1, aes(x = reorder(Var1, -Freq),Freq)) + geom_bar(stat = "identity", color="black") + theme_classic() + theme(axis.title.x = element_blank(),axis.text.y = element_text(size = 5)) + coord_flip() + xlab("") + ylab("Number of metabolites")

ggplotly(xx)
```


Remove participants with a pouch or stoma
---

__Rational: Patients with pouch or stoma do not capture the colonic metabolite/microbiota profile__

```{r}
remove_pouch_stoma=rownames(phenos_ibd)[phenos_ibd$ibd_CurrentStomaOrPouch=="yes"]
#Keep data of the participants with stoma
all_new_ID_raw_with_stoma=all_new_ID_raw
#Remove
all_new_ID_raw=all_new_ID_raw[row.names(all_new_ID_raw)%ni%remove_pouch_stoma,]
cc_pheno=cc_pheno[row.names(cc_pheno)%ni%remove_pouch_stoma,]
print (paste("Number of samples excluded due to pouch or stoma:", length(remove_pouch_stoma)))
print (paste("Number of samples left:", length(rownames(all_new_ID_raw))))
```


Summary stats per metabolite per cohort
---

```{r, echo=T, message=F, warning=F}

#Raw data
select=cc_pheno[,1, drop=F]
summary_met=summary_stats(all_new_ID_raw,select, missing_vals = "NA")
summary_met=as.data.frame(summary_met)
#write.table(summary_met, "~/Desktop/Metabolomics_v2/3.Preliminary_results/Metabolites_summary.txt", sep = "\t", quote = F)
```


__Check prevalence per phenotype__

```{r, echo=T, message=F, warning=F}
summary_short=summary_met[,c("Metabolite", "Non_NAs")]
summary_short2=summary_met[,c("Metabolite","Non_NAs","Non_NAs_Control","Non_NAs_CD", "Non_NAs_UC")]
summary_short2$prevalence_all=((as.numeric(as.character(summary_short2$Non_NAs))/nrow(all_new_ID_raw))*100)
summary_short2$prevalence_Control=((as.numeric(as.character(summary_short2$Non_NAs_Control))/length(select[select$ibd_Diagnosis=="Control",])*100))
summary_short2$prevalence_CD=((as.numeric(as.character(summary_short2$Non_NAs_CD))/length(select[select$ibd_Diagnosis=="CD",])*100))
summary_short2$prevalence_UC=((as.numeric(as.character(summary_short2$Non_NAs_UC))/length(select[select$ibd_Diagnosis=="UC",])*100))
summary_short2$Non_NAs=NULL
summary_short2$Non_NAs_Control=NULL
summary_short2$Non_NAs_CD=NULL
summary_short2$Non_NAs_UC=NULL
summary_short2[,-1] <-round(summary_short2[,-1],0)
summary_short3=melt(summary_short2)
```

__Presence of each metabolite per sample__

```{r, echo=F}
aa=ggplot(summary_short, aes(reorder(Metabolite,-as.numeric(as.character(Non_NAs))),as.numeric(as.character(Non_NAs))))+ geom_bar(color="darkblue",stat = "identity") + theme_classic() + ylab("Number of samples (n=682)") + xlab("Metabolites") +  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())

ggplotly(aa)
```

__Percentage of prevalence of metabolites per cohort__

```{r, echo=F}
bb=ggplot(summary_short3, aes(value, fill=variable)) + geom_histogram(position = "dodge", bins = 10, binwidth = 7, color="black") + theme_bw() + scale_fill_manual(values = c("grey79","white","blue2", "firebrick2")) + ylab("Number of metabolites") + xlab("% presence in samples")

ggplotly(bb)
```

__Prevalence/Missigness per metabolite per cohort with annotations__

```{r, echo=F}
summary_short4=summary_short2
rownames(summary_short4)=summary_short4$Metabolite
summary_short4$Metabolite=NULL
summary_short4=merge(annot,summary_short4, by="row.names")
rownames(summary_short4)=summary_short4$Row.names
summary_short4$Row.names=NULL
colnames(summary_short4)=c("Super pathway","Annotation", "Detected in cohort (%)", "Detected in controls (%)", "Detected in CD (%)", "Dectected in UC (%)")
datatable(summary_short4)
#write.table(summary_short4, "~/Desktop/Metabolomics_v2/3.Preliminary_results/Metabolites_prevalence_short_2020.txt", sep = "\t", quote = F)
```


__Number of metabolites per samples__

```{r, warning=F,message=FALSE, echo=TRUE}

all_new_ID_raw2=as.data.frame(t(all_new_ID_raw))
summary_sample=matrix(nrow=ncol(all_new_ID_raw2), ncol=3)

for (i in 1:ncol(all_new_ID_raw2)){
  summary_sample[i,2]=sum(is.na(all_new_ID_raw2[,i]))
  summary_sample[i,3]=sum(!is.na(all_new_ID_raw2[,i]))
}

summary_sample[,1]=colnames(all_new_ID_raw2)
summary_sample=as.data.frame(summary_sample)
colnames(summary_sample)=c("Metabolite", "NAs","Non_NAs")
summary_sample$perc_detected=((as.numeric(as.character(summary_sample$Non_NAs))/nrow(all_new_ID_raw2))*100)
rownames(summary_sample)=summary_sample$Metabolite
summary_sample$Metabolite=NULL
summary_sample2=merge(summary_sample,cc_pheno,by="row.names")
#write.table(summary_sample, "~/Desktop/Metabolomics_v2/3.Preliminary_results/metabolites_per_samples.txt", sep = "\t", quote = F)

```


```{r, echo=F}
cc=ggplot(summary_sample2, aes(perc_detected, fill=ibd_Diagnosis)) + geom_histogram(position = "dodge", bins = 100, binwidth = 7, color="black") + theme_bw() + scale_fill_manual(values = c("firebrick2","white","grey42","blue2")) + ylab("Number of samples") + xlab("% detected metabolites")

ggplotly(cc)
```




__Summary statistics microbiome__

1. Focus only at species taxa level


2. Filter out taxa present in less than 20% of all samples


```{r, warning=F,message=FALSE, echo=T}
######################################
##Taxa predicted from MetaPhlAn 3 ####
######################################
#Remove the percentage of unaligned reads
taxa=my_taxa[-1,]
preFilt=data.frame(colnames(taxa))
preFilt$In_MGS="Yes"

#Remove samples that failed in the microbiome prediction: IBDFEC0535, IBDFEC1024,IBDFEC0515
taxa=taxa[, colSums(taxa != 0) > 0]

#Keep track of the samples that failed microbiome prediction 
preFilt[preFilt$colnames.taxa.%ni%colnames(taxa),]$In_MGS="Failed"
rownames(preFilt)=preFilt$colnames.taxa.
preFilt$colnames.taxa.=NULL
tract_id=merge(tract_id,preFilt, by="row.names", all=T)
tract_id=tract_id[complete.cases(tract_id$In_metabolomics),]
row.names(tract_id)=tract_id$Row.names

#Select genus level

taxa_gn=taxa[unlist(lapply(rownames(taxa),function(x) length(unlist(strsplit(x, "|", fixed=TRUE)))==6)),]
#Remove other taxa levels from names
rownames(taxa_gn)=sapply(strsplit(rownames(taxa_gn), "|", fixed=TRUE), tail, 1)

#Clean species names

taxa_sp=taxa[grep("s__", rownames(taxa)), ]
taxa_sp=taxa_sp[!grepl("t__", rownames(taxa_sp)), ]
row.names(taxa_sp)=gsub(".*s__","",row.names(taxa_sp))

taxa_per_disease=summary_stats(as.data.frame(t(taxa_sp)), select)

##########################################


taxa=as.data.frame(t(taxa_sp))

my_shannon=as.data.frame(diversity(taxa, index="shannon"))
colnames(my_shannon)=c("Shannon_Index")
my_simpson=as.data.frame(diversity(taxa, index="simpson"))
colnames(my_simpson)=c("Simpson_Index")
richness_microbiota=merge(my_shannon,my_simpson,by="row.names")
rownames(richness_microbiota)=richness_microbiota$Row.names
richness_microbiota$Row.names=NULL

#Remove samples with low richeness
norich=rownames(richness_microbiota)[richness_microbiota$Shannon_Index==0] 
tract_id[rownames(tract_id)==norich,]$In_MGS="Failed"

richness_microbiota2=subset(richness_microbiota,rownames(richness_microbiota) %in% rownames(summary_sample))
richness_microbiota2=richness_microbiota2[richness_microbiota2$Shannon_Index>0,]
cc_pheno2=merge(richness_microbiota2,cc_pheno,by="row.names")
rownames(cc_pheno2)=cc_pheno2$Row.names
cc_pheno2$Row.names=NULL

print (paste("Number of samples excluded due failed metagenomics:", length(tract_id[tract_id$In_MGS!="yes",])))
print (paste("Number of samples left:", length(rownames(cc_pheno2))))
```

__Microbial richness indexes (Shannon & Simpson)__

```{r, echo=F}
cc_pheno2.1=cc_pheno2
cc_pheno2.1$ibd_Diagnosis=as.character(cc_pheno2.1$ibd_Diagnosis)
cc_pheno2.1$ibd_Diagnosis[cc_pheno2.1$ibd_Diagnosis=="Control"]="A_Control"
ggplot(cc_pheno2.1, aes(ibd_Diagnosis,Shannon_Index, fill=ibd_Diagnosis)) + theme_bw() + geom_violin(alpha=0.8) + geom_jitter(height = 0, width = 0.1, alpha=0.4) + geom_boxplot(width=0.1,position=position_dodge(1), alpha=0.2, fill="white")   + theme_bw()  + scale_fill_manual(values = c("white","firebrick2","grey42","blue2"))

```


__Filter bacteria (detection in >20% of the samples) and normalization__


```{r}

#Subset samples from the taxonomic table for which we also have metabolomics 
taxa2=subset(taxa,rownames(taxa) %in% rownames(cc_pheno2))
taxa_gn2=taxa_gn[,colnames(taxa_gn) %in% rownames(cc_pheno2)]

print (paste("Number of taxa detected:",ncol(taxa2)))

#Filter 20% and to clr transformation
taxa_filt=transform_and_filter_taxa(taxa2,samples_row = T,method = "clr",missing_filter = 20)
taxa_gn_filt=transform_and_filter_taxa(t(taxa_gn2),samples_row = T,method = "clr",missing_filter = 20)

print (paste("Number of taxa after filtering",ncol(taxa_filt)))

#Merge taxa and phenotypes
cc_pheno3=merge(cc_pheno2,taxa_filt,by="row.names")
rownames(cc_pheno3)=cc_pheno3$Row.names
cc_pheno3$Row.names=NULL

```



3. Filter metabolites by missigness
===

__We remove metabolites that are present in less than 20% of the samples in the 3 cohorts (CD,UC,Controls)__


```{r,echo=F}

to_remove=subset(summary_short2,prevalence_Control<20 & prevalence_CD<20 & prevalence_UC<20)
q_mtb_v2=all_new_ID_raw[,colnames(all_new_ID_raw) %ni%to_remove$Metabolite]
print(paste("Number of metabolites removed:",length(to_remove$Metabolite)))
```

__Metabolites present in more than 70% of the samples will be analyzed quantitatively__

```{r,echo=F}

#to_keep=subset(summary_short2,prevalence_Control>70 & prevalence_CD>70 & prevalence_UC>70)
to_keep=subset(summary_short2,prevalence_all>70)
q_mtb=all_new_ID_raw[,colnames(all_new_ID_raw) %in%to_keep$Metabolite]
print(paste("Number of metabolites for quantitative analysis:",length(to_keep$Metabolite)))
```


__Metabolites that are present between 20% to 70% of the samples will be subset and transform to binary feature (present/absent)__

```{r,echo=F}
rest=c(list(to_remove$Metabolite),list(to_keep$Metabolite))
#mtb_logistic=subset(summary_short2,prevalence_Control>20 & prevalence_Control<70 & prevalence_UC>20 & prevalence_UC<70 & prevalence_CD>20 & prevalence_CD<70 )

a=droplevels(unlist(to_remove$Metabolite))
b=droplevels(unlist(to_keep$Metabolite))
c=c(levels(a),levels(b))

bi_mtb=all_new_ID_raw[,colnames(all_new_ID_raw) %ni% c]
bi_mtb[!is.na(bi_mtb)]=1
bi_mtb[is.na(bi_mtb)]=0

print(paste("Number of metabolites for presence/absence analysis:",length(colnames(bi_mtb))))
```




Normalize and impute missing metabolites
---

```{r, echo=T, message=F, warning=F}

#Normalize by experiment day: divide each metabolite value by the median of each experimental day 
my_flag=1
for (z in unique(my_batch_id$run_day_cat)){
  my_names=rownames(my_batch_id)[my_batch_id$run_day_cat==z]
  d1=subset(q_mtb, row.names(q_mtb) %in% my_names)
  d1.1=apply(d1, 2, function (x) {x/median(x,na.rm = T)})

  if (my_flag==1){
    q_mtb_norm=d1.1
    my_flag=5

  } else{
    q_mtb_norm=rbind(q_mtb_norm,d1.1)

  }
}


my_flag=1
for (z in unique(my_batch_id$run_day_cat)){
  my_names=rownames(my_batch_id)[my_batch_id$run_day_cat==z]
  d1=subset(q_mtb_v2, row.names(q_mtb_v2) %in% my_names)
  d1.1=apply(d1, 2, function (x) {x/median(x,na.rm = T)})

  if (my_flag==1){
    q_mtb_norm_v2=d1.1
    my_flag=5

  } else{
    q_mtb_norm_v2=rbind(q_mtb_norm_v2,d1.1)

  }
}


q_mtb_t=as.data.frame(q_mtb_norm)

q_mtb_t_v2=as.data.frame(q_mtb_norm_v2)

#apply log10 transformation + scale
q_mtb_t=log10(q_mtb_t)
q_mtb_t_v2=log10(q_mtb_t_v2)


#Impute na's 
### WARNING: KNN imputation takes a while, take a nap or a coffee (in case of re-run save and load results of this stage)
q_mtb=impute_missing_values(q_mtb_t,samples_row = T, method = "knn", missing_filter = 0)
rownames(q_mtb)=row.names(q_mtb_t)
write.table(q_mtb, "~/Desktop/Metabolomics_v2/2.Input/knn_Imputed_metabolites_median_log10.txt", sep = "\t",quote = F)

q_mtb=as.data.frame(q_mtb)
```

__Merge taxa and metabolites__

```{r, echo=F}

print("Missing metagenomic data:")
setdiff( rownames(q_mtb), rownames(taxa_filt))
taxa_and_mb=merge(taxa_filt,q_mtb,by="row.names")
rownames(taxa_and_mb)=taxa_and_mb$Row.names
taxa_and_mb$Row.names=NULL
```


__Summary statistics on transformed & filtered metabolites__

```{r, echo=F}
#Transformed data
summary_met_trans=summary_stats(q_mtb, select, missing_vals = "NA")
summary_met_trans=as.data.frame(summary_met_trans)
write.table(summary_met_trans, "~/Documents/Project_Metabolome/4.Summary_stats/Metabolites_summary_post_filtering_2020_v3", sep = "\t", quote = F)
```


4.Summary of SCFA [Exploratory analysis]
===

__Show SCFA names__

```{r, warning=F,message=FALSE, echo=TRUE}
unique(levels(SCFA$Analyte))
```

__Load data and replace values under the detection levels for missing values and restructure the data__

Original report contain 1 row per sample per measurment, we want to restructure in a way that all samples are in rows and each column is a SCFA.  


```{r, warning=F,message=FALSE, echo=TRUE}
#Duplicate original values (before remplacing for NA)

SCFA$ori_Result=SCFA$Result

#Replace values below level quantification (BLOQ) to NA
SCFA$Result[SCFA$Comment.1=="BLOQ"] = "N/Q"
SCFA$Result[SCFA$Result=="N/Q"] = NA
```

__Summary of the values under the detection levels (TRUE column)__

```{r}
table(SCFA$Analyte,is.na(SCFA$Result))
```


```{r, warning=F,message=FALSE, echo=TRUE}
#Remove unecessary columns (sample type, group/project name, detection limits and comments)

SCFAsub=SCFA[,c("Unique.Sample.ID...as.labeled.on.tube.","Sample.Amount..gram.","Comment","Analyte","Result")]

#Reshape the SCFA table
SCFA_table <- dcast(SCFAsub, ...~Analyte)

#Chance sample names to match metadata
IDs=data.frame(rbind(as.matrix(IDs_IBD), as.matrix(IDs_LLD)))
rownames(SCFA_table)=SCFA_table$Unique.Sample.ID...as.labeled.on.tube.
SCFA_table$Unique.Sample.ID...as.labeled.on.tube.=NULL
rownames(IDs)=IDs$V1
IDs$V1=NULL
SCFA_new_ID=merge(IDs,SCFA_table, by="row.names")
SCFA_new_ID$Row.names=NULL
row.names(SCFA_new_ID)=SCFA_new_ID$V5
SCFA_new_ID$V5=NULL
colnames(SCFA_new_ID)=c("Amount_sample_gram", "Box", "Methylbutyric_acid", "acetic_acid", "butyric_acid", "hexanoic_acid", "isobutyric_acid","isovaleric_acid" ,"propionic_acid", "valeric_acid")
```

__Merge phenotypes to SCFA__

```{r, warning=F,message=FALSE, echo=TRUE}
SCFA2=SCFA_new_ID
SCFA2[,3:10]=sapply(SCFA2[,c(3:10)], function(x) log10(as.numeric(as.character(x))) )
SCFA_with_phenos=merge(SCFA_new_ID,cc_pheno3, by="row.names")
cc_pheno4=merge(SCFA2,cc_pheno3, by="row.names")

SCFAsum=SCFA_new_ID[,3:10, drop=F]
SCFAsum=sapply(SCFAsum, function(x) as.numeric(as.character(x)) )
row.names(SCFAsum)=row.names(SCFA_new_ID)
SCFAsum=SCFAsum[row.names(SCFAsum) %in% row.names(q_mtb),]
summary_SCFA=summary_stats(SCFAsum, select, missing_vals = "NA")

```


__Plot SCFA per diagnosis__

```{r, warning=F,message=FALSE, echo=T}
plot_SCFA=SCFA_with_phenos[,c("Row.names","ibd_Diagnosis","Methylbutyric_acid", "acetic_acid", "butyric_acid", "hexanoic_acid", "isobutyric_acid","isovaleric_acid" ,"propionic_acid", "valeric_acid")]

plot_SCFA$diag=as.character(plot_SCFA$ibd_Diagnosis)
plot_SCFA$diag[plot_SCFA$ibd_Diagnosis=="Control"]="A_Control"
plot_SCFA=subset(plot_SCFA, plot_SCFA$ibd_Diagnosis!="IBDU")

my_comparisions=list( c("CD","A_Control"), c("A_Control","UC"), c("CD","UC"))

ggplot (plot_SCFA, aes (diag,log10(as.numeric(plot_SCFA$hexanoic_acid)), fill=diag)) +geom_violin(alpha=0.8) + geom_jitter(height = 0, width = 0.1, alpha=0.4) + geom_boxplot(width=0.1,position=position_dodge(1), fill="white")+ theme_bw() +scale_fill_manual(values=c("snow","firebrick2","lightblue2"))  + stat_compare_means(comparisons = my_comparisions, method = "wilcox.test") + ylab ("log10(Hexanoic acid µg/g)") + xlab ("Cohort") + scale_x_discrete(labels=c("(n=255)","(n=239)", "(n=176)"))


location=phenos_ibd[,c("ibd_DiseaseLocation", "ibd_Montreal_L","ibd_ActiveDisease")]
#plot_SCFA_loc=merge(location, plot_SCFA, by="row.names", all.y = T)
plot_SCFA_loc=merge(location, plot_SCFA, by="row.names", all.y = T)
plot_SCFA_loc$ibd_DiseaseLocation2=as.character(plot_SCFA_loc$ibd_DiseaseLocation)

plot_SCFA_loc$ibd_DiseaseLocation2[plot_SCFA_loc$ibd_DiseaseLocation!="ileum"]="3_yes"
plot_SCFA_loc$ibd_DiseaseLocation2[plot_SCFA_loc$ibd_DiseaseLocation=="ileum"]="2_no"
plot_SCFA_loc$ibd_DiseaseLocation2[plot_SCFA_loc$diag=="UC"]="4_UC"
plot_SCFA_loc$ibd_DiseaseLocation2[plot_SCFA_loc$diag=="A_Control"]="1_Control"
plot_SCFA_loc$ibd_Montreal_L=as.character(plot_SCFA_loc$ibd_Montreal_L)
plot_SCFA_loc$ibd_Montreal_L[plot_SCFA_loc$diag=="A_Control"]="1_Control"
plot_SCFA_loc=plot_SCFA_loc[ complete.cases(plot_SCFA_loc$ibd_DiseaseLocation2),]

plot_SCFA_loc$ibd_ActiveDisease=as.character(plot_SCFA_loc$ibd_ActiveDisease)
plot_SCFA_loc$ibd_ActiveDisease[plot_SCFA_loc$diag=="A_Control"]="1_Control"

plot_SCFA_loc$ibd_ActiveDisease[plot_SCFA_loc$diag=="UC"]="2_UC"

plot_SCFA_m=melt(plot_SCFA, id.vars = c("Row.names","ibd_Diagnosis"))
plot_SCFA_m=subset(plot_SCFA_m, plot_SCFA_m$ibd_Diagnosis!="IBDU")
plot_SCFA_m$diag=as.character(plot_SCFA_m$ibd_Diagnosis)
plot_SCFA_m$diag[plot_SCFA_m$ibd_Diagnosis=="Control"]="A_Control"
my_comparisions=list( c("CD","A_Control"), c("A_Control","UC"), c("CD","UC"))
```

```{r, warning=F,message=FALSE, echo=F, fig.height=15}
plot_SCFA_m=subset(plot_SCFA_m,plot_SCFA_m$variable!="diag")
ggplot (plot_SCFA_m, aes (diag,log10(as.numeric(as.character(value))), fill=diag)) +geom_violin(alpha=0.8) + geom_jitter(height = 0, width = 0.1, alpha=0.4) + geom_boxplot(width=0.1,position=position_dodge(1), fill="white")  + facet_wrap(~ variable, nrow=2) + theme_bw() +scale_fill_manual(values=c("snow","firebrick2","blue2"))  + stat_compare_means(comparisons = my_comparisions, method = "wilcox.test") + ylab ("log10(SCFA µg/g)") + xlab ("Cohort") + scale_x_discrete(labels=c("(n=255)","(n=239)", "(n=176)"))
```




5.PCA analysis on metabolites present in more than 70% of the samples
===

```{r, warning=F,message=FALSE, echo=TRUE}

norm_filt=q_mtb
pca_log= prcomp(norm_filt,scale. = T, center = T)
cmp_log=as.data.frame(pca_log$x[,1:5])
cmp_log2=merge(cc_pheno2,cmp_log,by="row.names")
v_exp = pca_log$sdev^2
prop_v_exp= data.frame( PC=1:length(v_exp),perc= 100*(v_exp / sum(v_exp)))

```



Percentage of variance explained per component
---

```{r}
prop_v_exp2=prop_v_exp[1:20,]
ggplot(prop_v_exp2, aes (PC,perc)) + geom_bar (stat="identity") + geom_text(aes(label=round(perc, 2)), size=3, vjust=-.5) + theme_bw() + xlab ("Principal components") + ylab ("% explained variance")
```


PC1 & PC2: Diagnosis
---

```{r}

ggplot(cmp_log2, aes(PC1,PC2, color=ibd_Diagnosis)) + geom_point(size=2) + theme_bw() + scale_colour_manual(values =c("purple","black","pink2" ,"darkolivegreen3"))
```

PC2 & PC3: Diagnosis
---

```{r}
ggplot(cmp_log2, aes(PC2,PC3, color=ibd_Diagnosis)) + geom_point(size=2) + theme_bw() + scale_colour_manual(values =c("purple","black","pink2" ,"darkolivegreen3"))
```


Exploring different phenotypes
---


__PC1 & PC2: Bristol stool scale binary (soft vs hard)__


```{r}
ggplot(cmp_log2, aes(PC1,PC2, color=clinical_BinaryBSS)) + geom_point(size=2) + theme_bw()
```



__PC1 & PC2: Number of months that the sample spend in the -80 freezer__


```{r}
ggplot(cmp_log2, aes(PC1,PC2, color=metabolon_Month_in_freezer)) + geom_point(size=2) + theme_bw()
```


__PC1 & PC2: Food frequency: plant protein vs animal proten__


```{r}
ggplot(cmp_log2, aes(PC1,PC2, color=diet_PlanttoAnimal)) + geom_point(size=2) + theme_bw() + scale_colour_viridis()
```


5.PCA & PCoA analysis on bacteria present in more than 20% of the samples
===

__Calculate PCA based on filtered clr relative abundaces__

```{r, echo=F}
print(paste("Number of species used for PCA analysis:", ncol(taxa_filt)))
```

```{r, echo=T}
pca_clr= prcomp(taxa_filt,scale. = T, center = T)
cmp_clr=as.data.frame(pca_clr$x[,1:5])
cmp_clr2=merge(cc_pheno2,cmp_clr,by="row.names")

```

```{r, echo=F}

ggplot(cmp_clr2, aes(PC1,PC2, color=ibd_Diagnosis)) + geom_point() + theme_bw() + scale_colour_manual(values =c("purple","black","pink2" ,"darkolivegreen3"))

```



__Calculate PCoA based on Bray-Curtis distances__


```{r, warning=F,message=FALSE, echo=TRUE}
#Filter present in at least 20% of the samples
taxa2=taxa2/100
taxa2[taxa2=="NA"]=0
taxa2[taxa2=="NaN"]=0
taxa_filt=taxa2[,((colSums(taxa2 !=0) / nrow(taxa2)) *100 )>20]
#Data transformation
#Choose square root arcsine transformation
taxa_asin=asin(sqrt(taxa_filt))

#Calculate bray curtis dissimilarity
bc_dis=vegdist(taxa_asin,method = "bray")
tax_mds <- metaMDS(comm=bc_dis,k=5, autotransform = FALSE)
data.scores <- as.data.frame(scores(tax_mds))
data.scores$site <- rownames(tax_mds) 
bc_mds=merge(cc_pheno2,data.scores,by="row.names")

```


```{r, echo=F}

ggplot(bc_mds, aes(NMDS1,NMDS2, color=ibd_Diagnosis)) + geom_point() + theme_bw(size=2) + cale_colour_manual(values =c("purple","black","pink2" ,"darkolivegreen3"))

```


6. Clustering metabolites
===


Method 1: Regress disease and (potential) technical confouders and perform spearman correlation
---

__Regress batch & diseases effects__

Here we use all metabolites present in more than 20% of the samples. 

We extract residuals from the following linear model (lm) : 

__lm(Metabolite ~ Day_of_measurment  + Amount_of_input_material + LC Column + Months_sample_in_freezer + ibd_Diagnosis (Control/CD/UC) )__

```{r}
rownames(cc_pheno4)=cc_pheno4$Row.names
cc_pheno4$Row.names=NULL
cc_pheno5=merge(my_batch_id,cc_pheno4, by="row.names")
#my_regress_phenos=cc_pheno5[,c("Row.names","run_day_cat", "Amount_sample_gram", "LC.COLUMN" , "metabolon_Month_in_freezer" , "ibd_Diagnosis")]
#Since we normalized each metabolite by its experiment day median we don't need to regress this effect anymore  
my_regress_phenos=cc_pheno5[,c("Row.names", "Amount_sample_gram", "LC.COLUMN" , "metabolon_Month_in_freezer" , "ibd_Diagnosis")]
rownames(my_regress_phenos)=my_regress_phenos$Row.names
my_regress_phenos$Row.names=NULL
rgs_mb=merge(my_regress_phenos,norm_filt, by="row.names")

rgs_mb2=matrix(nrow=nrow(my_regress_phenos), ncol = ncol(norm_filt))
 n=1
for (i in 6:ncol(rgs_mb)){
 #my_lm=lm(rgs_mb[,i] ~ run_day_cat+Amount_sample_gram+LC.COLUMN+metabolon_Month_in_freezer+ibd_Diagnosis,data = rgs_mb)
my_lm=lm(rgs_mb[,i] ~ Amount_sample_gram+LC.COLUMN+metabolon_Month_in_freezer+ibd_Diagnosis,data = rgs_mb)
 rgs_mb2[,n] = my_lm$residuals
 n=n+1
}
rgs_mb2=as.data.frame(rgs_mb2)
rownames(rgs_mb2)=rgs_mb$Row.names
colnames(rgs_mb2)=colnames(rgs_mb)[6:ncol(rgs_mb)]
```

```{r}
#Select metabolite annotation
library ("Hmisc")
annot_v2=annot
annot_v2$SUB.PATHWAY=NULL
annot_v2=subset(annot_v2, rownames(annot_v2) %in% colnames(rgs_mb2))
#cor_metabolites=rcorr(as.matrix(q_mtb), type="spearman")
#cor_metabolites_coef=cor_metabolites$r
#cor_metabolites_pval=cor_metabolites$P
#cor_coef=melt(cor_metabolites_coef)
#cor_pval=melt(cor_metabolites_pval)
#cor_coef$pvalue=cor_pval$value
#write.table(cor_coef, "~/Documents/Project_Metabolome/6.Results/072020/Correlation_corrected_metabolites.txt", sep = "\t", quote = F)

#cor_mtbs=cor_coef

my_IBD=row.names(cc_pheno)[cc_pheno$ibd_Diagnosis!="Control"]
my_CNT=row.names(cc_pheno)[cc_pheno$ibd_Diagnosis=="Control"]

IBDqmtb=subset(q_mtb, rownames(q_mtb) %in% my_IBD)
cor_metabolites=rcorr(as.matrix(IBDqmtb), type="spearman")
cor_metabolites_coef=cor_metabolites$r
cor_metabolites_pval=cor_metabolites$P
cor_coef=melt(cor_metabolites_coef)
cor_pval=melt(cor_metabolites_pval)
cor_coef$pvalue=cor_pval$value
write.table(cor_coef, "~/Desktop/Metabolomics_for_cluster/3.Preliminary_results_v2/Correlation_metabolites_IBD.txt", sep = "\t", quote = F)

CNTqmtb=subset(q_mtb, rownames(q_mtb) %in% my_CNT)
cor_metabolites=rcorr(as.matrix(CNTqmtb), type="spearman")
cor_metabolites_coef=cor_metabolites$r
cor_metabolites_pval=cor_metabolites$P
cor_coef=melt(cor_metabolites_coef)
cor_pval=melt(cor_metabolites_pval)
cor_coef$pvalue=cor_pval$value
write.table(cor_coef, "~/Desktop/Metabolomics_for_cluster/3.Preliminary_results_v2/Correlation_metabolites_CNT.txt", sep = "\t", quote = F)


#TO IMPLEMENT: Network analysis
mynet=graph.adjacency(as.matrix(as.dist(cor(CNTqmtb, method = "spearman"))), mode = "undirected", weighted = T, diag = F)
mynet=simplify(mynet, remove.multiple = T, remove.loops = T)
# Colour negative correlation edges as blue
E(mynet)[which(E(mynet)$weight<0)]$color <- "darkblue"

# Colour positive correlation edges as red
E(mynet)[which(E(mynet)$weight>0)]$color <- "darkred"

# Convert edge weights to absolute values
E(mynet)$weight <- abs(E(mynet)$weight)

mynet <- delete_edges(mynet, E(mynet)[which(E(mynet)$weight<0.6)])

mynet <- delete.vertices(mynet, degree(mynet)==0)

```


Method 2:iClust
----

```{R}

#Features to use: q_mtb (quantitative metabolies), bacterial species clr-transformed ()
clus_taxa=cc_pheno3[,206:314]
clus_pheno=cc_pheno3[,c("ibd_Diagnosis","ibd_DiseaseLocation")]

clus_pheno$IBD=0
#clus_pheno$IBD[clus_pheno$ibd_Diagnosis=="Control",]=0
clus_pheno$IBD[clus_pheno$ibd_Diagnosis!="Control"]=1

clus_pheno$ibd_Diagnosis=NULL
clus_pheno$ibd_DiseaseLocation=NULL

#clus_pheno$Location=as.numeric(unlist(clus_pheno$Location))
clus_pheno$IBD=as.numeric(unlist(clus_pheno$IBD))

clus_mtb=q_mtb[row.names(q_mtb) %in% row.names(clus_pheno),]
clus_mtb=clus_mtb[order(row.names(clus_mtb)),]
table(row.names(clus_mtb)==row.names(clus_pheno))

write.table(clus_mtb, "~/Desktop/Metabolomics_v2/2.Input/clst_mtb3", sep="\t", quote = F)
write.table(clus_pheno, "~/Desktop/Metabolomics_v2/2.Input/clst_pheno3", sep="\t", quote = F)
write.table(clus_taxa, "~/Desktop/Metabolomics_v2/2.Input/clst_taxa3", sep="\t", quote = F)


#Run in Boxy (hpc cluster)

#ml Rplus
#library (iClusterPlus)

clus_mtb=read.table("~/Desktop/Metabolomics_v2/2.Input/clst_mtb3", sep = "\t", header = T, row.names = 1)
clus_taxa=read.table("~/Desktop/Metabolomics_v2/2.Input/clst_taxa3", sep = "\t", header = T, row.names = 1)
clus_pheno=read.table("~/Desktop/Metabolomics_v2/2.Input/clst_pheno3", sep = "\t", header = T, row.names = 1)

#test 1 to 10 clusters

for(k in 1:10){
  cv.fit = tune.iClusterPlus(cpus=8,dt1 = data.matrix(clus_mtb),dt2 = data.matrix(clus_taxa),dt3 = data.matrix(clus_pheno),type=c("gaussian","gaussian", "binomial"),K=k,n.lambda=NULL,scale.lambda=c(1,1,1),maxiter=20)
  save(cv.fit, file=paste("cv.fit.k",k,".Rdata",sep=""))
  }



#Check BIC for each K (number of clusters)


setwd("/Users/arnauvich/Desktop/Metabolomics_v2/3.Preliminary_results/2.Clusters/")
output=alist() 
files=grep("cv.fit",dir())
for(i in 1:length(files)){
  load(dir()[files[i]])
  output[[i]]=cv.fit
} 

#From the manual
#To  select  the  best  k,  we  compute  the  deviance  ratio  which  is  the  ratio  of  the log-likelihood(fitted) - log-likelihood(null model) divided by the log-likelihood (full model)- log-likelihood(null model).  The deviance ratio can be interpreted as the percentEV. We choose the k where the curve of percentEV levels off. 
nLambda = nrow(output[[1]]$lambda)
nK = length(output)
BIC = getBIC(output)
devR = getDevR(output)

minBICid = apply(BIC,2,which.min)
devRatMinBIC = rep(NA,nK)
for(i in 1:nK){
  devRatMinBIC[i] = devR[minBICid[i],i]
}

clusters=getClusters(output)
rownames(clusters)=rownames(clus_mtb)
colnames(clusters)=paste("K=",2:(length(output)+1),sep="")
write.table(clusters, file="/Users/arnauvich/Desktop/Metabolomics_for_cluster/3.Preliminary_results_v2/clusterMembership_iCluster.txt",sep='\t',quote=F)

#Inspect visualy the number of clusters to use

plot(1:(nK+1),c(0,devRatMinBIC),type="b",xlab="Number of clusters (K+1)",ylab="%Explained Variation")

# Warning k=k+1
#plot shows that 4 is the best cluster solution (k=3)
#Show number of samples per cluster: 
print (table(clusters[,3]))
k=3 
best.cluster=clusters[,k]
best.fit=output[[k]]$fit[[which.min(BIC[,k])]]

#Check top-features

features = alist()
features[[1]] = colnames(clus_mtb)
features[[2]] = colnames(clus_taxa)
features[[3]] = colnames(clus_pheno)
sigfeatures=alist()
for(i in 1:3){   
  rowsum=apply(abs(best.fit$beta[[i]]),1, sum)
  upper=quantile(rowsum,prob=0.75)
  sigfeatures[[i]]=(features[[i]])[which(rowsum>upper)]
}
names(sigfeatures)=c("metabolite","taxa","IBD_pheno")
head(sigfeatures[[1]])
head(sigfeatures[[2]])
head(sigfeatures[[3]])

capture.output(sigfeatures, file= "/Users/arnauvich/Desktop/Metabolomics_v2/3.Preliminary_results/Clusters_features_definitions.txt")

clus_sel=data.frame(clusters[,3, drop=F])
clus_sel$Clus="D"
clus_sel$Clus[clus_sel$K.4==3]="A"
clus_sel$Clus[clus_sel$K.4==2]="B"
clus_sel$Clus[clus_sel$K.4==4]="C"
clus_sel$K.4=NULL


#View solution in bacteria PCA
new_pc_bac=merge(clus_sel,cmp_clr2, by="row.names")
ggplot (new_pc_bac, aes(PC1,PC2, color=as.factor(new_pc_bac$Clus))) + geom_point() + theme_bw() + scale_color_manual(values=c("black", "lightblue2", "gold2","firebrick2"))
ggplot (new_pc_bac, aes(PC1,PC3, color=Clus)) + geom_point() + theme_bw() + scale_color_manual(values=c("black", "lightblue2", "gold2","firebrick2"))

#View solution in metabolite PCA
#rownames(cmp_log2)=(cmp_log2$Row.names)
#cmp_log2$Row.names=NULL
new_pc_mtb=merge(clus_sel,cmp_log2, by="row.names")

ggplot (new_pc_mtb, aes(PC1,PC2, color=Clus)) + geom_point() + theme_bw() + scale_color_manual(values=c("black", "lightblue2", "gold2","firebrick2"))
ggplot (new_pc_mtb, aes(PC1,PC3, color=Clus)) + geom_point() + theme_bw() + scale_color_manual(values=c("black", "lightblue2", "gold2","firebrick2"))
plot_ly(x=new_pc_mtb$PC1,y=new_pc_mtb$PC2,z=new_pc_mtb$PC3, size=10 ,color = as.factor(new_pc_mtb$Clus), colors = c("black", "lightblue2", "gold2","firebrick2"))


pca_clusters_all=merge(clusters,cmp_log2, by="row.names")
pca_clusters_all=pca_clusters_all[,c(1:11,217,218)]
pca_clusters_all2=melt(pca_clusters_all, id.vars=c("Row.names", "PC1", "PC2"))
ggplot (pca_clusters_all2, aes(PC1,PC2, color=as.factor(value)))+ geom_point() + theme_bw() + facet_grid(variable~.)

#plot_ly(x=new_pc_mtb$PC2,y=new_pc_mtb$PC3,z=new_pc_mtb$PC4, size=10 ,color = as.factor(new_pc_mtb$Clus), colors = c("black","firebrick2", "lightblue2", "gold2"))


####################
#Play with heatmaps#
####################


new_pc_mtb2=new_pc_mtb[,c("Row.names","Clus","ibd_Diagnosis","ibd_DiseaseLocation", "ibd_ActiveDisease","clinical_BowelMovementADayDef", "Shannon_Index")]
rownames(new_pc_mtb2)=new_pc_mtb2$Row.names
new_pc_mtb2$Row.names=NULL
new_pc_mtb2$cluster=paste("c", new_pc_mtb2$Clus,sep="_")
new_pc_mtb2$Clus=NULL

new_pc_mtb2=new_pc_mtb2[order (new_pc_mtb2$cluster),]
new_clus_mtb2=clus_mtb[(row.names(new_pc_mtb2)),]
new_clus_mtb3=new_clus_mtb2[ ,colnames(new_clus_mtb2) %in% sigfeatures[[1]] ]


new_clus_tx2=clus_taxa[(row.names(new_pc_mtb2)),]
pheatmap(t(new_clus_tx2), cluster_cols = F, cluster_rows = T,show_rownames = T,breaks = seq(-10,10,length.out=10), gaps_col= c(head(as.numeric(cumsum(table(new_pc_mtb2$cluster)))), -1),show_colnames = F, annotation_col = new_pc_mtb2, scale = "none", color = inferno(10),fontsize = 5, annotation_colors = list ( ibd_Diagnosis=c("CD"="firebrick2", "UC"="blue2", "Control"="white", "IBDU"="black"),cluster=c("c_A"="black","c_B"="firebrick2","c_C"="lightblue2","c_D"="gold2" ), ibd_ActiveDisease=c("Control"="white", "Active"="red3", "NotActive"="lightblue1"), ibd_DiseaseLocation=c("Control"="white","colon"="green","ileum"="darkred","both"="gold3")))

pheatmap(t(new_clus_mtb3), cluster_cols = F, cluster_rows = T,show_rownames = T,breaks = seq(-3,3,length.out=10), gaps_col= c(head(as.numeric(cumsum(table(new_pc_mtb2$cluster)))), -1),show_colnames = F, annotation_col = new_pc_mtb2, scale = "none", color = inferno(10),fontsize = 5, annotation_colors = list ( ibd_Diagnosis=c("CD"="firebrick2", "UC"="blue2", "Control"="white", "IBDU"="black"),cluster=c("c_A"="black","c_B"="firebrick2","c_C"="lightblue2","c_D"="gold2" ), ibd_ActiveDisease=c("Control"="white", "Active"="red3", "NotActive"="lightblue1"), ibd_DiseaseLocation=c("Control"="white","colon"="green","ileum"="darkred","both"="gold3")))

```


6a: Compare metabolomics clusters
===

```{r}
#Summary stats metabolite per cluster
clus_sel=as.data.frame(clus_sel)
clus_sel$Clus=as.factor(clus_sel$Clus)
all_raw_stats=merge(SCFA2, all_new_ID_raw, by="row.names")
row.names(all_raw_stats)=all_raw_stats$Row.names
all_raw_stats$Row.names=NULL
clus_stats_mtb=summary_stats(all_raw_stats, clus_sel, missing_vals = "1")


#Summary stats bug per cluster
taxa3=subset(taxa,rownames(taxa) %in% rownames(cc_pheno2))
taxa3[taxa3=="NA"]=0
taxa3[taxa3=="NaN"]=0

taxa3=taxa3[,((colSums(taxa3 !=0) / nrow(taxa3)) *100 )>20]
taxa3[taxa3==0]=NA


clus_stats_taxa=summary_stats(taxa3,clus_sel,missing_vals = "1")



##################
####METABOLITES###
##################


cm=merge(clus_sel,clus_mtb, by="row.names")
rownames(cm)=cm$Row.names
SCFA2$Amount_sample_gram=NULL
SCFA2$Box=NULL
cm=merge(cm,SCFA2,by="row.names")
cm$Row.names=NULL
flag=1
for (a in 3:ncol(cm)){
  my_name=colnames(cm)[a]
  yy= pairwise.wilcox.test(cm[,a],cm$Clus, p.adjust.method = "none")$p.value
  cc=data.frame("Feature"=my_name,"CA_CB"=yy[1,1], "CA_CC"=yy[2,1],"CA_CD"=yy[3,1],"CB_CC"=yy[2,2], "CB_CD"=yy[3,2],"CC_CD"=yy[3,3] )
  if(flag==1){
    clus_res_mtb=cc
    flag=5
  }else{
    clus_res_mtb=rbind(clus_res_mtb,cc)
  }
}

m_clus_res_mtb=melt(clus_res_mtb)
m_clus_res_mtb$FDR=p.adjust(m_clus_res_mtb$value, method = "BH")
m_clus_res_mtb=dcast(m_clus_res_mtb, formula=Feature~variable, value.var="FDR")
a_report_mtb=merge(clus_stats_mtb,m_clus_res_mtb, by.x="Metabolite", by.y="Feature")

write.table(a_report_mtb, "~/Desktop/Metabolomics_v2/3.Preliminary_results/Cluster_enriched_metabolites.txt", quote = F, sep = "\t")

##################
#### TAXA ########
##################


ct=merge(clus_sel,clus_taxa, by="row.names")

flag=1
for (a in 3:ncol(ct)){
  my_name=colnames(ct)[a]
  yy= pairwise.wilcox.test(ct[,a],ct$Clus, p.adjust.method = "none")$p.value
  cct=data.frame("Feature"=my_name,"CA_CB"=yy[1,1], "CA_CC"=yy[2,1],"CA_CD"=yy[3,1],"CB_CC"=yy[2,2], "CB_CD"=yy[3,2],"CC_CD"=yy[3,3] )
  if(flag==1){
    clus_res_taxa=cct
    flag=5
  }else{
    clus_res_taxa=rbind(clus_res_taxa,cct)
  }
}


m_clus_res_taxa=melt(clus_res_taxa)
m_clus_res_taxa$FDR=p.adjust(m_clus_res_taxa$value, method = "BH")
m_clus_res_taxa=dcast(m_clus_res_taxa, formula=Feature~variable, value.var="FDR")
a_report_taxa=merge(clus_stats_taxa,m_clus_res_taxa, by.x="Metabolite", by.y="Feature")


write.table(a_report_taxa, "~/Desktop/Metabolomics_v2/3.Preliminary_results/Cluster_enriched_taxa.txt", quote = F, sep = "\t")


##################
####PHENOTYPES####
##################
library("lsmeans")

phenos_ibdcc=read.table("~/Desktop/Metabolomics_v2/1.Raw_data_Metabolon/phenos_IBD_cc.txt", sep = "\t", row.names = 1, header = T)

#colnames(clus_sel)="Clusters"
cp=merge(clus_sel,phenos_ibdcc, by="row.names")

flag=1
for (a in 3:ncol(cp)){
  my_name=colnames(cp)[a]
  if (is.numeric(cp[,a])){
    yy= pairwise.wilcox.test(cp[,a],cp$Clus, p.adjust.method = "none")$p.value
    ccb=data.frame("Feature"=my_name,"CA_CB"=yy[1,1], "CA_CC"=yy[2,1],"CA_CD"=yy[3,1],"CB_CC"=yy[2,2], "CB_CD"=yy[3,2],"CC_CD"=yy[3,3] )
    if(flag==1){
      clus_res_phe=ccb
      flag=5
    }else{
      clus_res_phe=rbind(clus_res_phe,ccb)
    }
  } else {
    tmpdf=cp[,c(2,a)]
    zzz=glm(tmpdf[,2] ~ Clus, family = binomial(), data = tmpdf)
    yyy=as.data.frame(pairs(regrid(lsmeans(zzz,"Clus"), p.adjust.methods="none")))
    ccb=data.frame("Feature"=my_name,"CA_CB"=yyy[1,6], "CA_CC"=yyy[2,6],"CA_CD"=yyy[3,6],"CB_CC"=yyy[4,6], "CB_CD"=yyy[5,6],"CC_CD"=yyy[6,6] )
    if(flag==1){
      clus_res_phe=ccb
      flag=5
    }else{
      clus_res_phe=rbind(clus_res_phe,ccb)
    }
  }
}

m_clus_res_phe=melt(clus_res_phe)
m_clus_res_phe$FDR=p.adjust(m_clus_res_phe$value, method = "BH")
m_clus_res_phe=dcast(m_clus_res_phe, formula=Feature~variable, value.var="FDR")
row.names(cp)=cp$Row.names
cp$Row.names=NULL
stats_phenos_clus=describe.by(cp, cp$Clus)
stats_phenos=data.frame("Phenotype"=colnames(cp), CA_N= stats_phenos_clus$A$n, CA_Min=stats_phenos_clus$A$min, CA_Max=stats_phenos_clus$A$max, CA_Mean=stats_phenos_clus$A$mean, CA_Median=stats_phenos_clus$A$median, CA_SD=stats_phenos_clus$A$sd,CB_N= stats_phenos_clus$B$n, CB_Min=stats_phenos_clus$B$min, CB_Max=stats_phenos_clus$B$max, CB_Mean=stats_phenos_clus$B$mean, CB_Median=stats_phenos_clus$B$median, CB_SD=stats_phenos_clus$B$sd , CC_N= stats_phenos_clus$C$n, CC_Min=stats_phenos_clus$C$min, CC_Max=stats_phenos_clus$C$max, CC_Mean=stats_phenos_clus$C$mean, CC_Median=stats_phenos_clus$C$median, CC_SD=stats_phenos_clus$C$sd, CD_N= stats_phenos_clus$D$n, CD_Min=stats_phenos_clus$D$min, CD_Max=stats_phenos_clus$D$max, CD_Mean=stats_phenos_clus$D$mean, CD_Median=stats_phenos_clus$D$median, CD_SD=stats_phenos_clus$D$sd)

a_report_phe=merge(stats_phenos,m_clus_res_phe, by.x="Phenotype", by.y="Feature")

write.table(a_report_phe,"~/Desktop/Metabolomics_v2/3.Preliminary_results/Cluster_enriched_pheno.txt", quote = F, sep = "\t")


ggplot(cm, aes(as.factor(Clus),butyric_acid, fill=as.factor(cm$Clus))) + geom_violin(alpha=0.8) + geom_jitter(height = 0, width = 0.1, alpha=0.4) + geom_boxplot(width=0.1, fill="white") + theme_bw() + xlab("Clusters")  + scale_fill_manual(values =c("gray80","steelblue2","gold3","firebrick3" ))

ggplot(cm, aes(as.factor(Clus),tryptophan, fill=as.factor(Clus))) + geom_violin(alpha=0.8) + geom_jitter(height = 0, width = 0.1, alpha=0.4) + geom_boxplot(width=0.1, fill="white") + theme_bw() + xlab("Clusters")  + scale_fill_manual(values =c("gray80","steelblue2","gold3","firebrick3" ))


ggplot(ct, aes(as.factor(Clus),Bacteroides_fragilis, fill=as.factor(Clus))) + geom_violin() + geom_jitter(height = 0, width = 0.1, alpha=0.4) + theme_bw() + xlab("Clusters")  + scale_fill_manual(values =c("gray80","steelblue2","gold3","firebrick3" ))


ggplot(cm, aes(as.factor(cm$Clus),tryptophan, fill=as.factor(cm$Clus))) + geom_violin() + geom_jitter(height = 0, width = 0.1, alpha=0.4) + theme_bw() + xlab("Clusters")  + scale_fill_manual(values =c("gray80","steelblue2","gold3","firebrick3" ))


cm2=cm
rownames(cm2)=cm2$Row.names
cm2=merge(cc_ibd,cm2,by="row.names")
ggplot(cm2, aes(as.factor(Clus),butyric_acid, fill=as.factor(Clus))) + geom_violin(alpha=0.8) + geom_jitter(aes(shape=ibd_Diagnosis),height = 0, width = 0.1, alpha=0.4) + geom_boxplot(width=0.1, fill="white") + theme_bw() + xlab("Clusters")  + scale_fill_manual(values =c("gray80","steelblue2","gold3","firebrick3" ))

ggplot(cm2, aes(as.factor(Clus),tryptophan, fill=as.factor(Clus))) + geom_violin(alpha=0.8) + geom_jitter(aes(shape=ibd_Diagnosis),height = 0, width = 0.1, alpha=0.4) + geom_boxplot(width=0.1, fill="white") + theme_bw() + xlab("Clusters")  + scale_fill_manual(values =c("gray80","steelblue2","gold3","firebrick3" ))

ct2=ct
rownames(ct2)=ct2$Row.names
ct2=merge(cc_ibd,ct2,by="row.names")
ggplot(ct2, aes(as.factor(Clus),Blautia_wexlerae, fill=as.factor(Clus))) + geom_violin(alpha=0.8) + geom_jitter(aes(shape=ibd_Diagnosis),height = 0, width = 0.1, alpha=0.4) + geom_boxplot(width=0.1, fill="white") + theme_bw() + xlab("Clusters")  + scale_fill_manual(values =c("gray80","steelblue2","gold3","firebrick3" ))


cp2=cp
#rownames(cp2)=cp2$Row.names
cp2=merge(cc_ibd,cp2,by="row.names")
ggplot(cp2, aes(as.factor(Clus),log10(ChrA), fill=as.factor(Clus))) + geom_violin(alpha=0.8) + geom_jitter(aes(shape=ibd_Diagnosis.x),height = 0, width = 0.1, alpha=0.4) + geom_boxplot(width=0.1, fill="white") + theme_bw() + xlab("Clusters")  + scale_fill_manual(values =c("gray80","steelblue2","gold3","firebrick3" ))



```




7. Evaluating the effect of technical factors and host age, sex, BMI, Bowel movements per day
===

```{r, message=F, warning=F}

rownames(cc_pheno5)=cc_pheno5$Row.names
cc_pheno5$Row.names=NULL
cc_pheno6=cc_pheno5
table(cc_pheno6$run_day_cat, cc_pheno6$COMMENT)
cc_pheno6=subset(cc_pheno6,select = -c(Preparation_batch,Preparation_day,Preparation_order,CLIENT.IDENTIFIER,Box,Preparation_day_cat, RUN.DAY,SPL_AMNT_GRAM))

#Correction factors: day measurment was done, LC column, ammount sample per gram, month sample in a freezer, sex and age. 
my_correction_factors=cc_pheno6[,c("run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer","host_Sex","host_Age_sampling", "host_BMI", "clinical_BowelMovementADayDef")]
my_correction_factors_test=merge(my_correction_factors,q_mtb,by="row.names")
rownames(my_correction_factors_test)=my_correction_factors_test$Row.names
my_correction_factors_test$Row.names=NULL

#Box and day are correlated (i.e Box1 was analyzed between day 1 and 3, box10 only on day21)
#Therefore I will only use day for correction
#table(my_correction_factors_test$run_day_cat, test_mtb_quantitative$COMMENT)

my_corr_factors_results=matrix(ncol = 5, nrow = 6382)
b=1
for ( a in 1:ncol(my_correction_factors)){
  for (x in (ncol(my_correction_factors)+1):ncol(my_correction_factors_test)){
    if(is.numeric(my_correction_factors[,a])){
      my_corr_factors_results[b,1]=colnames(my_correction_factors_test)[a]
      my_corr_factors_results[b,2]=colnames(my_correction_factors_test)[x]
      my_test=cor.test(my_correction_factors_test[,a],my_correction_factors_test[,x], method = "spearman")
      my_corr_factors_results[b,3]=my_test$estimate
      my_corr_factors_results[b,4]=my_test$p.value
      my_corr_factors_results[b,5]="spearman"
      b=b+1
    } else{
      my_corr_factors_results[b,1]=colnames(my_correction_factors_test)[a]
      my_corr_factors_results[b,2]=colnames(my_correction_factors_test)[x]
      my_test=kruskal.test(my_correction_factors_test[,x]~my_correction_factors_test[,a])
      my_corr_factors_results[b,3]=my_test$statistic
      my_corr_factors_results[b,4]=my_test$p.value
      my_corr_factors_results[b,5]="krustal"
      b=b+1
    }
  }
}

my_corr_factors_results=as.data.frame(my_corr_factors_results)
colnames(my_corr_factors_results)=c("Factor", "Metabolite","Estimate","p.value", "test")
my_corr_factors_results$p.value=as.numeric(as.character(my_corr_factors_results$p.value))
my_corr_factors_results$FDR=p.adjust(my_corr_factors_results$p.value,method = "fdr")
my_corr_factors_results$Bonferroni=p.adjust(my_corr_factors_results$p.value,method = "bonferroni")

x=as.data.frame(table(my_corr_factors_results$Factor[my_corr_factors_results$Bonferroni<0.05]))
y=as.data.frame(table(my_corr_factors_results$Factor[my_corr_factors_results$FDR<0.05]))
associations_factors=as.data.frame(cbind(x,y))
associations_factors[,3]=NULL
colnames(associations_factors)=c("Name","Bonferroni","FDR")
plot_asso=melt(associations_factors)


write.table(my_corr_factors_results, "~/Desktop/Metabolomics_v2/3.Preliminary_results/technical_confouders_quantitative.txt", sep = "\t", quote = F)

ggplot(plot_asso,aes(Name,value, fill=variable)) + geom_bar(stat="identity", position =position_dodge(), colour="black") + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + xlab("") +ylab ("Number of associations")+ scale_x_discrete(labels=c("Amount_sample_gram" = "Amount_input_sample","clinical_BowelMovementADayDef" ="Bowel Movements", "run_day_cat" = "Run day","host_Age_sampling" = "Age", "host_Sex"="Sex", "LC.COLUMN"="LC-Column","metabolon_Month_in_freezer"="storage_time", "host_BMI"="BMI"))

test_plot=merge(cc_pheno6,q_mtb,by="row.names")
ggplot(test_plot, aes(run_day_cat,alpha_ketoglutarate)) + geom_violin(fill="gray88") + geom_jitter(aes(color=ibd_Diagnosis), position=position_jitter(0.2))+ theme_bw() + scale_color_manual(values = c("firebrick2", "black", "gray88","blue2")) 


my_correction_factors_test_bi=merge(my_correction_factors,bi_mtb,by="row.names")
rownames(my_correction_factors_test_bi)=my_correction_factors_test_bi$Row.names
my_correction_factors_test_bi$Row.names=NULL
colnames(my_correction_factors_test_bi)=make.names(colnames(my_correction_factors_test_bi))

my_corr_factors_results_bi=matrix(ncol = 5, nrow = 4112)
b=1
for ( a in 1:ncol(my_correction_factors)){
  for (x in (ncol(my_correction_factors)+1):ncol(my_correction_factors_test_bi)){
    if(is.numeric(my_correction_factors[,a])){
      my_corr_factors_results_bi[b,1]=colnames(my_correction_factors_test_bi)[a]
      my_corr_factors_results_bi[b,2]=colnames(my_correction_factors_test_bi)[x]
      my_frm=as.formula(paste(colnames(my_correction_factors_test_bi)[x], "~ ", colnames(my_correction_factors_test_bi)[a]))
      my_test=summary(glm(my_frm, family = binomial(link="logit"), data =my_correction_factors_test_bi))
      my_corr_factors_results_bi[b,3]=my_test$coefficients[2,1]
      my_corr_factors_results_bi[b,4]=my_test$coefficients[2,4]
      my_corr_factors_results_bi[b,5]="logit"
      b=b+1
    } else{
      my_corr_factors_results_bi[b,1]=colnames(my_correction_factors_test_bi)[a]
      my_corr_factors_results_bi[b,2]=colnames(my_correction_factors_test_bi)[x]
      my_test=chisq.test(my_correction_factors_test_bi[,x],my_correction_factors_test_bi[,a])
      my_corr_factors_results_bi[b,3]=my_test$statistic
      my_corr_factors_results_bi[b,4]=my_test$p.value
      my_corr_factors_results_bi[b,5]="chisq"
      b=b+1
    }
  }
}


my_corr_factors_results_bi=as.data.frame(my_corr_factors_results_bi)
colnames(my_corr_factors_results_bi)=c("Factor", "Metabolite","Estimate","p.value")
my_corr_factors_results_bi$p.value=as.numeric(as.character(my_corr_factors_results_bi$p.value))
my_corr_factors_results_bi$FDR=p.adjust(my_corr_factors_results_bi$p.value,method = "fdr")
my_corr_factors_results_bi$Bonferroni=p.adjust(my_corr_factors_results_bi$p.value,method = "bonferroni")


write.table(my_corr_factors_results_bi, "~/Desktop/Metabolomics_v2/3.Preliminary_results/technical_confouders_metabolites_prevalence.txt", sep = "\t", quote = F)

x=as.data.frame(table(my_corr_factors_results_bi$Factor[my_corr_factors_results_bi$Bonferroni<0.05]))
y=as.data.frame(table(my_corr_factors_results_bi$Factor[my_corr_factors_results_bi$FDR<0.05]))
association_corr_bi=as.data.frame(cbind(x,y))
association_corr_bi[,3]=NULL
colnames(association_corr_bi)=c("Name","Bonferroni","FDR")
plot_asso_bi=melt(association_corr_bi)

ggplot(plot_asso_bi,aes(Name,value, fill=variable)) + geom_bar(stat="identity", position =position_dodge(), colour="black") + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + xlab("") +ylab ("Number of associations")+ scale_x_discrete(labels=c("Amount_sample_gram" = "Amount_input_sample", "COMMENT" = "Box","host_Age_sampling" = "Age", "host_Sex"="Sex", "LC.COLUMN"="LC-Column","metabolon_Month_in_freezer"="storage_time"))

```


8. Association analyses with covariates
===

Testing each metabolite~phenotype association using the several techinicals and host charactersitic covariates( age, sex, BMI, bowel movements a day,day measuring (run day), amount of sample, month sample in a freezer). 

3 different tests: 

a) Case-control to assess IBD associated metabolites
b) Quantitative metabolites (>70%) association analysis between phenotype & metabolite in IBD & Controls separate
c) Presence/absence metabolites (>20 MTB <70%) association analysis between phenotype & metabolite in IBD & Controls separate 


8a. Metabolites associated to IBD
---

```{r}

#TEST QUANTITATIVE METABOLITES >70%

test_mtb_quantitative=merge(cc_pheno6,q_mtb,by="row.names")
test_mtb_quantitative=as.data.frame(lapply(test_mtb_quantitative, gsub, pattern="Control", replacement="A_Control", fixed=T))
rownames(test_mtb_quantitative)=test_mtb_quantitative$Row.names
test_mtb_quantitative$Row.names=NULL
test_mtb_quantitative$ibd_FecalCalprotectin=NULL
test_mtb_quantitative$COMMENT=NULL

#write.table(test_mtb_quantitative,"~/Desktop/Metabolomics_v2/2.Input/cc.txt",sep="\t", quote = F, row.names = T)
#my_correction_factors=cc_pheno6[,c("run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer","host_Sex","host_Age_sampling", "host_BMI", "clinical_BowelMovementADayDef")]

case_control_quantitative=read.table("~/Desktop/Metabolomics_v2/2.Input/case_control_input.txt",sep="\t", header = T, row.names = 1)
case_control_quantitative$Shannon_Index=NULL
flag=1
for ( i in 1:13) {
  my_pheno=colnames(case_control_quantitative)[i]
  if (my_pheno=="clinical_BowelMovementADayDef" | my_pheno=="LC.COLUMN" | my_pheno=="host_BMI"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 14:ncol(case_control_quantitative)){
      my_trait=colnames(case_control_quantitative)[a]
      my_uni_test=case_control_quantitative[,c("host_Sex","host_Age","clinical_BowelMovementADayDef","host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age","clinical_BowelMovementADayDef", "host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      #my_uni_test[,8]=as.numeric(as.character(my_uni_test[,8]))
      my_samples=nrow(my_uni_test)
      my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
          my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
          my_univariate_results=my_lm_pheno
          flag=5
      }
    }
  }
}

associations_ibd=my_univariate_results
associations_ibd$FDR=p.adjust(associations_ibd$`Pr(>|t|)`,method = "BH")
associations_ibd$Bonferroni=p.adjust(associations_ibd$`Pr(>|t|)`,method = "bonferroni")
write.table(associations_ibd, "~/Desktop/Metabolomics_v2/3.Preliminary_results/IBD_associations_quantitative.txt", sep = "\t", quote = F)


# TEST PREVALENCE <20% MTB <70%
# LOGISTIC REGRESSION #

test_mtb_presence=merge(cc_pheno6,bi_mtb,by="row.names")
rownames(test_mtb_presence)=test_mtb_presence$Row.names
test_mtb_presence$Row.names=NULL
test_mtb_presence$ibd_FecalCalprotectin=NULL
test_mtb_presence$COMMENT=NULL

#write.table(test_mtb_presence,"~/Desktop/Metabolomics_for_cluster/2.Input/cc_v4_prev.txt",sep="\t", quote = F, row.names = T)
case_control_prevalence=read.table("~/Desktop/Metabolomics_v2/2.Input/case_control_input_prevalence.txt",sep="\t", header = T, row.names = 1)


flag=1
for ( i in 1:14) {
  my_pheno=colnames(case_control_prevalence)[i]
  if (my_pheno=="run_day_cat" | my_pheno=="clinical_BowelMovementADayDef" | my_pheno=="LC.COLUMN"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age" | my_pheno=="host_BMI") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 15:ncol(case_control_prevalence)){
      my_trait=colnames(case_control_prevalence)[a]
      my_uni_test=case_control_prevalence[,c("host_Sex","host_Age","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer","clinical_BowelMovementADayDef", "host_BMI",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age","host_BMI", "run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer","clinical_BowelMovementADayDef",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      my_uni_test[,10]=as.numeric(as.character(my_uni_test[,10]))
      my_samples=nrow(my_uni_test)
      #my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm=summary(glm(my_f, family = binomial(link="logit"), data =my_uni_test))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
          my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
          my_univariate_results=my_lm_pheno
          flag=5
      }
    }
  }
}

prev_univariate_ibd=my_univariate_results
prev_univariate_ibd$FDR=p.adjust(prev_univariate_ibd$`Pr(>|z|)`,method = "BH")
prev_univariate_ibd$Bonferroni=p.adjust(prev_univariate_ibd$`Pr(>|z|)`,method = "bonferroni")
write.table(prev_univariate_ibd, "~/Desktop/Metabolomics_v2/3.Preliminary_results/3.Regressions/IBD_associations_prevalence.txt", sep = "\t", quote = F)




#TEST QUANTITATIVE METABOLITES >20% MTB <70% => non-NAs
q_mtb_t_v3=q_mtb_t_v2[,colnames(q_mtb_t_v2) %in% colnames(bi_mtb)]
test_mtb_quantitative2=merge(cc_pheno6,q_mtb_t_v3,by="row.names")
test_mtb_quantitative2=as.data.frame(lapply(test_mtb_quantitative2, gsub, pattern="Control", replacement="A_Control", fixed=T))
rownames(test_mtb_quantitative2)=test_mtb_quantitative2$Row.names
test_mtb_quantitative2$Row.names=NULL
test_mtb_quantitative2$ibd_FecalCalprotectin=NULL
test_mtb_quantitative2$COMMENT=NULL

#write.table(test_mtb_quantitative2,"~/Desktop/Metabolomics_for_cluster/2.Input/cc_v4_prev2.txt",sep="\t", quote = F, row.names = T)


case_control_quantitative2=read.table("~/Desktop/Metabolomics_v2/2.Input/case_control_input_prevalence_quantitative.txt",sep="\t", header = T, row.names = 1)
case_control_quantitative2$Shannon_Index=NULL
case_control_quantitative2$clinical_Strict_IBS=NULL
flag=1
for ( i in 1:12) {
  my_pheno=colnames(case_control_quantitative2)[i]
  if (my_pheno=="clinical_BowelMovementADayDef" | my_pheno=="LC.COLUMN" | my_pheno=="host_BMI"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 13:ncol(case_control_quantitative2)){
      my_trait=colnames(case_control_quantitative2)[a]
      my_uni_test=case_control_quantitative2[,c("host_Sex","host_Age","clinical_BowelMovementADayDef","host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age","clinical_BowelMovementADayDef", "host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      my_uni_test=my_uni_test[complete.cases(my_uni_test[,9]),]
      my_uni_test[,10]=as.numeric(as.character(my_uni_test[,9]))
      my_samples=nrow(my_uni_test)
      my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
          my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
          my_univariate_results=my_lm_pheno
          flag=5
      }
    }
  }
}

associations_ibd2=my_univariate_results
associations_ibd2$FDR=p.adjust(associations_ibd2$`Pr(>|t|)`,method = "BH")
associations_ibd2$Bonferroni=p.adjust(associations_ibd2$`Pr(>|t|)`,method = "bonferroni")
write.table(associations_ibd2, "~/Desktop/Metabolomics_v2/3.Preliminary_results/3.Regressions/IBD_associations_low_prevalent_quantitative.txt", sep = "\t", quote = F)
```





8b. Quantitative metabolites vs phenotypes
----


Within controls


```{r}

controls_phenos=read.table("~/Desktop/Metabolomics_v2/2.Input/Controls_phenos.txt", sep = "\t", header = T, row.names = 1)


controls_phenos$ibd_Diagnosis=NULL
controls_phenos$ibd_FecalCalprotectinOver200yesno.1=NULL
controls_phenos$run_day_cat=NULL
controls_phenos$run_day_cat.1=NULL
controls_phenos$LC.COLUMN.1=NULL
controls_phenos$Amount_sample_gram.1=NULL
controls_phenos$clinical_BowelMovementADayDef.1=NULL
controls_phenos$clinical_Strict_IBS.1=NULL
controls_phenos$metabolon_Month_in_freezer.1=NULL
controls_phenos$host_Age.1=NULL
controls_phenos$host_BMI.1=NULL
controls_phenos$host_Sex.1=NULL
controls_phenos$metabolon_Month_in_freezer.1=NULL
controls_phenos$BioMK_Calprotectin=NULL
controls_phenos$med_anti_epileptics=NULL
controls_phenos$med_insulin=NULL
controls_phenos$med_opiat=NULL
controls_phenos$med_oral_anti_diabetics=NULL
controls_phenos$med_other_antidepressant=NULL

flag=1
for ( i in 1:355) {
  my_pheno=colnames(controls_phenos)[i]
  if (my_pheno=="clinical_BowelMovementADayDef" | my_pheno=="LC.COLUMN" | my_pheno=="host_BMI"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 356:ncol(controls_phenos)){
      my_trait=colnames(controls_phenos)[a]
      my_uni_test=controls_phenos[,c("host_Sex","host_Age","clinical_BowelMovementADayDef","host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age","clinical_BowelMovementADayDef", "host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      #my_uni_test[,8]=as.numeric(as.character(my_uni_test[,8]))
      my_samples=nrow(my_uni_test)
      my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
          my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
          my_univariate_results=my_lm_pheno
          flag=5
      }
    }
  }
}

associations_controls=my_univariate_results
associations_controls$FDR=p.adjust(associations_controls$`Pr(>|t|)`,method = "BH")
associations_controls$Bonferroni=p.adjust(associations_controls$`Pr(>|t|)`,method = "bonferroni")

write.table(associations_controls, "~/Desktop/Metabolomics_v2/3.Preliminary_results/3.Regressions/Controls_associations_quantitative.txt", sep = "\t", quote = F)


##TEST PREVALENCE ###


controls_phenos_prev=read.table("~/Desktop/Metabolomics_v2/2.Input/Controls_phenos_prevalence.txt", sep = "\t", header = T, row.names = 1)


controls_phenos_prev$ibd_Diagnosis=NULL
controls_phenos_prev$ibd_FecalCalprotectinOver200yesno.1=NULL
#controls_phenos$run_day_cat=NULL
controls_phenos_prev$run_day_cat.1=NULL
controls_phenos_prev$LC.COLUMN.1=NULL
controls_phenos_prev$Amount_sample_gram.1=NULL
controls_phenos_prev$clinical_BowelMovementADayDef.1=NULL
controls_phenos_prev$clinical_Strict_IBS.1=NULL
controls_phenos_prev$metabolon_Month_in_freezer.1=NULL
controls_phenos_prev$host_Age.1=NULL
controls_phenos_prev$host_BMI.1=NULL
controls_phenos_prev$host_Sex.1=NULL
controls_phenos_prev$metabolon_Month_in_freezer.1=NULL
controls_phenos_prev$BioMK_Calprotectin=NULL
controls_phenos_prev$med_anti_epileptics=NULL
controls_phenos_prev$med_insulin=NULL
controls_phenos_prev$med_opiat=NULL
controls_phenos_prev$med_oral_anti_diabetics=NULL
controls_phenos_prev$med_other_antidepressant=NULL


flag=1
for ( i in 1:356) {
  my_pheno=colnames(controls_phenos_prev)[i]
  if (my_pheno=="run_day_cat" | my_pheno=="clinical_BowelMovementADayDef" | my_pheno=="LC.COLUMN"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age" | my_pheno=="host_BMI") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 357:ncol(controls_phenos_prev)){
      my_trait=colnames(controls_phenos_prev)[a]
      my_uni_test=controls_phenos_prev[,c("host_Sex","host_Age","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer","clinical_BowelMovementADayDef", "host_BMI",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age","host_BMI", "run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer","clinical_BowelMovementADayDef",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      my_uni_test[,10]=as.numeric(as.character(my_uni_test[,10]))
      my_samples=nrow(my_uni_test)
      #my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm=summary(glm(my_f, family = binomial(link="logit"), data =my_uni_test))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
          my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
          my_univariate_results=my_lm_pheno
          flag=5
      }
    }
  }
}

#mtb=controls_phenos_prev[,357:ncol(controls_phenos_prev)]
#my_remove=remove=mtb[,colSums(mtb)<nrow(mtb)*0.2]
my_univariate_results2=subset(my_univariate_results, my_univariate_results$metabolite%ni%colnames(my_remove))
prev_univariate_control=my_univariate_results2
prev_univariate_control=prev_univariate_control[prev_univariate_control$phenotype!="Shannon_Index.1",]
prev_univariate_control$FDR=p.adjust(prev_univariate_control$`Pr(>|z|)`,method = "BH")
prev_univariate_control$Bonferroni=p.adjust(prev_univariate_control$`Pr(>|z|)`,method = "bonferroni")
write.table(prev_univariate_control, "~/Desktop/Metabolomics_for_cluster/3.Preliminary_results_v2/Controls_associations_prevalence.txt", sep = "\t", quote = F)


```


Within IBD

```{r}

ibd_test_phenos=read.table("~/Desktop/Metabolomics_v2/2.Input/IBD_phenos.txt", sep = "\t", header = T, row.names = 1)

ibd_test_phenos$clinical_CurrentStomaOrPouch=NULL
ibd_test_phenos$ibd_FecalCalprotectinOver200yesno.x=NULL
ibd_test_phenos$host_Sex.1=NULL
ibd_test_phenos$med_beta_sympathomimetic_inhaler=NULL
ibd_test_phenos$med_parasympathicolytic_inhaler=NULL

flag=1
for ( i in 1:344) {
  my_pheno=colnames(ibd_test_phenos)[i]
  if (my_pheno=="clinical_BowelMovementADayDef" | my_pheno=="LC.COLUMN" | my_pheno=="host_BMI"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 345:ncol(ibd_test_phenos)){
      my_trait=colnames(ibd_test_phenos)[a]
      my_uni_test=ibd_test_phenos[,c("host_Sex","host_Age","clinical_BowelMovementADayDef","host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age","clinical_BowelMovementADayDef", "host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      #my_uni_test[,8]=as.numeric(as.character(my_uni_test[,8]))
      my_samples=nrow(my_uni_test)
      my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
          my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
          my_univariate_results=my_lm_pheno
          flag=5
      }
    }
  }
}

associations_wIBD=my_univariate_results
#associations_controls=subset(associations_controls, associations_controls$phenotype!="BioMK_ChromograninA")
associations_wIBD$FDR=p.adjust(associations_wIBD$`Pr(>|t|)`,method = "BH")
associations_wIBD$Bonferroni=p.adjust(associations_wIBD$`Pr(>|t|)`,method = "bonferroni")

write.table(associations_wIBD, "~/Desktop/Metabolomics_for_cluster/3.Preliminary_results_v2/within_IBD_associations_quantitative_corrected_location.txt", sep = "\t", quote = F)


##TEST PREVALENCE ###


ibd_test_phenos2=read.table("~/Desktop/Metabolomics_for_cluster/2.Input/intermed/ibd_phenos_prev.txt", sep = "\t", header = T, row.names = 1)

ibd_test_phenos2$ibd_CurrentStomaOrPouch=NULL
ibd_test_phenos2$ibd_FecalCalprotectinOver200yesno.x=NULL
ibd_test_phenos2$host_Sex.1=NULL
ibd_test_phenos2$med_beta_sympathomimetic_inhaler=NULL
ibd_test_phenos2$med_parasympathicolytic_inhaler=NULL

flag=1
for ( i in 1:344) {
  my_pheno=colnames(ibd_test_phenos2)[i]
  if (my_pheno=="run_day_cat" | my_pheno=="clinical_BowelMovementADayDef" | my_pheno=="LC.COLUMN"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age" | my_pheno=="host_BMI") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 345:ncol(ibd_test_phenos2)){
      my_trait=colnames(ibd_test_phenos2)[a]
      my_uni_test=ibd_test_phenos2[,c("host_Sex","host_Age","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer","clinical_BowelMovementADayDef", "host_BMI",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age","host_BMI", "run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer","clinical_BowelMovementADayDef",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      my_uni_test[,10]=as.numeric(as.character(my_uni_test[,10]))
      my_samples=nrow(my_uni_test)
      #my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm=summary(glm(my_f, family = binomial(link="logit"), data =my_uni_test))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
        my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
        my_univariate_results=my_lm_pheno
        flag=5
      }
    }
  }
}

prev_univariate_control=my_univariate_results
prev_univariate_control=prev_univariate_control[prev_univariate_control$phenotype!="Shannon_Index.1",]
prev_univariate_control$FDR=p.adjust(prev_univariate_control$`Pr(>|z|)`,method = "BH")
prev_univariate_control$Bonferroni=p.adjust(prev_univariate_control$`Pr(>|z|)`,method = "bonferroni")
write.table(prev_univariate_control, "~/Desktop/Metabolomics_for_cluster/3.Preliminary_results_v2/Controls_associations_prevalence.txt", sep = "\t", quote = F)


```


9. Explore rare metabolites
===

```{r}


#Relation to drugs

t_rare=merge(cc_pheno3,rare_mtb_coded,by="row.names")
t_rare=t_rare[,c(1,16:59,316:ncol(t_rare))]
m_res=matrix(nrow=14175,ncol = 4)
v=1
for (i in 2:46){
  for (a in 47:ncol(t_rare)){
    m_res[v,1]=colnames(t_rare)[i]
    m_res[v,2]=colnames(t_rare)[a]
    m_res[v,3]=sum(t_rare[,a] !=0)
    if(m_res[v,3]>3){
      m_res[v,4]=chisq.test(t_rare[,i],as.factor(t_rare[,a]))$p.value
      v=v+1
    } else {
      m_res[v,4]=1
      v=v+1
    }
  }
}

m_res=as.data.frame(m_res)
m_res$bnf=p.adjust(as.numeric(as.character(m_res[,4])), method = "bonferroni")
m_res$FDR=p.adjust(as.numeric(as.character(m_res[,5])), method = "BH")
colnames(m_res)=c("Drug", "Metabolite", "Number_samples_metabolite_detected","P-value","BNF","FDR")
write.table(m_res, "~/Desktop/Metabolomics_v2/3.Preliminary_results/1.Summary_stats/rare_metabolites_medication.txt", sep = "\t", quote = F)

#Only for drugs within IBD

m_meds=ibd_test_phenos[,c(44:92)]
m_meds2=merge(m_meds,rare_mtb_coded, by="row.names")

m_res_ibd=matrix(nrow=15484,ncol = 4)
v=1
for (i in 2:49){
  for (a in 50:ncol(m_meds2)){
    m_res_ibd[v,1]=colnames(m_meds2)[i]
    m_res_ibd[v,2]=colnames(m_meds2)[a]
    m_res_ibd[v,3]=sum(m_meds2[,a] !=0)
    if(m_res_ibd[v,3]!=0){
      m_res_ibd[v,4]=chisq.test(m_meds2[,i],as.factor(m_meds2[,a]))$p.value
      v=v+1
    } else {
      m_res_ibd[v,4]=1
      v=v+1
    }
  }
}

m_res_ibd=as.data.frame(m_res_ibd)
m_res_ibd$bnf=p.adjust(as.numeric(as.character(m_res_ibd[,4])), method = "bonferroni")
m_res_ibd$FDR=p.adjust(as.numeric(as.character(m_res_ibd[,4])), method = "BH")
write.table(m_res_ibd, "~/Desktop/Metabolomics_v2/3.Preliminary_results/rare_metabolites_medication_IBD.txt", sep = "\t", quote = F)
```



10.Biosynthetic gene clusters
===

```{r}

#Calculated using BiG-MAP: https://github.com/medema-group/BiG-MAP & https://github.com/victoriapascal/gutsmash/tree/gutsmash

#Hannah database: gutSMASH on a combined collection of 4.083 genomes from the Culturable Genome Reference (CGR), Human Microbiome Project (HMP) and complete genomes belonging to Clostridiales species. This resulted in 11.509 predicted metabolic gene clusters which we used as input for BiG-MAP.family

#conda activate /home/umcg-avich/miniconda3/envs/BiG-MAP_process
#ml Bowtie2
#python3 /groups/umcg-gastrocol/tmp01/Arnau/BiG-MAP/src/BiG-MAP.map.py -th 10 -I1 /groups/umcg-gastrocol/tmp01/Arnau/BiG-MAP/batch8/*_1.fastq -I2 /groups/umcg-gastrocol/tmp01/Arnau/BiG-MAP/batch8/*_2.fastq -O /groups/umcg-gastrocol/tmp01/Arnau/BiG-MAP/result_b8/ -P ./BiG-MAP.GCF_HGF.pickle 
cc_rd=read.table("~/Documents/Project_Metabolome/1.Input_files/IDs_read_depth.txt", header = T, row.names = "PID")
cc_rd$row.names=NULL

setwd("~/Desktop/Metabolomics_v2/2.Input/BGC/")
 
file_list <- list.files()
flag=1
for (file in file_list){
       
  # if the merged dataset doesn't exist, create it
  if (flag==1){
    bgc <- read.table(file, header=TRUE,  check.names = F, sep=",", row.names = 1, stringsAsFactors = F)
    flag=5
  }
   
  # if the merged dataset does exist, append to it
  else {
    temp_bgc <-read.table(file, header=TRUE,  check.names = F, sep=",", row.names = 1, stringsAsFactors = F)
    bgc<-merge(bgc, temp_bgc, by="row.names", all.x=T)
    row.names(bgc)=bgc$Row.names
    bgc$Row.names=NULL
    rm(temp_bgc)
  }
 
}

bgc_rpkm=select(bgc, contains(".RPKM"))
colnames(bgc_rpkm)=gsub(".RPKM","",colnames(bgc_rpkm))
cc_rd$id2=rownames(cc_rd)
row.names(cc_rd)=cc_rd$IDs_MGS
cc_rd$row.names=NULL

bgc_rpkm2=merge(cc_rd,t(bgc_rpkm), by="row.names")
rownames(bgc_rpkm2)=bgc_rpkm2$id2
bgc_rpkm2$id2=NULL
bgc_rpkm2$Row.names=NULL
bgc_rpkm2$IDs_MGS=NULL
bgc_rpkm2$PF_RD=NULL
bgc_rpkm3=subset(bgc_rpkm2, row.names(bgc_rpkm2) %in% row.names(cc_pheno2))



bgc_coverage=select(bgc, contains(".cov"))
colnames(bgc_coverage)=gsub(".cov","",colnames(bgc_coverage))

bgc_coverage2=merge(cc_rd,t(bgc_coverage), by="row.names")
rownames(bgc_coverage2)=bgc_coverage2$id2
bgc_coverage2$id2=NULL
bgc_coverage2$Row.names=NULL
bgc_coverage2$IDs_MGS=NULL
bgc_coverage2$PF_RD=NULL
bgc_coverage3=subset(bgc_coverage2, row.names(bgc_coverage2) %in% row.names(cc_pheno2))



features_per_samples=data.frame(Sample=rownames(bgc_rpkm3), Counts=rowSums(bgc_rpkm3!=0))
samples_per_feature=data.frame(BCG=colnames(bgc_rpkm3), Counts=colSums(bgc_rpkm3!=0))


ggplot(features_per_samples, aes(reorder(Sample,-Counts), Counts )) + geom_bar(stat = "identity", fill="lightblue3") + theme_classic() + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) + ylab ("Number of Biosynthetic genes clusters")  + xlab ("Samples")

boxss=merge(cc_pheno, features_per_samples, by="row.names")

ggplot(boxss, aes (ibd_Diagnosis, Counts, fill=ibd_Diagnosis)) + geom_violin() + geom_boxplot(width=0.1,position=position_dodge(1), alpha=0.2)  + theme_bw() +scale_fill_manual(values=c("firebrick2","white","gray80", "blue2")) + ylab ("Number of biosynthetic gene clusters detected") + xlab ("") + scale_x_discrete(labels=c("n=239","n=255", "n=12", "n=175"))

ggplot(samples_per_feature, aes(reorder(BCG,-Counts), Counts )) + geom_bar(stat = "identity", fill="gray50") + theme_classic() + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) + ylab ("Number of samples")  + xlab ("Biosynthetic genes clusters")

#Filtering based on the region coverage (10%)
#bgc_coverage4=bgc_coverage3 [,colnames(bgc_coverage3) %in% colnames(bcg_fil_trans)]
bgc_coverage4=bgc_coverage3
bgc_mean_coverage=data.frame(BCG=colnames(bgc_coverage4), Mean=colMeans(bgc_coverage4))
ggplot(bgc_mean_coverage, aes(reorder(BCG,-Mean), Mean )) + geom_bar(stat = "identity", fill="red4") + theme_classic() + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) + ylab ("Mean coverage")  + xlab ("Biosynthetic genes clusters")

select_coverage=droplevels(bgc_mean_coverage$BCG[bgc_mean_coverage$Mean>0.1])

#Filtering prevalence in 20% => 568 metabolites
bcg_fil_trans=transform_and_filter_taxa(bgc_rpkm3, samples_row = T, method = "clr",missing_filter = 20)
bcg_fil_trans2=bcg_fil_trans[,colnames(bcg_fil_trans) %in% select_coverage]

bgc_rpkm3.1=bgc_rpkm3[,colnames(bgc_rpkm3) %in% colnames(bcg_fil_trans2)]
select2=subset(select,select$ibd_Diagnosis!="IBDU")
summary_bgc=summary_stats(bgc_rpkm3.1,select2, missing_vals = 0)
write.table(summary_bgc, "../../3.Preliminary_results/1.Summary_stats/BGC_summary.txt", sep = "\t", quote = F)

# Test differences between diseases (CNT/UC/CD) #

cc_ibd=cc_pheno6[,"ibd_Diagnosis", drop=F]
bgc_ibd=merge(cc_ibd,bcg_fil_trans2, by="row.names")

flag=1
for (a in 3:ncol(bgc_ibd)){
  my_name=colnames(bgc_ibd)[a]
  yy= pairwise.wilcox.test(bgc_ibd[,a],bgc_ibd$ibd_Diagnosis, p.adjust.method = "none")$p.value
  ccb=data.frame("Feature"=my_name,"CD_Control"=yy[1,1], "CD_IBDU"=yy[2,1],"CD_UC"=yy[3,1],"Control_IBDU"=yy[2,2], "Control_UC"=yy[3,2],"IBDU_UC"=yy[3,3] )
  if(flag==1){
    bgc_res=ccb
    flag=5
  }else{
    bgc_res=rbind(bgc_res,ccb)
  }
}
bgc_res$CD_IBDU=NULL
bgc_res$Control_IBDU=NULL
bgc_res$IBDU_UC=NULL
bgc_res_2=melt(bgc_res)
bgc_res_2$FDR=p.adjust(bgc_res_2$value, method = "BH")
bgc_res_2=dcast(bgc_res_2, formula=Feature~variable, value.var="FDR")
a_report_bgc=merge(summary_bgc,bgc_res_2, by.x="Metabolite", by.y="Feature")


write.table(bgc_ibd, "~/Desktop/Metabolomics_v2/2.Input/BGC_with_IBD.txt", sep = "\t", quote = F)
write.table(summary_bgc, "~/Desktop/Metabolomics_v2/3.Preliminary_results/7.Biosynthetic_gene_clusters_and_enzyme_comissions/BGC_summary_stats.txt", sep = "\t", quote = F)
write.table(a_report_bgc, "~/Desktop/Metabolomics_v2/3.Preliminary_results/7.Biosynthetic_gene_clusters_and_enzyme_comissions/BGC_per_disease_summary.txt", sep = "\t", quote = F)


###################################
## correlation BGC & Taxa        ##
###################################


#Regress covariates to BGC

#clus_taxa

rgs_bgc=merge(my_regress_phenos,bcg_fil_trans2, by="row.names")

rgs_bgc3=matrix(nrow=nrow(my_regress_phenos), ncol = ncol(bcg_fil_trans2))
n=1
for (i in 12:ncol(rgs_bgc)){

  #my_lm=lm(rgs_tx[,i] ~ host_Age_sampling+ host_BMI+ host_Sex +PF_RD+clinical_BowelMovementADayDef+ ibd_Diagnosis,data = rgs_tx)
  
  #rgs_tx2[,n] = my_lm$residuals
  
  my_lm2=lm(rgs_bgc[,i] ~host_Age_sampling+ host_BMI+ host_Sex+clinical_BowelMovementADayDef+ PF_RD,data = rgs_bgc)
  
  rgs_bgc3[,n] = my_lm2$residuals
  n=n+1
}
rgs_bgc3=as.data.frame(rgs_bgc3)
rownames(rgs_bgc3)=rgs_bgc$Row.names
colnames(rgs_bgc3)=colnames(rgs_bgc)[12:ncol(rgs_bgc)]

rgs_bgc_tx=merge(rgs_bgc3,rgs_tx3, by="row.names")
rownames(rgs_bgc_tx)=rgs_bgc_tx$Row.names
rgs_bgc_tx$Row.names=NULL

corr_bgc_tx_IBD=subset(rgs_bgc_tx,row.names(rgs_bgc_tx) %in% my_IBD)
corr_bgc_tx_CNT=subset(rgs_bgc_tx,row.names(rgs_bgc_tx) %in% my_CNT)


corr_bgc_tx_IBD_val=rcorr(as.matrix(corr_bgc_tx_IBD), type = "spearman")

test_corr_coef=corr_bgc_tx_IBD_val$r
test_corr_coef_sel=test_corr_coef[(ncol(rgs_bgc3)+1):nrow(test_corr_coef), 1:ncol(rgs_bgc3)]
test_corr_pval=corr_bgc_tx_IBD_val$P
test_corr_pval_sel=test_corr_pval[(ncol(rgs_bgc3)+1):nrow(test_corr_pval), 1:ncol(rgs_bgc3)]
corr_coef=melt(test_corr_coef_sel)
corr_pval=melt(test_corr_pval_sel)

table(corr_coef$Var1 == corr_pval$Var1)
table(corr_coef$Var2 == corr_pval$Var2)

colnames(corr_coef)=c("Taxa","BGC","Coeff")
colnames(corr_pval)=c("Taxa","BGC","P_val")
corr_taxa_bgc_oIBD=cbind(corr_coef, corr_pval)


corr_bgc_tx_vals=rcorr(as.matrix(corr_bgc_tx_CNT), type = "spearman")

test_corr_coef=corr_bgc_tx_vals$r
test_corr_coef_sel=test_corr_coef[(ncol(rgs_bgc3)+1):nrow(test_corr_coef), 1:ncol(rgs_bgc3)]
test_corr_pval=corr_bgc_tx_vals$P
test_corr_pval_sel=test_corr_pval[(ncol(rgs_bgc3)+1):nrow(test_corr_pval), 1:ncol(rgs_bgc3)]
corr_coef=melt(test_corr_coef_sel)
corr_pval=melt(test_corr_pval_sel)

table(corr_coef$Var1 == corr_pval$Var1)
table(corr_coef$Var2 == corr_pval$Var2)

colnames(corr_coef)=c("Taxa","BGC","Coeff")
colnames(corr_pval)=c("Taxa","BGC","P_val")
corr_bgc_tx_CNT=cbind(corr_coef, corr_pval)

corr_taxa_bgc_oIBD$Metabolites2=NULL
corr_taxa_bgc_oIBD[,4]=NULL
corr_bgc_tx_CNT$Metabolites2=NULL
corr_bgc_tx_CNT[,4]=NULL

corr_taxa_bgc_oIBD$Bonferroni=p.adjust(corr_taxa_bgc_oIBD$P_val, method = "bonferroni")
corr_bgc_tx_CNT$Bonferroni=p.adjust(corr_bgc_tx_CNT$P_val, method = "bonferroni")
corr_taxa_bgc_oIBD$FDR=p.adjust(corr_taxa_bgc_oIBD$P_val, method = "BH")
corr_bgc_tx_CNT$FDR=p.adjust(corr_bgc_tx_CNT$P_val, method = "BH")

corr_taxa_bgc_f=cbind(corr_taxa_bgc_oIBD, corr_bgc_tx_CNT)
colnames(corr_taxa_bgc_f)=c("Taxa", "BGC", "Coef_IBD", "BGC","P-val_IBD","BFN_IBD","FDR_IBD", "Taxa", "BGC","Coeff_Controls","BGC", "P-val_Controls", "BFN_Controls", "FDR_Controls")


write.table(corr_taxa_bgc_f, "~/Desktop/Metabolomics_v2/3.Preliminary_results/7.Biosynthetic_gene_clusters_and_enzyme_comissions/correlation_BGC_taxa_spearman.txt", sep = "\t", quote = F)


###################################
## correlation BGC & Metabolites ##
###################################

rgs_bgc_mtb=merge(rgs_bgc3,rgs_mb3, by="row.names")
rownames(rgs_bgc_mtb)=rgs_bgc_mtb$Row.names
rgs_bgc_mtb$Row.names=NULL

rgs_bgc_mtb_IBD=subset(rgs_bgc_mtb,row.names(rgs_bgc_mtb) %in% my_IBD)
rgs_bgc_mtb_CNT=subset(rgs_bgc_mtb,row.names(rgs_bgc_mtb) %in% my_CNT)


rgs_bgc_mtb_IBD_val=rcorr(as.matrix(rgs_bgc_mtb_IBD), type = "spearman")

test_corr_coef=rgs_bgc_mtb_IBD_val$r
test_corr_coef_sel=test_corr_coef[(ncol(rgs_bgc3)+1):nrow(test_corr_coef), 1:ncol(rgs_bgc3)]
test_corr_pval=rgs_bgc_mtb_IBD_val$P
test_corr_pval_sel=test_corr_pval[(ncol(rgs_bgc3)+1):nrow(test_corr_pval), 1:ncol(rgs_bgc3)]
corr_coef=melt(test_corr_coef_sel)
corr_pval=melt(test_corr_pval_sel)

table(corr_coef$Var1 == corr_pval$Var1)
table(corr_coef$Var2 == corr_pval$Var2)

colnames(corr_coef)=c("Metabolite","BGC","Coeff")
colnames(corr_pval)=c("Metabolite","BGC","P_val")
corr_mtb_bgc_oIBD=cbind(corr_coef, corr_pval)



corr_bgc_mtb_vals=rcorr(as.matrix(rgs_bgc_mtb_CNT), type = "spearman")
#here:
test_corr_coef=corr_bgc_mtb_vals$r
test_corr_coef_sel=test_corr_coef[(ncol(rgs_bgc3)+1):nrow(test_corr_coef), 1:ncol(rgs_bgc3)]
test_corr_pval=corr_bgc_mtb_vals$P
test_corr_pval_sel=test_corr_pval[(ncol(rgs_bgc3)+1):nrow(test_corr_pval), 1:ncol(rgs_bgc3)]
corr_coef=melt(test_corr_coef_sel)
corr_pval=melt(test_corr_pval_sel)

table(corr_coef$Var1 == corr_pval$Var1)
table(corr_coef$Var2 == corr_pval$Var2)

colnames(corr_coef)=c("Metabolites","BGC","Coeff")
colnames(corr_pval)=c("Metavolites","BGC","P_val")
corr_bgc_mtb_CNT=cbind(corr_coef, corr_pval)

corr_mtb_bgc_oIBD$Bonferroni=p.adjust(corr_mtb_bgc_oIBD$P_val, method = "bonferroni")
corr_bgc_mtb_CNT$Bonferroni=p.adjust(corr_bgc_mtb_CNT$P_val, method = "bonferroni")
corr_mtb_bgc_oIBD$FDR=p.adjust(corr_mtb_bgc_oIBD$P_val, method = "BH")
corr_bgc_mtb_CNT$FDR=p.adjust(corr_bgc_mtb_CNT$P_val, method = "BH")

corr_mtb_bgc_f=cbind(corr_mtb_bgc_oIBD, corr_bgc_mtb_CNT)


colnames(corr_mtb_bgc_f)=c("Metabolites", "BGC", "Coef_IBD", "Metabolites","BGC","P-val_IBD","BFN_IBD","FDR_IBD", "Metabolites", "BGC","Coeff_Controls","Metabolites","BGC", "P-val_Controls", "BFN_Controls", "FDR_Controls")


write.table(corr_mtb_bgc_f, "~/Desktop/Metabolomics_for_cluster/3.Preliminary_results_v2/correlation_BGC_metabolites_spearman.txt", sep = "\t", quote = F)



#####################################################
### TEST within IBD BGC - Metabolite associations ###
#####################################################
regressors=ibd_test_phenos[,c(1,2,3,4,7,8,35)]
mtb=ibd_test_phenos[,c(348:ncol(ibd_test_phenos))]

colnames(bcg_fil_trans2)=make.names(colnames(bcg_fil_trans2))

ibd_test_bgc=merge(regressors,bcg_fil_trans2, by="row.names")
rownames(ibd_test_bgc)=ibd_test_bgc$Row.names
ibd_test_bgc$Row.names=NULL

ibd_test_bgc=merge(ibd_test_bgc,mtb, by="row.names")
rownames(ibd_test_bgc)=ibd_test_bgc$Row.names
ibd_test_bgc$Row.names=NULL


#ibd_test_bgc=read.table("~/Desktop/Metabolomics_for_cluster/2.Input/intermed/ibd_BGC.txt", sep = "\t", header = T, row.names = 1)

flag=1
for ( i in 1:322) {
  my_pheno=colnames(ibd_test_bgc)[i]
  if (my_pheno=="clinical_BowelMovementADayDef" | my_pheno=="LC.COLUMN" | my_pheno=="host_BMI"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 323:ncol(ibd_test_bgc)){
      my_trait=colnames(ibd_test_bgc)[a]
      my_uni_test=ibd_test_bgc[,c("host_Sex","host_Age","clinical_BowelMovementADayDef","host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age","clinical_BowelMovementADayDef", "host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      #my_uni_test[,8]=as.numeric(as.character(my_uni_test[,8]))
      my_samples=nrow(my_uni_test)
      my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
          my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
          my_univariate_results=my_lm_pheno
          flag=5
      }
    }
  }
}

associations_bgc_wIBD=my_univariate_results


#Remove highly correlated bugs-BGC


associations_bgc_wIBD$FDR=p.adjust(associations_bgc_wIBD$`Pr(>|t|)`,method = "BH")
associations_bgc_wIBD$Bonferroni=p.adjust(associations_bgc_wIBD$`Pr(>|t|)`,method = "bonferroni")




write.table(associations_bgc_wIBD, "~/Desktop/Metabolomics_v2/3.Preliminary_results/7.Biosynthetic_gene_clusters_and_enzyme_comissions/within_IBD_associations_BGC_quantitative.txt", sep = "\t", quote = F)


##########################################################
### TEST within Controls BGC - Metabolite associations ###
##########################################################

regressors=controls_phenos[,c(1:7)]
mtb=controls_phenos[,c(356:ncol(controls_phenos))]

colnames(bcg_fil_trans2)=make.names(colnames(bcg_fil_trans2))

cnt_test_bgc=merge(regressors,bcg_fil_trans2, by="row.names")
rownames(cnt_test_bgc)=cnt_test_bgc$Row.names
cnt_test_bgc$Row.names=NULL

cnt_test_bgc=merge(cnt_test_bgc,mtb, by="row.names")
rownames(cnt_test_bgc)=cnt_test_bgc$Row.names
cnt_test_bgc$Row.names=NULL


#cnt_test_bgc=read.table("~/Desktop/Metabolomics_for_cluster/2.Input/intermed/controls_BGC.txt", sep = "\t", header = T, row.names = 1)

flag=1
for ( i in 1:322) {
  my_pheno=colnames(cnt_test_bgc)[i]
  if (my_pheno=="clinical_BowelMovementADayDef" | my_pheno=="LC.COLUMN" | my_pheno=="host_BMI"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 323:ncol(cnt_test_bgc)){
      my_trait=colnames(cnt_test_bgc)[a]
      my_uni_test=cnt_test_bgc[,c("host_Sex","host_Age","clinical_BowelMovementADayDef","host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age","clinical_BowelMovementADayDef", "host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      #my_uni_test[,8]=as.numeric(as.character(my_uni_test[,8]))
      my_samples=nrow(my_uni_test)
      my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
          my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
          my_univariate_results=my_lm_pheno
          flag=5
      }
    }
  }
}

associations_bgc_CNT=my_univariate_results
#associations_controls=subset(associations_controls, associations_controls$phenotype!="BioMK_ChromograninA")
associations_bgc_CNT$FDR=p.adjust(associations_bgc_CNT$`Pr(>|t|)`,method = "BH")
associations_bgc_CNT$Bonferroni=p.adjust(associations_bgc_CNT$`Pr(>|t|)`,method = "bonferroni")

write.table(associations_bgc_CNT, "~/Desktop/Metabolomics_v2/3.Preliminary_results/7.Biosynthetic_gene_clusters_and_enzyme_comissions/Controls_associations_BGC_quantitative.txt", sep = "\t", quote = F)



################################################################
### TEST within IBD BGC - Metabolite associations prevalence ###
################################################################

regressors=ibd_test_phenos2[,c(1,2,3,4,6,7,8,34)]
mtb=ibd_test_phenos2[,c(345:ncol(ibd_test_phenos2))]

#colnames(bcg_fil_trans2)=make.names(colnames(bcg_fil_trans2))

ibd_test_phenos2=merge(regressors,bcg_fil_trans2, by="row.names")
rownames(ibd_test_phenos2)=ibd_test_phenos2$Row.names
ibd_test_phenos2$Row.names=NULL

ibd_test_phenos2=merge(ibd_test_phenos2,mtb, by="row.names")
rownames(ibd_test_phenos2)=ibd_test_phenos2$Row.names
ibd_test_phenos2$Row.names=NULL


#ibd_test_phenos2=read.table("~/Desktop/Metabolomics_for_cluster/2.Input/intermed/controls_BGC_prev2.txt", sep = "\t", header = T, row.names = 1)

ibd_test_phenos2$clinical_BowelMovementADayDef.1=NULL

flag=1
for ( i in 1:323) {
  my_pheno=colnames(ibd_test_phenos2)[i]
  if (my_pheno=="run_day_cat" | my_pheno=="clinical_BowelMovementADayDef" | my_pheno=="LC.COLUMN"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age" | my_pheno=="host_BMI") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 324:ncol(ibd_test_phenos2)){
      my_trait=colnames(ibd_test_phenos2)[a]
      my_uni_test=ibd_test_phenos2[,c("host_Sex","host_Age","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer","clinical_BowelMovementADayDef", "host_BMI",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age","host_BMI", "run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer","clinical_BowelMovementADayDef",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      my_uni_test[,10]=as.numeric(as.character(my_uni_test[,10]))
      my_samples=nrow(my_uni_test)
      #my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm=summary(glm(my_f, family = binomial(link="logit"), data =my_uni_test))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
        my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
        my_univariate_results=my_lm_pheno
        flag=5
      }
    }
  }
}

associations_BGC_ibd_prev=my_univariate_results
associations_BGC_ibd_prev$FDR=p.adjust(associations_BGC_ibd_prev$`Pr(>|z|)`,method = "BH")
associations_BGC_ibd_prev$Bonferroni=p.adjust(associations_BGC_ibd_prev$`Pr(>|z|)`,method = "bonferroni")
write.table(associations_BGC_ibd_prev, "~/Desktop/Metabolomics_v2/3.Preliminary_results/7.Biosynthetic_gene_clusters_and_enzyme_comissions/IBD_associations_BGC_prevalence.txt", sep = "\t", quote = F)


#####################################################################
### TEST within Controls BGC - Metabolite associations prevalence ###
#####################################################################

regressors=controls_phenos_prev[,c(1:8)]
mtb=controls_phenos_prev[,c(357:ncol(controls_phenos_prev))]

#colnames(bcg_fil_trans2)=make.names(colnames(bcg_fil_trans2))

ibd_test_phenos2=merge(regressors,bcg_fil_trans2, by="row.names")
rownames(ibd_test_phenos2)=ibd_test_phenos2$Row.names
ibd_test_phenos2$Row.names=NULL

ibd_test_phenos2=merge(ibd_test_phenos2,mtb, by="row.names")
rownames(ibd_test_phenos2)=ibd_test_phenos2$Row.names
ibd_test_phenos2$Row.names=NULL


flag=1
for ( i in 1:323) {
  my_pheno=colnames(ibd_test_phenos2)[i]
  if (my_pheno=="run_day_cat" | my_pheno=="clinical_BowelMovementADayDef" | my_pheno=="LC.COLUMN"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age" | my_pheno=="host_BMI") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 324:ncol(ibd_test_phenos2)){
      my_trait=colnames(ibd_test_phenos2)[a]
      my_uni_test=ibd_test_phenos2[,c("host_Sex","host_Age","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer","clinical_BowelMovementADayDef", "host_BMI",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age","host_BMI", "run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer","clinical_BowelMovementADayDef",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      my_uni_test[,10]=as.numeric(as.character(my_uni_test[,10]))
      my_samples=nrow(my_uni_test)
      #my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm=summary(glm(my_f, family = binomial(link="logit"), data =my_uni_test))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
        my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
        my_univariate_results=my_lm_pheno
        flag=5
      }
    }
  }
}

associations_BGC_cnt_prev=my_univariate_results
associations_BGC_cnt_prev$FDR=p.adjust(associations_BGC_cnt_prev$`Pr(>|z|)`,method = "BH")
associations_BGC_cnt_prev$Bonferroni=p.adjust(associations_BGC_cnt_prev$`Pr(>|z|)`,method = "bonferroni")
write.table(associations_BGC_cnt_prev, "~/Desktop/Metabolomics_v2/3.Preliminary_results/7.Biosynthetic_gene_clusters_and_enzyme_comissions/IBD_associations_BGC_prevalence.txt", sep = "\t", quote = F)


```





11.Enzime commission abundance
===

```{r}

enzymes=read.table("~/Desktop/Metabolomics_v2/2.Input/Merged_EC_filtered.txt", header = T, sep="\t", row.names = 1, check.names = F)

colnames(enzymes)=gsub("_EC_translated","",colnames(enzymes))

enzymes2=merge(cc_rd,t(enzymes), by="row.names")
rownames(enzymes2)=enzymes2$id2
enzymes2$id2=NULL
enzymes2$Row.names=NULL
enzymes2$IDs_MGS=NULL
enzymes2$PF_RD=NULL
enzymes3=subset(enzymes2, row.names(enzymes2) %in% row.names(cc_pheno2))
#summary_enzymes=summary_stats(enzymes3,select2, missing_vals = 0)

features_per_samples=data.frame(Sample=rownames(enzymes3), Counts=rowSums(enzymes3!=0))
samples_per_feature=data.frame(BCG=colnames(enzymes3), Counts=colSums(enzymes3!=0))

ggplot(features_per_samples, aes(reorder(Sample,-Counts), Counts )) + geom_bar(stat = "identity", fill="lightblue3") + theme_classic() + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) + ylab ("Number of Enzymes per samples")  + xlab ("Samples")

boxss=merge(cc_pheno, features_per_samples, by="row.names")

ggplot(boxss, aes (ibd_Diagnosis, Counts, fill=ibd_Diagnosis)) + geom_violin() + geom_boxplot(width=0.1,position=position_dodge(1), alpha=0.2)  + theme_bw() +scale_fill_manual(values=c("firebrick2","white","gray80", "blue2")) + ylab ("Number of enzymes detected") + xlab ("") + scale_x_discrete(labels=c("n=239","n=255", "n=12", "n=175"))

ggplot(samples_per_feature, aes(reorder(BCG,-Counts), Counts )) + geom_bar(stat = "identity", fill="gray50") + theme_classic() + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) + ylab ("Number of samples")  + xlab ("Enzymes")

enzymes_trans=transform_and_filter_taxa(enzymes3, samples_row = T, method = "clr",missing_filter = 20)
enzymes_trans$UNMAPPED=NULL
enzymes_trans$UNGROUPED=NULL


#Filtering prevalence in 20% 

#enz_corr=cor(enzymes_trans, method = "spearman")
#corr_enz <- findCorrelation(enz_corr, cutoff=0.85, names = T)
#enzymes_trans2=enzymes_trans[,colnames(enzymes_trans) %ni% corr_enz]

#write.table(enzymes_trans2, "~/Desktop/Metabolomics_for_cluster/2.Input/EC_filtered.txt", sep = "\t", quote = F)

enzy_ibd=merge(cc_ibd,enzymes_trans, by="row.names")

flag=1
for (a in 3:ncol(enzy_ibd)){
  my_name=colnames(enzy_ibd)[a]
  yy= pairwise.wilcox.test(enzy_ibd[,a],enzy_ibd$ibd_Diagnosis, p.adjust.method = "none")$p.value
  ccb=data.frame("Feature"=my_name,"CD_Control"=yy[1,1], "CD_IBDU"=yy[2,1],"CD_UC"=yy[3,1],"Control_IBDU"=yy[2,2], "Control_UC"=yy[3,2],"IBDU_UC"=yy[3,3] )
  if(flag==1){
    enzy_res=ccb
    flag=5
  }else{
    enzy_res=rbind(enzy_res,ccb)
  }
}
enzy_res$CD_IBDU=NULL
enzy_res$Control_IBDU=NULL
enzy_res$IBDU_UC=NULL
enzy_res_2=melt(enzy_res)
enzy_res_2$FDR=p.adjust(enzy_res_2$value, method = "BH")
enzy_res_2=dcast(enzy_res_2, formula=Feature~variable, value.var="FDR")


#a_report_bgc=merge(summary_bgc,bgc_res_2, by.x="Metabolite", by.y="Feature")

#######################################
## correlation enzymes & metabolites ##
#######################################


rgs_enzy=merge(my_regress_phenos,enzymes_trans, by="row.names")

rgs_enzy3=matrix(nrow=nrow(my_regress_phenos), ncol = ncol(enzymes_trans))
n=1
for (i in 12:ncol(rgs_bgc)){

  
  my_lm2=lm(rgs_enzy[,i] ~host_Age_sampling+ host_BMI+ host_Sex+clinical_BowelMovementADayDef+ PF_RD,data = rgs_enzy)
  
  rgs_enzy3[,n] = my_lm2$residuals
  n=n+1
}
rgs_enzy3=as.data.frame(rgs_enzy3)
rownames(rgs_enzy3)=rgs_enzy$Row.names
colnames(rgs_enzy3)=colnames(rgs_enzy)[12:ncol(rgs_enzy)]

enzy_mtb=merge(rgs_enzy3,rgs_mb3, by="row.names")
rownames(enzy_mtb)=enzy_mtb$Row.names
enzy_mtb$Row.names=NULL

enzy_mtb_IBD=subset(enzy_mtb,row.names(enzy_mtb) %in% my_IBD)
enzy_mtb_CNT=subset(enzy_mtb,row.names(enzy_mtb) %in% my_CNT)


enzy_mtb_IBD_val=rcorr(as.matrix(enzy_mtb_IBD), type = "spearman")

test_corr_coef=enzy_mtb_IBD_val$r
test_corr_coef_sel=test_corr_coef[(ncol(rgs_enzy3)+1):nrow(test_corr_coef), 1:ncol(rgs_enzy3)]
test_corr_pval=enzy_mtb_IBD_val$P
test_corr_pval_sel=test_corr_pval[(ncol(rgs_enzy3)+1):nrow(test_corr_pval), 1:ncol(rgs_enzy3)]
corr_coef=melt(test_corr_coef_sel)
corr_pval=melt(test_corr_pval_sel)

table(corr_coef$Var1 == corr_pval$Var1)
table(corr_coef$Var2 == corr_pval$Var2)

colnames(corr_coef)=c("Metabolite","Enzyme","Coeff")
colnames(corr_pval)=c("Metabolite","Enzyme","P_val")
corr_mtb_enz_oIBD=cbind(corr_coef, corr_pval)


enzy_mtb_vals=rcorr(as.matrix(enzy_mtb_CNT), type = "spearman")
#here:
test_corr_coef=enzy_mtb_vals$r
test_corr_coef_sel=test_corr_coef[(ncol(rgs_enzy3)+1):nrow(test_corr_coef), 1:ncol(rgs_enzy3)]
test_corr_pval=enzy_mtb_vals$P
test_corr_pval_sel=test_corr_pval[(ncol(rgs_enzy3)+1):nrow(test_corr_pval), 1:ncol(rgs_enzy3)]
corr_coef=melt(test_corr_coef_sel)
corr_pval=melt(test_corr_pval_sel)

table(corr_coef$Var1 == corr_pval$Var1)
table(corr_coef$Var2 == corr_pval$Var2)

colnames(corr_coef)=c("Metabolites","Enzyme","Coeff")
colnames(corr_pval)=c("Metabolites","Enzyme","P_val")
corr_enzy_mtb_CNT=cbind(corr_coef, corr_pval)

corr_mtb_enz_oIBD$Bonferroni=p.adjust(corr_mtb_enz_oIBD$P_val, method = "bonferroni")
corr_enzy_mtb_CNT$Bonferroni=p.adjust(corr_enzy_mtb_CNT$P_val, method = "bonferroni")
corr_mtb_enz_oIBD$FDR=p.adjust(corr_mtb_enz_oIBD$P_val, method = "BH")
corr_enzy_mtb_CNT$FDR=p.adjust(corr_enzy_mtb_CNT$P_val, method = "BH")

corr_mtb_enzy_f=cbind(corr_mtb_enz_oIBD, corr_enzy_mtb_CNT)


colnames(corr_mtb_enzy_f)=c("Metabolites", "Enzyme", "Coef_IBD", "Metabolites","Enzyme","P-val_IBD","BFN_IBD","FDR_IBD", "Metabolites", "Enzyme","Coeff_Controls","Metabolites","Enzyme", "P-val_Controls", "BFN_Controls", "FDR_Controls")


write.table(corr_mtb_enzy_f, "~/Desktop/Metabolomics_v2/3.Preliminary_results/7.Biosynthetic_gene_clusters_and_enzyme_comissions/correlation_enzyme_metabolites_spearman.txt", sep = "\t", quote = F)



############################################
### IBD enzyme-metabolites quantitative ####
############################################

regressors=ibd_test_phenos[,c(1,2,3,4,7,8,35)]
mtb=ibd_test_phenos[,c(348:ncol(ibd_test_phenos))]

ibd_test_enz=merge(regressors,enzymes_trans, by="row.names")
rownames(ibd_test_enz)=ibd_test_enz$Row.names
ibd_test_enz$Row.names=NULL

ibd_test_enz=merge(ibd_test_enz,mtb, by="row.names")
rownames(ibd_test_enz)=ibd_test_enz$Row.names
ibd_test_enz$Row.names=NULL

flag=1
for ( i in 1:1607) {
  my_pheno=colnames(ibd_test_enz)[i]
  if (my_pheno=="clinical_BowelMovementADayDef" | my_pheno=="LC.COLUMN" | my_pheno=="host_BMI"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 1608:ncol(ibd_test_enz)){
      my_trait=colnames(ibd_test_enz)[a]
      my_uni_test=ibd_test_enz[,c("host_Sex","host_Age","clinical_BowelMovementADayDef","host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age","clinical_BowelMovementADayDef", "host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      #my_uni_test[,8]=as.numeric(as.character(my_uni_test[,8]))
      my_samples=nrow(my_uni_test)
      my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
        my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
        my_univariate_results=my_lm_pheno
        flag=5
      }
    }
  }
}

associations_enz_CNT=my_univariate_results
#associations_controls=subset(associations_controls, associations_controls$phenotype!="BioMK_ChromograninA")
associations_enz_CNT$FDR=p.adjust(associations_enz_CNT$`Pr(>|t|)`,method = "BH")
associations_enz_CNT$Bonferroni=p.adjust(associations_enz_CNT$`Pr(>|t|)`,method = "bonferroni")

write.table(associations_enz_CNT, "./IBD_associations_enzymes_quantitative.txt", sep = "\t", quote = F)




#################################################
### Controls enzyme-metabolites quantitative ####
#################################################

regressors=controls_phenos[,c(1:7)]
mtb=controls_phenos[,c(356:ncol(controls_phenos))]

cnt_test_enz=merge(regressors,enzymes_trans, by="row.names")
rownames(cnt_test_enz)=cnt_test_enz$Row.names
cnt_test_enz$Row.names=NULL

cnt_test_enz=merge(cnt_test_enz,mtb, by="row.names")
rownames(cnt_test_enz)=cnt_test_enz$Row.names
cnt_test_enz$Row.names=NULL

flag=1
for ( i in 1:1607) {
  my_pheno=colnames(cnt_test_enz)[i]
  if (my_pheno=="clinical_BowelMovementADayDef" | my_pheno=="LC.COLUMN" | my_pheno=="host_BMI"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 1608:ncol(cnt_test_enz)){
      my_trait=colnames(cnt_test_enz)[a]
      my_uni_test=cnt_test_enz[,c("host_Sex","host_Age","clinical_BowelMovementADayDef","host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age","clinical_BowelMovementADayDef", "host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      #my_uni_test[,8]=as.numeric(as.character(my_uni_test[,8]))
      my_samples=nrow(my_uni_test)
      my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
        my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
        my_univariate_results=my_lm_pheno
        flag=5
      }
    }
  }
}

associations_enz_CNT=my_univariate_results
#associations_controls=subset(associations_controls, associations_controls$phenotype!="BioMK_ChromograninA")
associations_enz_CNT$FDR=p.adjust(associations_enz_CNT$`Pr(>|t|)`,method = "BH")
associations_enz_CNT$Bonferroni=p.adjust(associations_enz_CNT$`Pr(>|t|)`,method = "bonferroni")

write.table(associations_enz_CNT, "./Controls_associations_enzymes_quantitative.txt", sep = "\t", quote = F)

```



12. Bile acids
====


```{r}

#Select primary and secondary bile acids

PBA=rownames(annot)[annot$SUB.PATHWAY=="Primary Bile Acid Metabolism"]
SBA=rownames(annot)[annot$SUB.PATHWAY=="Secondary Bile Acid Metabolism"]

BA=all_new_ID_raw[,colnames(all_new_ID_raw) %in% PBA | colnames(all_new_ID_raw) %in% SBA]

#my_flag=1
#for (z in unique(my_batch_id$run_day_cat)){
  my_names=rownames(my_batch_id)[my_batch_id$run_day_cat==z]
  d1=subset(BA, row.names(BA) %in% my_names)
  d1.1=apply(d1, 2, function (x) {x/median(x,na.rm = T)})
  
  if (my_flag==1){
    BA_norm=d1.1
    my_flag=5
    
  } else{
    BA_norm=rbind(BA_norm,d1.1)
    
  }
}

#BA.2=as.data.frame(BA_norm)
#BA_norm=as.data.frame(BA_norm)

# Add a pseudocount
#BA_norm[is.na(BA_norm)]=min(BA_norm,na.rm = T)/2
BA_norm=BA
BA_norm[is.na(BA_norm)]=min(BA_norm,na.rm = T)/2

#Calculate ratios
#SBA/PBA => DCA/CA || LCA/CDCA || LCA / UDCA

BA_norm$R1_DCA_vs_CA=log10(BA_norm$deoxycholate / BA_norm$cholate)

BA_norm$R2_LCA_vs_CDCA=log10(BA_norm$lithocholate / BA_norm$chenodeoxycholate)

BA_norm$R3_UCDA_vs_CDCA=log10(BA_norm$ursodeoxycholate / BA_norm$chenodeoxycholate )

#Conjugated/Unconjugated => (TCA + GCA) / CA || (TCDCA + GCDCA) / CDCA 

BA_norm$R4_Conju_vs_Unconj_CA=log10((BA_norm$glycocholate+BA_norm$taurocholate) /BA_norm$cholate)

BA_norm$R5_Conju_vs_Unconj_CDCA=log10((BA_norm$glycochenodeoxycholate+BA_norm$taurochenodeoxycholate) /BA_norm$chenodeoxycholate)

BA_norm$R6_Conju_vs_Unconj_LCA=log10((BA_norm$glycolithocholate+BA_norm$taurolithocholate) /BA_norm$lithocholate)

BA_norm$R7_Conju_vs_Unconj_UDCA=log10((BA_norm$glycoursodeoxycholate+BA_norm$tauroursodeoxycholate) /BA_norm$ursodeoxycholate)

BA_norm$R8_Conju_vs_Unconj_DCA=log10((BA_norm$glycodeoxycholate+BA_norm$taurodeoxycholate) /BA_norm$deoxycholate)



# Add phenotypes

BA_p=merge(cc_ibd,BA_norm,by="row.names")
BA_p=subset(BA_p,BA_p$ibd_Diagnosis!="IBDU")
BA_p$ibd_Diagnosis=as.character(BA_p$ibd_Diagnosis)
BA_p$ibd_Diagnosis[BA_p$ibd_Diagnosis=="Control"]="1_Control"
BA_p$ibd_Diagnosis[BA_p$ibd_Diagnosis=="UC"]="2_UC"
BA_p$ibd_Diagnosis[BA_p$ibd_Diagnosis=="CD"]="3_CD"

BA_p2=BA_p[,c("Row.names","ibd_Diagnosis","cholate","deoxycholate","lithocholate","chenodeoxycholate","ursodeoxycholate","R1_DCA_vs_CA","R2_LCA_vs_CDCA","R3_UCDA_vs_CDCA","R4_Conju_vs_Unconj_CA","R5_Conju_vs_Unconj_CDCA","R6_Conju_vs_Unconj_LCA","R7_Conju_vs_Unconj_UDCA", "R8_Conju_vs_Unconj_DCA")]

BA_p2$cholate=log10(BA_p2$cholate)
BA_p2$deoxycholate=log10(BA_p2$deoxycholate)
BA_p2$lithocholate=log10(BA_p2$lithocholate)
BA_p2$chenodeoxycholate=log10(BA_p2$chenodeoxycholate)
BA_p2$ursodeoxycholate=log10(BA_p2$ursodeoxycholate)

BA_p2.1=BA_p2[,c(1:7)]
BA_p2.2=BA_p2[,c(1,2,8:15)]

BA_p3.1=melt(BA_p2.1,id.var=c("Row.names","ibd_Diagnosis"))
BA_p3.2=melt(BA_p2.2,id.var=c("Row.names","ibd_Diagnosis"))

my_comparisions=list(  c("1_Control","2_UC"), c("3_CD","2_UC"),c("3_CD","1_Control"))

ggplot(BA_p3.1, aes(ibd_Diagnosis,value, fill=ibd_Diagnosis)) + geom_violin(alpha=0.8) + geom_jitter(height = 0, width = 0.1, alpha=0.4) + geom_boxplot(width=0.1, fill="white") + theme_bw() + xlab("Clusters")  + scale_fill_manual(values =c("gray80","steelblue2","firebrick3" )) + facet_wrap(variable~., ncol=2) + stat_compare_means(comparisons = my_comparisions, method = "wilcox.test", p.adjust.methods="bonferroni",label="p.signif") 

ggplot(BA_p3.2, aes(ibd_Diagnosis,value, fill=ibd_Diagnosis)) + geom_violin(alpha=0.8) + geom_jitter(height = 0, width = 0.1, alpha=0.4) + geom_boxplot(width=0.1, fill="white") + theme_bw() + xlab("Clusters")  + scale_fill_manual(values =c("gray80","steelblue2","firebrick3" )) + facet_wrap(variable~., ncol=2) + stat_compare_means(comparisons = my_comparisions, method = "wilcox.test", p.adjust.methods="bonferroni",label="p.signif")

flag=1
for (a in 3:ncol(BA_p2.2)){
  x=pairwise.wilcox.test(BA_p2.2[,a],BA_p2.2$ibd_Diagnosis, p.adjust.method = "none")$p.value
  ccb=data.frame("Feature"=colnames(BA_p2.2)[a],"Control_UC"=x[1,1], "Control_CD"=x[2,1],"CD_UC"=x[2,2])
  if(flag==1){
    ba_ratios=ccb
    flag=7
  }else{
    ba_ratios=rbind(ba_ratios,ccb)
  }
}

#Stratify CD by ileum inflammation and/or ileum resection 
BA_CD=subset(ibd_test_phenos,ibd_test_phenos$clinical_Diagnosis!="IBDU")
CD_p=BA_CD[, c("clinical_ActiveDisease","clinical_Diagnosis","clinical_inflammation_ileum","clinical_ResectionIlealAny","clinical_ResectionIlealCecalAny" )]
CD_p$clinical_ActiveDisease[is.na(CD_p$clinical_ActiveDisease)]="NotActive"
CD_p$clinical_inflammation_ileum[is.na(CD_p$clinical_inflammation_ileum)]="no"
CD_p$clinical_ResectionIlealAny[is.na(CD_p$clinical_ResectionIlealAny)]="no"
CD_p$clinical_ResectionIlealCecalAny[is.na(CD_p$clinical_ResectionIlealCecalAny)]="no"

CD_p$Resection_ileum="3_no"
CD_p$Resection_ileum[CD_p$clinical_ResectionIlealCecalAny=="yes" | CD_p$clinical_ResectionIlealAny=="yes"]="4_yes"
CD_p$Resection_ileum[CD_p$clinical_Diagnosis=="UC" ]="2_UC"

CD_p$Infl="A_no"
CD_p$Infl[CD_p$clinical_Diagnosis=="UC"]="B_UC"
CD_p$Infl[CD_p$clinical_Diagnosis=="CD" & CD_p$clinical_ActiveDisease=="NotActive" & CD_p$clinical_inflammation_ileum=="no"]="C_Colon_NonInF"
CD_p$Infl[CD_p$clinical_Diagnosis=="CD" & CD_p$clinical_ActiveDisease=="Active" & CD_p$clinical_inflammation_ileum=="no"]="D_Colon_InF"
CD_p$Infl[CD_p$clinical_Diagnosis=="CD" & CD_p$clinical_ActiveDisease=="NotActive" & CD_p$clinical_inflammation_ileum=="yes"]="E_Ileum_NonInF"
CD_p$Infl[CD_p$clinical_Diagnosis=="CD" & CD_p$clinical_ActiveDisease=="Active" & CD_p$clinical_inflammation_ileum=="yes"]="F_Ileum_InF"

rownames(BA_p2.2)=BA_p2.2$Row.names
BA_p2.2$Row.names=NULL
BA_CD=merge(CD_p,BA_p2.2,by="row.names", all.y =T )
BA_CD$Resection_ileum[is.na(BA_CD$Resection_ileum)]="1_control"
BA_CD$Infl[is.na(BA_CD$Infl)]="A_control"
BA_CD=BA_CD[,c(1,7:ncol(BA_CD))]
BA_CD$ibd_Diagnosis=NULL
BA_CD2=melt(BA_CD,id.var=c("Row.names","Infl","Resection_ileum"))


my_comparisions=list(  c("E_Ileum_NonInF","F_Ileum_InF"), c("C_Colon_NonInF","D_Colon_InF"),c("C_Colon_NonInF","E_Ileum_NonInF"))

ggplot(BA_CD2, aes(Infl,value, fill=Infl)) + geom_violin(alpha=0.8) + geom_jitter(height = 0, width = 0.1, alpha=0.4) + geom_boxplot(width=0.1, fill="white") + theme_bw() + xlab("Clusters")  + scale_fill_manual(values =c("gray80","lightblue","steelblue2","blue","salmon","firebrick3" )) + facet_wrap(variable~., ncol=2) + stat_compare_means(comparisons = my_comparisions, method = "wilcox.test", p.adjust.methods="bonferroni",label="p.signif") 


my_comparisions=list(  c("2_UC","3_no"), c("3_no","4_yes"),c("2_UC","4_yes"))

ggplot(BA_CD2, aes(Resection_ileum,value, fill=Resection_ileum)) + geom_violin(alpha=0.8) + geom_jitter(height = 0, width = 0.1, alpha=0.4) + geom_boxplot(width=0.1, fill="white") + theme_bw() + xlab("Clusters")  + scale_fill_manual(values =c("gray80","lightblue","salmon","firebrick3" )) + facet_wrap(variable~., ncol=2) + stat_compare_means(comparisons = my_comparisions, method = "wilcox.test", p.adjust.methods="bonferroni",label="p.signif") 



flag=1
for (a in 4:ncol(BA_CD)){
  x=pairwise.wilcox.test(BA_CD[,a],BA_CD$Resection_ileum, p.adjust.method = "none")$p.value
  ccb=data.frame("Feature"=colnames(BA_CD)[a],"Control_UC"=x[1,1], "Control_CD_No_resected"=x[2,1],"Control_CD_resection"=x[3,1], "UC_CD_no_resection"=x[2,2], "UC_CD_resected"=x[3,2],"CD_CD_resection"=x[3,3])
  if(flag==1){
    ba_ratios2=ccb
    flag=7
  }else{
    ba_ratios2=rbind(ba_ratios2,ccb)
  }
}

flag=1
for (a in 4:ncol(BA_CD)){
  x=pairwise.wilcox.test(BA_CD[,a],BA_CD$Infl, p.adjust.method = "none")$p.value
  ccb=data.frame("Feature"=colnames(BA_CD)[a],"Control_UC"=x[1,1], "Control_CD_Colonic_NoInF"=x[2,1],"Control_CD_Colonic_InF"=x[3,1], "Control_CD_Ileum_NoInf"=x[4,1], "Control_CD_Ileum_Inf"=x[5,1],"UC_CD_Colonic_NoInF"=x[2,2],"UC_CD_Colonic_InF"=x[3,2], "UC_CD_Ileum_NoInf"=x[4,2], "UC_CD_Ileum_Inf"=x[5,2],"CD_Colonic_NoInf_CD_Colonic_InF"=x[3,3], "CD_Colonic_NoInf_CD_Ileum_NoInf"=x[4,3], "CD_Colonic_NoInF_CD_Ileum_Inf"=x[5,3],  "CD_Colonic_Inf_CD_Ileum_NoInf"=x[4,4], "CD_Colonic_InF_CD_Ileum_Inf"=x[5,4],"CD_Ileum_NoInf_InF_CD_Ileum_Inf"=x[5,5])
  if(flag==1){
    ba_ratios3=ccb
    flag=7
  }else{
    ba_ratios3=rbind(ba_ratios3,ccb)
  }
}

ba_ratio_comb=cbind(ba_ratios,ba_ratios2)
ba_ratio_comb=cbind(ba_ratio_comb,ba_ratios3)

ba_ratio_comb=ba_ratio_comb[,-c(5,6,12,13)]

ba_ratio_comb=melt(ba_ratio_comb)
ba_ratio_comb$FDR=p.adjust(ba_ratio_comb$value, method = "BH")
ba_ratio_comb=dcast(ba_ratio_comb, formula=Feature~variable, value.var="FDR")

write.table(ba_ratio_comb, "~/Desktop/Metabolomics_v2/7.Supplmentary_tables/BA_ratios.txt", sep = "\t", quote = F)

ba_ratio_comb=cbind(ba_ratios,ba_ratios2)
ba_ratio_comb=cbind(ba_ratio_comb,ba_ratios3)

ba_ratio_comb=ba_ratio_comb[,-c(5,6,12,13)]
ba_ratio_comb=melt(ba_ratio_comb)
ba_ratio_comb$FDR=p.adjust(ba_ratio_comb$value, method = "bonferroni")
ba_ratio_comb=dcast(ba_ratio_comb, formula=Feature~variable, value.var="FDR")
```



13. n6/n3 PUFAs
====


```{r}

#Select primary and secondary bile acids

PUFA=rownames(annot)[annot$SUB.PATHWAY=="Long Chain Polyunsaturated Fatty Acid (n3 and n6)"]


PUFAs=all_new_ID_raw[,colnames(all_new_ID_raw) %in% PUFA]

#my_flag=1
#for (z in unique(my_batch_id$run_day_cat)){
  my_names=rownames(my_batch_id)[my_batch_id$run_day_cat==z]
  d1=subset(PUFAs, row.names(PUFAs) %in% my_names)
  d1.1=apply(d1, 2, function (x) {x/median(x,na.rm = T)})
  
  if (my_flag==1){
    PUFAs_norm=d1.1
    my_flag=5
    
  } else{
    PUFAs_norm=rbind(PUFAs_norm,d1.1)
    
  }
}

#PUFA.2=as.data.frame(PUFAs_norm)
#PUFAs_norm=as.data.frame(PUFAs_norm)
PUFAs_norm=as.data.frame(PUFAs)
# Add a pseudocount
PUFAs_norm[is.na(PUFAs_norm)]=min(PUFAs_norm,na.rm = T)/2

#Calculate ratios
#n6/n3

PUFAs_norm$n6_vs_n3=log10((PUFAs_norm$arachidonate_20_4n6+PUFAs_norm$dihomolinoleate_20_2n6+PUFAs_norm$docosadienoate_22_2n6+PUFAs_norm$hexadecadienoate_16_2n6+PUFAs_norm$linoleate_18_2n6)/(PUFAs_norm$docosahexaenoate_DHA__22_6n3+PUFAs_norm$docosapentaenoate_DPA__22_5n3+PUFAs_norm$eicosapentaenoate_EPA__20_5n3+PUFAs_norm$hexadecatrienoate_16_3n3+PUFAs_norm$stearidonate_18_4n3))


# Add phenotypes

PUFAs_p=merge(cc_ibd,PUFAs_norm,by="row.names")
PUFAs_p=subset(PUFAs_p,PUFAs_p$ibd_Diagnosis!="IBDU")
PUFAs_p$ibd_Diagnosis=as.character(PUFAs_p$ibd_Diagnosis)
PUFAs_p$ibd_Diagnosis[PUFAs_p$ibd_Diagnosis=="Control"]="1_Control"
PUFAs_p$ibd_Diagnosis[PUFAs_p$ibd_Diagnosis=="UC"]="2_UC"
PUFAs_p$ibd_Diagnosis[PUFAs_p$ibd_Diagnosis=="CD"]="3_CD"

PUFAs_p2=PUFAs_p[,c("Row.names","ibd_Diagnosis","arachidonate_20_4n6","dihomolinoleate_20_2n6","docosadienoate_22_2n6","hexadecadienoate_16_2n6","linoleate_18_2n6","docosahexaenoate_DHA__22_6n3","docosapentaenoate_DPA__22_5n3","eicosapentaenoate_EPA__20_5n3","hexadecatrienoate_16_3n3","stearidonate_18_4n3", "n6_vs_n3")]

PUFAs_p2$arachidonate_20_4n6=log10(PUFAs_p2$arachidonate_20_4n6)
PUFAs_p2$dihomolinoleate_20_2n6=log10(PUFAs_p2$dihomolinoleate_20_2n6)
PUFAs_p2$docosadienoate_22_2n6=log10(PUFAs_p2$docosadienoate_22_2n6)

PUFAs_p2$hexadecadienoate_16_2n6=log10(PUFAs_p2$hexadecadienoate_16_2n6)
PUFAs_p2$linoleate_18_2n6=log10(PUFAs_p2$linoleate_18_2n6)

PUFAs_p2$docosahexaenoate_DHA__22_6n3=log10(PUFAs_p2$docosahexaenoate_DHA__22_6n3)
PUFAs_p2$docosapentaenoate_DPA__22_5n3=log10(PUFAs_p2$docosapentaenoate_DPA__22_5n3)

PUFAs_p2$eicosapentaenoate_EPA__20_5n3=log10(PUFAs_p2$eicosapentaenoate_EPA__20_5n3)
PUFAs_p2$hexadecatrienoate_16_3n3=log10(PUFAs_p2$hexadecatrienoate_16_3n3)
PUFAs_p2$stearidonate_18_4n3=log10(PUFAs_p2$stearidonate_18_4n3)


PUFAs_p2.1=melt(PUFAs_p2,id.var=c("Row.names","ibd_Diagnosis"))

my_comparisions=list(  c("1_Control","2_UC"), c("3_CD","2_UC"),c("3_CD","1_Control"))

ggplot(PUFAs_p2.1, aes(ibd_Diagnosis,value, fill=ibd_Diagnosis)) + geom_violin(alpha=0.8) + geom_jitter(height = 0, width = 0.1, alpha=0.4) + geom_boxplot(width=0.1, fill="white") + theme_bw() + xlab("Clusters")  + scale_fill_manual(values =c("gray80","steelblue2","firebrick3" )) + facet_wrap(variable~., ncol=2) + stat_compare_means(comparisons = my_comparisions, method = "wilcox.test", p.adjust.methods="bonferroni",label="p.signif") 


flag=1
for (a in 3:ncol(PUFAs_p2)){
  x=pairwise.wilcox.test(PUFAs_p2[,a],PUFAs_p2$ibd_Diagnosis, p.adjust.method = "none")$p.value
  ccb=data.frame("Feature"=colnames(PUFAs_p2)[a],"Control_UC"=x[1,1], "Control_CD"=x[2,1],"CD_UC"=x[2,2])
  if(flag==1){
    pufas=ccb
    flag=7
  }else{
    pufas=rbind(pufas,ccb)
  }
}

#Stratify CD by ileum inflammation and/or ileum resection 
pufas_pheno=subset(ibd_test_phenos,ibd_test_phenos$clinical_Diagnosis!="IBDU")

pufas_pheno=pufas_pheno[, c("clinical_ActiveDisease","clinical_Diagnosis")]
pufas_pheno$clinical_Diagnosis=as.character(pufas_pheno$clinical_Diagnosis)
pufas_pheno$clinical_ActiveDisease[is.na(pufas_pheno$clinical_ActiveDisease)]="NotActive"
pufas_pheno$Active=paste(pufas_pheno$clinical_Diagnosis,pufas_pheno$clinical_ActiveDisease,sep="_")

pufas_pheno$clinical_Diagnosis[pufas_pheno$Active=="UC_NotActive"]="2_UC_NotActive"
pufas_pheno$clinical_Diagnosis[pufas_pheno$Active=="UC_Active"]="3_UC_Active"
pufas_pheno$clinical_Diagnosis[pufas_pheno$Active=="CD_NotActive"]="4_CD_NotActive"
pufas_pheno$clinical_Diagnosis[pufas_pheno$Active=="CD_Active"]="5_CD_Active"

row.names(PUFAs_p2)=PUFAs_p2$Row.names
PUFAs_p2$Row.names=NULL

PUFAs_p3=merge(pufas_pheno,PUFAs_p2,by="row.names", all.y=T)
PUFAs_p3$clinical_Diagnosis[is.na(PUFAs_p3$clinical_Diagnosis)]="1_Controls"
PUFAs_p3$clinical_ActiveDisease=NULL
PUFAs_p3$Active=NULL
PUFAs_p3$ibd_Diagnosis=NULL

PUFAs_p3.1=melt(PUFAs_p3,id.var=c("Row.names","clinical_Diagnosis"))


my_comparisions=list(  c("1_Controls","2_UC_NotActive"), c("5_CD_Active","4_CD_NotActive"),c("2_UC_NotActive","3_UC_Active"), c("1_Controls","4_CD_NotActive"))

ggplot(PUFAs_p3.1, aes(clinical_Diagnosis,value, fill=clinical_Diagnosis)) + geom_violin(alpha=0.8) + geom_jitter(height = 0, width = 0.1, alpha=0.4) + geom_boxplot(width=0.1, fill="white") + theme_bw() + xlab("Clusters")  + scale_fill_manual(values =c("gray80","lightblue","steelblue2","salmon","firebrick3" )) + facet_wrap(variable~., ncol=2) + stat_compare_means(comparisons = my_comparisions, method = "wilcox.test", p.adjust.methods="bonferroni",label="p.signif") 


flag=1
for (a in 3:ncol(PUFAs_p3)){
  x=pairwise.wilcox.test(PUFAs_p3[,a],PUFAs_p3$clinical_Diagnosis, p.adjust.method = "none")$p.value
  ccb=data.frame("Feature"=colnames(PUFAs_p3)[a],"Control_UC_NoActive"=x[1,1], "Control_UC_active"=x[2,1],"Control_CD_NoActive"=x[3,1], "Control_CD_Active"=x[4,1], "UC_NotActive_vs_Active"=x[2,2],"UC_not_Active_vs_CD_NoActive"=x[3,2],"UC_not_Active_vs_CD_Active"=x[4,2], "UC_Active_vs_CD_NoActive"=x[3,3],"UC_Active_vs_CD_Active"=x[4,3],"CD_not_Active_vs_CD_Active"=x[4,4])
  if(flag==1){
    pufas2=ccb
    flag=7
  }else{
    pufas2=rbind(pufas2,ccb)
  }
}


pufas_comb=cbind(pufas,pufas2)
pufas_comb=pufas_comb[,-5]
pufas_comb=melt(pufas_comb)
pufas_comb$FDR=p.adjust(pufas_comb$value, method = "BH")
pufas_comb=dcast(pufas_comb, formula=Feature~variable, value.var="FDR")

write.table(pufas_comb, "~/Desktop/Metabolomics_v2/7.Supplmentary_tables/PUFAS_fdr.txt", sep = "\t", quote = F)

pufas_comb=cbind(pufas,pufas2)
pufas_comb=pufas_comb[,-5]
pufas_comb=melt(pufas_comb)
pufas_comb$FDR=p.adjust(pufas_comb$value, method = "bonferroni")
pufas_comb=dcast(pufas_comb, formula=Feature~variable, value.var="FDR")

```



14. Prediction Models
===

a) Untargetted metaboites predicting IBD
b) Untargetted metabolites predicting CD vs non-CD
c) Untargetted metabolites predicting UC vs non-UC
d) SCFA predicting IBD
e) SCFA predicting CD
f) SCFA predicting UC
g) Compare models: [basic phenos + biomarkers] vs [phenos + biomarkers + taxa] vs [phenos + biomarkers + SCFA] + vs [phenos + biomarkers + Metabolites]  


```{r}





```





15. Genomic vs metabolomics
===

```{r}

##Check GWAS at: https://github.com/GRONINGEN-MICROBIOME-CENTRE/Groningen-Microbiome/tree/master/Projects/Fecal_metabolome_IBD/Metabolites_GWAS
## By Shixian Hu

#Import PCAs

genetic_IDs=read.table("~/Desktop/Metabolomics_v2/3.Preliminary_results/5.Genetics/All.coupling.txt", row.names = 1)
IBD_pca=read.table("~/Desktop/Metabolomics_v2/3.Preliminary_results/5.Genetics/IBD.pca.txt", row.names = 1, header = T)
LLD_pca=read.table("~/Desktop/Metabolomics_v2/3.Preliminary_results/5.Genetics/LLD.pca.txt", row.names = 2, header=T)

IBD_pca2=merge(genetic_IDs,IBD_pca,by="row.names")
row.names(IBD_pca2)=IBD_pca2$V2
IBD_pca2$V2=NULL
IBD_pca2$Row.names=NULL
IBD_pca2$IID=NULL


################################################################
### TEST within IBD PCA - Metabolite associations prevalence ###
################################################################

regressors=ibd_test_phenos[,c(1,2,3,4,7,8,35)]
mtb=ibd_test_phenos[,c(348:ncol(ibd_test_phenos))]

#colnames(bcg_fil_trans2)=make.names(colnames(bcg_fil_trans2))

ibd_test_phenos3=merge(regressors,IBD_pca2, by="row.names")
rownames(ibd_test_phenos3)=ibd_test_phenos3$Row.names
ibd_test_phenos3$Row.names=NULL

ibd_test_phenos3=merge(ibd_test_phenos3,mtb, by="row.names")
rownames(ibd_test_phenos3)=ibd_test_phenos3$Row.names
ibd_test_phenos3$Row.names=NULL

ibd_test_phenos3$clinical_BowelMovementADayDef.1=NULL

flag=1
for ( i in 1:28) {
  my_pheno=colnames(ibd_test_phenos3)[i]
  if (my_pheno=="clinical_BowelMovementADayDef" | my_pheno=="LC.COLUMN" | my_pheno=="host_BMI"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 29:ncol(ibd_test_phenos3)){
      my_trait=colnames(ibd_test_phenos3)[a]
      my_uni_test=ibd_test_phenos3[,c("host_Sex","host_Age","clinical_BowelMovementADayDef","host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age","clinical_BowelMovementADayDef", "host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      #my_uni_test[,8]=as.numeric(as.character(my_uni_test[,8]))
      my_samples=nrow(my_uni_test)
      my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
        my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
        my_univariate_results=my_lm_pheno
        flag=5
      }
    }
  }
}

associations_pca_mtb=my_univariate_results
associations_pca_mtb=subset(associations_pca_mtb, associations_pca_mtb$phenotype!="X12_or_13_methylmyristate_a15_0_or_i15_0")
associations_pca_mtb$FDR=p.adjust(associations_pca_mtb$`Pr(>|t|)`,method = "BH")
associations_pca_mtb$Bonferroni=p.adjust(associations_pca_mtb$`Pr(>|t|)`,method = "bonferroni")



################################################################
### TEST within CNT PCA - Metabolite associations prevalence ###
################################################################

regressors=controls_phenos[,c(1:7)]
mtb=controls_phenos[,c(356:ncol(controls_phenos))]

#colnames(bcg_fil_trans2)=make.names(colnames(bcg_fil_trans2))

cnt_test_phenos3=merge(regressors,LLD_pca, by="row.names")
rownames(cnt_test_phenos3)=cnt_test_phenos3$Row.names
cnt_test_phenos3$Row.names=NULL

cnt_test_phenos3=merge(cnt_test_phenos3,mtb, by="row.names")
rownames(cnt_test_phenos3)=cnt_test_phenos3$Row.names
cnt_test_phenos3$Row.names=NULL

cnt_test_phenos3$FID=NULL

flag=1
for ( i in 1:27) {
  my_pheno=colnames(cnt_test_phenos3)[i]
  if (my_pheno=="clinical_BowelMovementADayDef" | my_pheno=="LC.COLUMN" | my_pheno=="host_BMI"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 28:ncol(cnt_test_phenos3)){
      my_trait=colnames(cnt_test_phenos3)[a]
      my_uni_test=cnt_test_phenos3[,c("host_Sex","host_Age","clinical_BowelMovementADayDef","host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age","clinical_BowelMovementADayDef", "host_BMI","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      #my_uni_test[,8]=as.numeric(as.character(my_uni_test[,8]))
      my_samples=nrow(my_uni_test)
      my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
        my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
        my_univariate_results=my_lm_pheno
        flag=5
      }
    }
  }
}

associations_pca_mtb_CNT=my_univariate_results
#associations_pca_mtb_CNT=subset(associations_pca_mtb_CNT, associations_pca_mtb_CNT$phenotype!="X12_or_13_methylmyristate_a15_0_or_i15_0")
associations_pca_mtb_CNT$FDR=p.adjust(associations_pca_mtb_CNT$`Pr(>|t|)`,method = "BH")
associations_pca_mtb_CNT$Bonferroni=p.adjust(associations_pca_mtb_CNT$`Pr(>|t|)`,method = "bonferroni")

write.table(associations_pca_mtb_CNT,"~/Desktop/Metabolomics_v2/3.Preliminary_results/5.Genetics/Correlation_PCA_MTB_controls.txt", sep = "\t", quote = F)
write.table(associations_pca_mtb,"~/Desktop/Metabolomics_v2/3.Preliminary_results/5.Genetics/Correlation_PCA_MTB_IBD.txt", sep = "\t", quote = F)
```




















