---
title: "Metabolites_analysis_v3"
author: "Arnau Vich"
date: "4/14/2020"
output: html_document
---

Introduction
===

Untargeted metabolomics
---

In this project we aim to investigate the relation between fecal metabolites and inflammatory bowel diseases phenotypes. The cohort consist of 750 samples of different patients, devided in 255 controls from the population cohort LifeLines (NL), 270 patients with Crohns disease and 211 patients with ulcerative colitis from the 1000IBD cohort (NL). 

Metabolites were measured using METABOLON platform combining untargeted metabolite detection with short chain fatty acids measurments. Untargeted metabolite detection consisted on an ultrahigh performance liquid chromatography tandem mass spectrocopy (UPLC-MS/MS): 2 acidic positive ion condition (C18 columns) + 1 Basic negative ion optimazed (C18 column) + 1 Basic negative ionization (Hilic column).

Metabolites will be combined with the following data layers: matching shot-gun sequencing metagenomics (from the same sample), host phenotypes at time of sampling (including disease phenotypes), diet (food frequency questionnaires) & host genetics (GSA and WES data). 


SCFA quantification [METABOLON description]
---

Human feces samples are analyzed for eight short chain fatty acids: acetic acid (C2), propionic acid (C3), isobutyric acid (C4), butyric acid (C4), 2-methyl-butyric acid (C5), isovaleric acid (C5), valeric acid (C5) and caproic acid (hexanoic acid, C6) by LC-MS/MS.


Human feces samples are spiked with stable labelled internal standards and are homogenized and subjected to protein precipitation with an organic solvent. 

The peak area of the individual analyte product ions is measured against the peak area of the product ions of the corresponding internal standards. Quantitation is performed using a weighted linear least squares regression analysis generated from fortified calibration standards prepared immediately prior to each run.


The QC Endogenous was prepared from a single lot of human stool. All analytes are at the endogenous level except hexanoic acid, which was spiked in due to low levels in this lot. The other three levels of QC were prepared by spiking phosphate buffered saline (PBS) with all analytes to achieve the appropriate concentrations for each level.


Sample analysis was carried out in a 96-well plate format containing two calibration curves and eight QC samples (per plate) to monitor assay performance. Twelve batches were prepared and analyzed.


Precision was evaluated using the corresponding QC replicates in the sample runs. QCs met acceptance criteria at all levels for all analytes (Targeted acceptance criteria: at least 50% of QC samples at each concentration level per analyte should be within ±20.0% of the running mean, and at least 2/3 of all QC samples per analyte should fall within ±20.0% of the corresponding running mean.).


A total of 750 human stool samples were analyzed.
Analyte concentrations that fell below and above the limit of quantitation are extrapolated, and the reported values given a comment of BLOQ or ALOQ, respectively. 

Analytes that cannot be extrapolated below the limit of quantitation are considered not quantifiable and are noted as N/Q. Samples that did not have sufficient quantity are noted as QNS.


Load libraries
---

```{r, warning=F,message=FALSE, echo=TRUE}
library(corrplot)
library(plotly)
library(pheatmap)
library(NbClust)
library(reshape2)
library(ggrepel)
library(dplyr)
library(eulerr)
library(vegan)
library(ape)
library(ggridges)
library (UpSetR)
library(ggplot2)
library(psych)
library(ggord)
library(mice)
library(caret)
library(factoextra)
library(Rtsne)
library(heatmaply)
library(ggpubr)
library(ggbiplot)
library(coin)
library(DT)
library(pvclust)
library(compositions)
library(RColorBrewer)
library (ggvegan)
library (VIM)
```

Create functions
---

```{r}
####################################
#Inverse rank transformation function.
####################################

invrank= function(x) {qnorm((rank(x,na.last="keep")-0.5)/sum(!is.na(x)))}

###############################
#negate in (to exclude columns)
###############################

`%ni%` <- Negate(`%in%`)

#####################################
#Imputation and filtering metabolites
#####################################

impute_missing_values=function(x, samples_row=T, method="knn", missing_filter=0){
  #if samples are in columns transpose
  if (!samples_row){
    x=as.data.frame(t(x))
  } 
  #Exclude/keep columns that pass the missigness threshold
  if (missing_filter>1){
    stop("\n Hey! \n Values should be a proportion of missing values allowed per column: a value from 0 to 1") 
  }
  col_ori=ncol(x)
  col_keep=colnames(x)[colSums(!is.na(x))/nrow(x)>missing_filter]
  x=x[,col_keep]
  my_num_removed=col_ori-ncol(x)
  warning (paste(my_num_removed, "columns removed due to many missing values"))
  if (method=="zero"){
    x[is.na(x)]=0
  }
  else if (method=="min"){
    x[sapply(x, is.numeric)] <- lapply(x[sapply(x, is.numeric)], function(a) ifelse(is.na(a), min(a, na.rm = TRUE), a))
  }
  else if (method=="hfmin"){
    x[sapply(x, is.numeric)] <- lapply(x[sapply(x, is.numeric)], function(a) ifelse(is.na(a), min(a, na.rm = TRUE)/2, a))
  }
  else if (method=="mean"){
    x[sapply(x, is.numeric)] <- lapply(x[sapply(x, is.numeric)], function(a) ifelse(is.na(a), mean(a, na.rm = TRUE), a))
  }
  else if (method=="median"){
    x[sapply(x, is.numeric)] <- lapply(x[sapply(x, is.numeric)], function(a) ifelse(is.na(a), median(a, na.rm = TRUE), a))
  }
  else if (method=="knn"){
    x=kNN(x,k=10,metric = "euclidean", imp_var = F)
  }
  else if (method=="none"){
    x=x
  }
  else{
    stop("\n Hey! \n Method parameters for imputing missing values per column are: \n min -> min (col), hfmin -> min(col)/2, mean -> mean (col), median -> median(col), mice -> using mice package [Multivariate Imputation By Chained Equations] defaults \n")
  }
  return(as.data.frame(x))
}


##############################
# Summary stats
##############################

summary_stats=function(feature_matrix,pheno){
  a=1
  num_var=length(levels(pheno[,1]))
  print (paste("Number of phenotypes detected for summary statistics:", num_var))
  summary_met=matrix(nrow=ncol(feature_matrix),ncol=(9*(num_var+1))+1)
  for (i in 1:ncol(feature_matrix)){
    #print (colnames(feature_matrix)[i])
    pos=2
    summary_met[i,pos]=sum(is.na(feature_matrix[,i]))
    pos=pos+1
    summary_met[i,pos]=sum(!is.na(feature_matrix[,i]))
    if (sum(is.na(feature_matrix[,i]) == nrow(feature_matrix))){
      pos=pos+1
      summary_met[i,pos]="NA"
      pos=pos+1
      summary_met[i,pos]="NA"
      pos=pos+1
      summary_met[i,pos]="NA"
      pos=pos+1
      summary_met[i,pos]="NA"
      pos=pos+1
      summary_met[i,pos]="NA"
      pos=pos+1
      summary_met[i,pos]="NA"
      pos=pos+1
      summary_met[i,pos]="NA"
    }
    else{
      pos=pos+1
      summary_met[i,pos]=min(feature_matrix[,i], na.rm = T)
      pos=pos+1
      summary_met[i,pos]=max(feature_matrix[,i], na.rm = T)
      pos=pos+1
      summary_met[i,pos]=mean(feature_matrix[,i], na.rm = T)
      pos=pos+1
      summary_met[i,pos]=median(feature_matrix[,i], na.rm = T)
      pos=pos+1
      summary_met[i,pos]=sd(feature_matrix[,i], na.rm = T)
      pos=pos+1
      summary_met[i,pos]=length(boxplot(feature_matrix[,i], plot=FALSE, range = 3)$out)
      if (sum(!is.na(feature_matrix[,i])) < 10){
        pos=pos+1
        summary_met[i,pos]="NA"
        } else {
        nor=shapiro.test(feature_matrix[,i])
        pos=pos+1
        summary_met[i,pos]=nor$p.value>=0.05
      }
    }
    for (x in levels (pheno[,1])){
      id_list=rownames(pheno)[pheno[,1]==x]
      tmp_all=feature_matrix[rownames(feature_matrix)%in%id_list,]
      pos=pos+1
      summary_met[i,pos]=sum(is.na(tmp_all[,i]))
      pos=pos+1
      summary_met[i,pos]=sum(!is.na(tmp_all[,i]))
      if (sum(is.na(tmp_all[,i]) == nrow(tmp_all))){
        pos=pos+1
        summary_met[i,pos]="NA"
        pos=pos+1
        summary_met[i,pos]="NA"
        pos=pos+1
        summary_met[i,pos]="NA"
        pos=pos+1
        summary_met[i,pos]="NA"
        pos=pos+1
        summary_met[i,pos]="NA"
        pos=pos+1
        summary_met[i,pos]="NA"
        pos=pos+1
        summary_met[i,pos]="NA"
      }else{
        pos=pos+1
        summary_met[i,pos]=min(tmp_all[,i], na.rm = T)
        pos=pos+1 
        summary_met[i,pos]=max(tmp_all[,i], na.rm = T)
        pos=pos+1 
        summary_met[i,pos]=mean(tmp_all[,i], na.rm = T)
        pos=pos+1
        summary_met[i,pos]=median(tmp_all[,i], na.rm = T)
        pos=pos+1 
        summary_met[i,pos]=sd(tmp_all[,i], na.rm = T)
        pos=pos+1 
        summary_met[i,pos]=length(boxplot(tmp_all[,i], plot=FALSE, range = 3)$out)
        if (sum(!is.na(tmp_all[,i])) < 10){
          pos=pos+1 
          summary_met[i,pos]="NA"
          } else {
          nor=shapiro.test(tmp_all[,i])
          pos=pos+1 
          summary_met[i,pos]=nor$p.value>=0.05
          }
        }
      }
    }
  summary_met[,1]=colnames(feature_matrix)
  my_colnames=c("Metabolite", "NAs","Non_NAs", "Min", "Max", "Mean", "Median","SD", "Outliers_x3IQR","Normal_distrib")
  for (o in levels (pheno[,1])){
    my_colnames=c(my_colnames,paste("NAs",o, sep="_"))
    my_colnames=c(my_colnames,paste("Non_NAs",o,sep="_"))
    my_colnames=c(my_colnames,paste("Min",o,sep="_"))
    my_colnames=c(my_colnames,paste("Max",o,sep="_"))
    my_colnames=c(my_colnames,paste("Mean",o,sep="_"))
    my_colnames=c(my_colnames,paste("Median",o,sep="_"))
    my_colnames=c(my_colnames,paste("SD",o,sep="_"))
    my_colnames=c(my_colnames,paste("Outliers_x3IQR",o,sep="_"))
    my_colnames=c(my_colnames,paste("Normal_distrib",o,sep="_"))
  }
  colnames(summary_met)=my_colnames
  return(summary_met)
}  



###############################################
# Filtering and transforming taxa             #
###############################################

transform_and_filter_taxa=function(x, samples_row=T, method="asin", missing_filter=0){
  x[x=="NA"]=0
  x[x=="NaN"]=0
  #if samples are in columns transpose
  if (!samples_row){
  
    x=as.data.frame(t(x))
  
  } 
  #Exclude/keep columns that pass the missigness threshold
  if (missing_filter>100){
  
    stop("\n Hey! \n Values should be a proportion of missing values allowed per column: a value from 0 to 100") 
  
  }
  
  x_filt=x[,((colSums(x !=0) / nrow(x)) *100 )>missing_filter]
  my_num_removed=ncol(x)-ncol(x_filt)
  print (paste(my_num_removed, "species removed due to many missing values"))
  
  if (method=="asin"){

    x_filt=x_filt/100
    x_filt=asin(sqrt(x_filt))

  } else if (method=="log"){
    
    #replace 0 by the half of the smallest value observed
    my_min=min(x_filt[x_filt>0]/2)
    x_filt=x_filt+my_min
    x_filt=log10(x_filt)

  }else if (method=="clr"){
  
    x_filt=x_filt/100
    #replace 0 by the half of the smallest value observed
    my_min=min(x_filt[x_filt>0]/2)
    x_filt=x_filt+my_min
    d <- t(apply(x_filt, 1, function(b) {
      my_mean=exp(sum(log(b))/length(b))
      log(b/my_mean)
    }))
    x_filt=d
  
  }
  return(as.data.frame(x_filt))
}



###############################################
# Calculate rations                           #
###############################################


calculate_all_ratios=function(x,is_log=T,feature_in_column=T){
  print (paste("Number of features detected:",ncol(x)))
  print (paste("Number of ratios being computed:", (ncol(x)*(ncol(x)-1))))
  if(feature_in_column=F){
    x=as.data.frame(t(x))
  }
  for (a in 1:ncol(x)-1){
    for (b in (a+1):ncol(x)){
      my_ratio=paste(colnames(x)[a],colnames(x)[b], sep = "_vs_")
      
    }
  }
}





```


1. Import data
===

a) Metabolites: Here we use both raw values provided by Metabolon (metabolites AUC).


b) Short Chain Fatty Acids (SFCA): Together with the untargetted metabolite assessment, SCFA concentrations were measured in the same fecal samples (μg/g)


c) Host phenotypes: Information about the host (age,sex,BMI, diet, etc.). This consist of 3 files: phenotypes shared and used for the case-control analysis, phenotypes specific for the population controls & phenotypes specific for cases (disease location, activity, etc.)


d) Experiment variables: Different technical variables from the untargetted metabolic experiments. We will use this information as a potential counfounding factors. 


e) Genetics. 


f) Metagenomics taxa: MetaPhlan's profiles (v2.7)


g) Pathway annotation provided by Metabolon


h) ID's for each data modality: Allows to combine different datasets / information 

```{r, warning, message=F, echo=T}
#transformed metabolites (raw data transformed to adjust distrubution, medians = 1)
#all_metabolites <- read.delim("~/Documents/Project_Metabolome/1.Input_files/all_metabolites2.txt", row.names=1)

# a) Raw values (AUC of peaks)

all_metabolites_raw <- read.delim("~/Documents/Project_Metabolome/1.Input_files/all_metabolites_raw2.txt", row.names=1)

# b) SCFA

SCFA <- read.delim("~/Documents/Project_Metabolome/1.Input_files/old/SCFA.txt")

# c) Phenotypes

phenos_ibd=read.delim("~/Documents/Project_Metabolome/1.Input_files/Merged_IBD_phenos_clean_v2.txt",row.names = 1)
phenos_lld=read.delim("~/Documents/Project_Metabolome/1.Input_files/Merged_LLD_phenos_clean_v2.txt", row.names=1)
cc_pheno=read.delim("~/Documents/Project_Metabolome/1.Input_files/case_control_meta_v1.txt", row.names=1)

# d) Experiment variables 

my_batch=read.delim("~/Documents/Project_Metabolome/1.Input_files/Metabolon_preparation_v2.txt", row.names=1)


# e) Genetics


# f) Metagenomic taxa (add metagenomic genes/pathways)

#MetaPhlAn 2.7
#IBD_taxa <- read.delim("~/Documents/Project_Metabolome/2.taxa/IBD_taxonomy_unstrat_clean.txt", row.names=1)
#LLD_taxa <- read.delim("~/Documents/Project_Metabolome/2.taxa/LLD_taxonomy_unstrat_clean.txt", row.names=1)

#mOTUs2
my_taxa = read.delim("~/Documents/Project_Metabolome/2.taxa/mOTUs_prediction_v2.txt", row.names=1, check.names = F)

# g) Metabolites annotation
annot <- read.delim("~/Documents/Project_Metabolome/1.Input_files/info_metabolites_v2.txt", row.names=1)
annot$SUPER.PATHWAY.1=NULL


# h) ID's index (translate from different data modalities metabolomics <-> metagenomic <-> phenotypes)

IDs_LLD <- read.delim("~/Documents/Project_Metabolome/1.Input_files/IDs_LLD.txt", header=FALSE)
IDs_IBD <- read.delim("~/Documents/Project_Metabolome/1.Input_files/IDs_IBD.txt", header=FALSE)
```


Adjust all ids
---

__Translate all id's to the same id (easier to deal with multiple tables)__


```{r, warning=F,message=FALSE, echo=TRUE}

#Change Metabolon ids to UMCG ids to connect later to phenotypes 
all_raw=as.data.frame(t(all_metabolites_raw))

# Select IDs
IDs_IBD=IDs_IBD[,c(1,5)]
IDs_LLD$V2=NULL

# [IMPORTANT] Table with matching ids between UMCG and Metabolon
IDs=data.frame(rbind(as.matrix(IDs_IBD), as.matrix(IDs_LLD)))
rownames(IDs)=IDs$V1
IDs$V1=NULL

# Merge to replace the ids Metabolon => UMCG

all_new_ID_raw=merge(IDs,all_raw, by="row.names")
rownames(all_new_ID_raw)=all_new_ID_raw$V5
all_new_ID_raw$Row.names=NULL
all_new_ID_raw$V5=NULL

#Repeat for the batch information: Metabolon ID => UMCG ID

my_batch_id=merge(IDs,my_batch, by="row.names")
rownames(my_batch_id)=my_batch_id$V5
my_batch_id$Row.names=NULL
my_batch_id$V5=NULL

#In case that we use the transformed data provided by Metabolon

#all=as.data.frame(t(all_metabolites))
#all_new_ID=merge(IDs,all, by="row.names")
#row.names(all_new_ID)=all_new_ID$V5
#all_new_ID$V5=NULL
#all_new_ID$Row.names=NULL
#all_new_ID=all_new_ID[row.names(all_new_ID)%ni%remove_pouch_stoma,]
#all_new_ID_with_stoma=all_new_ID

```


2. Summary statistics
===


Annotation by METABOLON
---

Describe the categories of metabolites
---

```{r, warning=F,message=FALSE, echo=F}
met_2=as.data.frame(table(annot$SUPER.PATHWAY))
met_1=as.data.frame(table(annot$SUB.PATHWAY))

yy=ggplot(met_2, aes(x = reorder(Var1, -Freq),Freq)) + geom_bar(stat = "identity", color="black") + theme_classic() + theme(axis.title.x = element_blank(),axis.text.y = element_text(size = 12)) + coord_flip() + xlab("") + ylab("Number of metabolites")

ggplotly(yy)
```

```{r, warning=F,message=FALSE, echo=F,fig.height=20}
xx=ggplot(met_1, aes(x = reorder(Var1, -Freq),Freq)) + geom_bar(stat = "identity", color="black") + theme_classic() + theme(axis.title.x = element_blank(),axis.text.y = element_text(size = 5)) + coord_flip() + xlab("") + ylab("Number of metabolites")

ggplotly(xx)
```


Remove participants with a pouch or stoma
---

__Rational: Patients with pouch or stoma do not capture the colonic metabolite/microbiota profile__

```{r}
remove_pouch_stoma=rownames(phenos_ibd)[phenos_ibd$ibd_CurrentStomaOrPouch=="yes"]
#Keep data of the participants with stoma
all_new_ID_raw_with_stoma=all_new_ID_raw
#Remove
all_new_ID_raw=all_new_ID_raw[row.names(all_new_ID_raw)%ni%remove_pouch_stoma,]
cc_pheno=cc_pheno[row.names(cc_pheno)%ni%remove_pouch_stoma,]
print (paste("Number of samples excluded due to pouch or stoma:", length(remove_pouch_stoma)))
```


Summary stats per metabolite per cohort
---

```{r, echo=T, message=F, warning=F}

#Raw data
select=cc_pheno[,1, drop=F]
summary_met=summary_stats(all_new_ID_raw,select)
summary_met=as.data.frame(summary_met)
#write.table(summary_met, "~/Documents/Project_Metabolome/4.Summary_stats/Metabolites_summary_2020.txt", sep = "\t", quote = F)
```


__Check prevalence per phenotype__

```{r, echo=T, message=F, warning=F}
summary_short=summary_met[,c("Metabolite", "Non_NAs")]
summary_short2=summary_met[,c("Metabolite","Non_NAs","Non_NAs_Control","Non_NAs_CD", "Non_NAs_UC")]
summary_short2$prevalence_all=((as.numeric(as.character(summary_short2$Non_NAs))/nrow(all_new_ID_raw))*100)
summary_short2$prevalence_Control=((as.numeric(as.character(summary_short2$Non_NAs_Control))/length(select[select$ibd_Diagnosis=="Control",])*100))
summary_short2$prevalence_CD=((as.numeric(as.character(summary_short2$Non_NAs_CD))/length(select[select$ibd_Diagnosis=="CD",])*100))
summary_short2$prevalence_UC=((as.numeric(as.character(summary_short2$Non_NAs_UC))/length(select[select$ibd_Diagnosis=="UC",])*100))
summary_short2$Non_NAs=NULL
summary_short2$Non_NAs_Control=NULL
summary_short2$Non_NAs_CD=NULL
summary_short2$Non_NAs_UC=NULL
summary_short2[,-1] <-round(summary_short2[,-1],0)
summary_short3=melt(summary_short2)
```

__Presence of each metabolite per sample__

```{r, echo=F}
aa=ggplot(summary_short, aes(reorder(Metabolite,-as.numeric(as.character(Non_NAs))),as.numeric(as.character(Non_NAs))))+ geom_bar(color="darkblue",stat = "identity") + theme_classic() + ylab("Number of samples (n=750)") + xlab("Metabolites") +  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())

ggplotly(aa)
```

__Percentage of prevalence of metabolites per cohort__

```{r, echo=F}
bb=ggplot(summary_short3, aes(value, fill=variable)) + geom_histogram(position = "dodge", bins = 10, binwidth = 7, color="black") + theme_bw() + scale_fill_manual(values = c("grey79","white","blue2", "firebrick2")) + ylab("Number of metabolites") + xlab("% presence in samples")

ggplotly(bb)
```

__Prevalence/Missigness per metabolite per cohort with annotations__

```{r, echo=F}
summary_short4=summary_short2
rownames(summary_short4)=summary_short4$Metabolite
summary_short4$Metabolite=NULL
summary_short4=merge(annot,summary_short4, by="row.names")
rownames(summary_short4)=summary_short4$Row.names
summary_short4$Row.names=NULL
colnames(summary_short4)=c("Super pathway","Annotation", "Detected in cohort (%)", "Detected in controls (%)", "Detected in CD (%)", "Dectected in UC (%)")
datatable(summary_short4)
#write.table(summary_short4, "~/Documents/Project_Metabolome/4.Summary_stats/Metabolites_prevalence_short_2020.txt", sep = "\t", quote = F)
```


__Number of metabolites per samples__

```{r, warning=F,message=FALSE, echo=TRUE}

all_new_ID_raw2=as.data.frame(t(all_new_ID_raw))
summary_sample=matrix(nrow=ncol(all_new_ID_raw2), ncol=3)

for (i in 1:ncol(all_new_ID_raw2)){
  summary_sample[i,2]=sum(is.na(all_new_ID_raw2[,i]))
  summary_sample[i,3]=sum(!is.na(all_new_ID_raw2[,i]))
}

summary_sample[,1]=colnames(all_new_ID_raw2)
summary_sample=as.data.frame(summary_sample)
colnames(summary_sample)=c("Metabolite", "NAs","Non_NAs")
summary_sample$perc_detected=((as.numeric(as.character(summary_sample$Non_NAs))/nrow(all_new_ID_raw2))*100)
rownames(summary_sample)=summary_sample$Metabolite
summary_sample$Metabolite=NULL
summary_sample2=merge(summary_sample,cc_pheno,by="row.names")
#write.table(summary_sample, "~/Documents/Project_Metabolome/4.Summary_stats/Metabolites_per_sample_2020.txt", sep = "\t", quote = F)

```


```{r, echo=F}
cc=ggplot(summary_sample2, aes(perc_detected, fill=ibd_Diagnosis)) + geom_histogram(position = "dodge", bins = 100, binwidth = 7, color="black") + theme_bw() + scale_fill_manual(values = c("firebrick2","white","grey42","blue2")) + ylab("Number of samples") + xlab("% detected metabolites")

ggplotly(cc)
```


__Summary statistics microbiome__

1. Focus only at species taxa level


2. Filter out taxa present in less than 20% of all samples


```{r, warning=F,message=FALSE, echo=T}

##Taxa predicted from MetaPhlAn 2.7###

######################################
#Clean names
#LLD_sp=LLD_taxa[grep("s__", rownames(LLD_taxa)), ]
#IBD_sp=IBD_taxa[grep("s__", rownames(IBD_taxa)), ]
#LLD_sp=LLD_sp[!grepl("t__", rownames(LLD_sp)), ]
#IBD_sp=IBD_sp[!grepl("t__", rownames(IBD_sp)), ]
#row.names(LLD_sp)=gsub(".*s__","",row.names(LLD_sp))
#row.names(IBD_sp)=gsub(".*s__","",row.names(IBD_sp))
#Merge
#taxa=as.data.frame(t(merge(IBD_sp,LLD_sp, by="row.names")))
#taxa=merge(IBD_sp,LLD_sp, by="row.names")
#row.names(taxa)=taxa$Row.names
#taxa$Row.names=NULL
##########################################

##Taxa predicted from mOTUS 2###
taxa=my_taxa[unlist(lapply(rownames(my_taxa),function(x) length(unlist(strsplit(x, "|", fixed=TRUE)))==7)),]


#Remove samples that miss microbiome data: IBDFEC0535, IBDFEC1024,IBDFEC0515
taxa=taxa[, colSums(taxa != 0) > 0]
taxa=as.data.frame(t(taxa))

my_shannon=as.data.frame(diversity(taxa, index="shannon"))
colnames(my_shannon)=c("Shannon_Index")
my_simpson=as.data.frame(diversity(taxa, index="simpson"))
colnames(my_simpson)=c("Simpson_Index")
richness_microbiota=merge(my_shannon,my_simpson,by="row.names")
rownames(richness_microbiota)=richness_microbiota$Row.names
richness_microbiota$Row.names=NULL
richness_microbiota2=subset(richness_microbiota,rownames(richness_microbiota) %in% rownames(summary_sample))
cc_pheno2=merge(richness_microbiota2,cc_pheno,by="row.names", all = T)
rownames(cc_pheno2)=cc_pheno2$Row.names
cc_pheno2$Row.names=NULL
```

__Microbial richness indexes (Shannon & Simpson)__

```{r, echo=F}
ggplot(cc_pheno2, aes(ibd_Diagnosis,Shannon_Index, fill=ibd_Diagnosis)) + theme_bw() + geom_violin() + geom_violin() + geom_boxplot(width=0.1,position=position_dodge(1), alpha=0.4) + scale_fill_manual(values = c("firebrick2","white","grey42","blue2"))


ggplot(cc_pheno2, aes(ibd_Diagnosis,Simpson_Index, fill=ibd_Diagnosis)) + theme_bw() + geom_violin() + geom_violin() + geom_boxplot(width=0.1,position=position_dodge(1), alpha=0.4) + scale_fill_manual(values = c("firebrick2","white","grey42","blue2"))
```


__Filter bacteria (detection in >20% of the samples) and normalization__


```{r}

#Subset samples from the taxonomic table for which we also have metagenomics 
taxa2=subset(taxa,rownames(taxa) %in% rownames(summary_sample))

print (paste("Number of taxa detected:",ncol(taxa2)))

#Filter 20% and to clr transformation
taxa_filt=transform_and_filter_taxa(taxa2,samples_row = T,method = "clr",missing_filter = 20)

print (paste("Number of taxa after filtering",ncol(taxa_filt)))

#Merge taxa and phenotypes
cc_pheno3=merge(cc_pheno2,taxa_filt,by="row.names", all = T)
rownames(cc_pheno3)=cc_pheno3$Row.names
cc_pheno3$Row.names=NULL

```



3. Filter metabolites by missigness
===

__We remove metabolites that are present in less than 20% of the samples in the 3 cohorts (CD,UC,Controls)__


```{r,echo=F}

to_remove=subset(summary_short2,prevalence_Control<20 & prevalence_CD<20 & prevalence_UC<20)

print(paste("Number of metabolites removed:",length(to_remove$Metabolite)))
```

__Metabolites present in more than 70% of the samples will be analyzed quantitatively__

```{r,echo=F}

#to_keep=subset(summary_short2,prevalence_Control>70 & prevalence_CD>70 & prevalence_UC>70)
to_keep=subset(summary_short2,prevalence_all>70)
q_mtb=all_new_ID_raw[,colnames(all_new_ID_raw) %in%to_keep$Metabolite]
print(paste("Number of metabolites for quantitative analysis:",length(to_keep$Metabolite)))
```


__Metabolites that are present between 20% to 70% of the samples will be subset and transform to binary feature (present/absent)__

```{r,echo=F}
rest=c(list(to_remove$Metabolite),list(to_keep$Metabolite))
#mtb_logistic=subset(summary_short2,prevalence_Control>20 & prevalence_Control<70 & prevalence_UC>20 & prevalence_UC<70 & prevalence_CD>20 & prevalence_CD<70 )

a=droplevels(unlist(to_remove$Metabolite))
b=droplevels(unlist(to_keep$Metabolite))
c=c(levels(a),levels(b))

bi_mtb=all_new_ID_raw[,colnames(all_new_ID_raw) %ni% c]
bi_mtb[!is.na(bi_mtb)]=1
bi_mtb[is.na(bi_mtb)]=0

print(paste("Number of metabolites for presence/absence analysis:",length(colnames(bi_mtb))))
```




Normalize and impute missing metabolites
---

```{r, echo=T, message=F, warning=F}

q_mtb_t=as.data.frame(q_mtb)

#apply log10 transformation + scale
q_mtb_t=log10(q_mtb_t)

#scale date, mean =0 , sd =1
q_mtb_t <- as.data.frame(scale(q_mtb_t))

#Impute na's 
### WARNING: KNN imputation takes a while, take a nap or a coffee (in case of re-run save and load results of this stage)
q_mtb=impute_missing_values(q_mtb_t,samples_row = T, method = "knn", missing_filter = 0)
rownames(q_mtb)=row.names(q_mtb_t)
#write.table(q_mtb, "~/Documents/Project_Metabolome/1.Input_files/Imputed_metabolites_v2", sep = "\t",quote = F)

q_mtb=as.data.frame(q_mtb)
```

__Merge taxa and metabolites__

```{r, echo=F}
#Merge taxa and metabolites
taxa_and_mb=merge(taxa_filt,q_mtb,by="row.names")
rownames(taxa_and_mb)=taxa_and_mb$Row.names
taxa_and_mb$Row.names=NULL
```


__Summary statistics on transformed & filtered metabolites__

```{r, echo=F}
#Transformed data
summary_met_trans=summary_stats(q_mtb, select)
summary_met_trans=as.data.frame(summary_met_trans)
write.table(summary_met_trans, "~/Documents/Project_Metabolome/4.Summary_stats/Metabolites_summary_post_filtering_2020_v2", sep = "\t", quote = F)
```


4.Summary of SCFA
===

__Show SCFA names__

```{r, warning=F,message=FALSE, echo=TRUE}
unique(levels(SCFA$Analyte))
```

__Load data and replace values under the detection levels for missing values and restructure the data__

Original report contain 1 row per sample per measurment, we want to restructure in a way that all samples are in rows and each column is a SCFA.  


```{r, warning=F,message=FALSE, echo=TRUE}
#Duplicate original values (before remplacing for NA)

SCFA$ori_Result=SCFA$Result

#Replace values below level quantification (BLOQ) to NA
SCFA$Result[SCFA$Comment.1=="BLOQ"] = "N/Q"
SCFA$Result[SCFA$Result=="N/Q"] = NA
```

__Summary of the values under the detection levels (TRUE column)__

```{r}
table(SCFA$Analyte,is.na(SCFA$Result))
```


```{r, warning=F,message=FALSE, echo=TRUE}
#Remove unecessary columns (sample type, group/project name, detection limits and comments)

SCFAsub=SCFA[,c("Unique.Sample.ID...as.labeled.on.tube.","Sample.Amount..gram.","Comment","Analyte","Result")]
SCFA_table <- dcast(SCFAsub, ...~Analyte)

IDs=data.frame(rbind(as.matrix(IDs_IBD), as.matrix(IDs_LLD)))
rownames(SCFA_table)=SCFA_table$Unique.Sample.ID...as.labeled.on.tube.
SCFA_table$Unique.Sample.ID...as.labeled.on.tube.=NULL
rownames(IDs)=IDs$V1
IDs$V1=NULL
SCFA_new_ID=merge(IDs,SCFA_table, by="row.names")
SCFA_new_ID$Row.names=NULL
row.names(SCFA_new_ID)=SCFA_new_ID$V5
SCFA_new_ID$V5=NULL
colnames(SCFA_new_ID)=c("Amount_sample_gram", "Box", "Methylbutyric_acid", "acetic_acid", "butyric_acid", "hexanoic_acid", "isobutyric_acid","isovaleric_acid" ,"propionic_acid", "valeric_acid")
```

__Merge phenotypes to SCFA__

```{r, warning=F,message=FALSE, echo=TRUE}
SCFA2=SCFA_new_ID
SCFA2[,3:10]=sapply(SCFA2[,c(3:10)], function(x) log10(as.numeric(as.character(x))) )
SCFA_with_phenos=merge(SCFA_new_ID,cc_pheno3, by="row.names")
cc_pheno4=merge(SCFA2,cc_pheno3, by="row.names")

```


__Plot SCFA per diagnosis__

```{r, warning=F,message=FALSE, echo=T}
plot_SCFA=SCFA_with_phenos[,c("Row.names","ibd_Diagnosis","Methylbutyric_acid", "acetic_acid", "butyric_acid", "hexanoic_acid", "isobutyric_acid","isovaleric_acid" ,"propionic_acid", "valeric_acid")]

plot_SCFA_m=melt(plot_SCFA, id.vars = c("Row.names","ibd_Diagnosis"))
plot_SCFA_m=subset(plot_SCFA_m, plot_SCFA_m$ibd_Diagnosis!="IBDU")
plot_SCFA_m$diag=as.character(plot_SCFA_m$ibd_Diagnosis)
plot_SCFA_m$diag[plot_SCFA_m$ibd_Diagnosis=="Control"]="A_Control"
my_comparisions=list( c("CD","A_Control"), c("A_Control","UC"), c("CD","UC"))
```

```{r, warning=F,message=FALSE, echo=F, fig.height=15}
ggplot (plot_SCFA_m, aes (diag,log10(as.numeric(as.character(value))), fill=diag)) + geom_violin() + geom_boxplot(width=0.1,position=position_dodge(1), alpha=0.2) + facet_wrap(~ variable, nrow=2) + theme_bw() +scale_fill_manual(values=c("snow","firebrick2","blue2"))  + stat_compare_means(comparisons = my_comparisions, method = "wilcox.test") + ylab ("log10(SCFA µg/g)") + xlab ("Cohort") + scale_x_discrete(labels=c("(n=255)","(n=239)", "(n=176)"))
```

```{r, warning=F,message=FALSE, echo=T}

montreal= read.delim("~/Documents/Project_Metabolome/1.Input_files/only_montreal.txt", row.names=1)
rownames(plot_SCFA)=plot_SCFA$Row.names
plot_SCFA$Row.names=NULL
tkd_SCFA=merge(montreal,plot_SCFA,by="row.names")
tkd_SCFA_m=melt(tkd_SCFA, id.vars = c("Row.names","ibd_Diagnosis", "ibd_montreal_B","ibd_montreal_Bperianal","ibd_montreal_S" ))
tkd_SCFA_m=subset(tkd_SCFA_m, tkd_SCFA_m$ibd_Diagnosis!="IBDU")

tkd_SCFA_b=subset(tkd_SCFA_m, tkd_SCFA_m$ibd_Diagnosis!="UC")
tkd_SCFA_b=tkd_SCFA_b[complete.cases(tkd_SCFA_b$ibd_montreal_B), ]

my_comparisions=list(  c("B1","B2"), c("B2","B3"), c("Control","B3"),c("B1","B3"),c("Control","B2"))

ggplot (tkd_SCFA_b, aes (ibd_montreal_B,log10(as.numeric(as.character(value))), fill=ibd_montreal_B)) + geom_violin(na.rm = T) + geom_boxplot(width=0.1,position=position_dodge(1), alpha=0.2,na.rm = T) + facet_wrap(~ variable, nrow=2) + theme_bw() + stat_compare_means(comparisons = my_comparisions, method = "wilcox.test") + ylab ("log10(SCFA µg/g)") + xlab ("Cohort") + scale_x_discrete(labels=c("(n=129)","(n=76)", "(n=29)", "(n=255)")) +  scale_fill_manual(values=c("lightsalmon","tomato","red4","snow"))


tkd_SCFA_s=subset(tkd_SCFA_m, tkd_SCFA_m$ibd_Diagnosis!="CD")
tkd_SCFA_s=tkd_SCFA_s[complete.cases(tkd_SCFA_s$ibd_montreal_S), ]

my_comparisions=list(  c("Control","S0"), c("S0","S1"), c("S1","S2"), c("S2","S3"), c("Control","S1"),c("Control","S2"),c("Control","S3"))

ggplot (tkd_SCFA_s, aes (ibd_montreal_S,log10(as.numeric(as.character(value))), fill=ibd_montreal_S)) + geom_violin(na.rm = T) + geom_boxplot(width=0.1,position=position_dodge(1), alpha=0.2,na.rm = T) + facet_wrap(~ variable, nrow=2) + theme_bw() + stat_compare_means(comparisons = my_comparisions, method = "wilcox.test") + ylab ("log10(SCFA µg/g)") + xlab ("Cohort")  + scale_fill_manual(values=c("snow","lightcyan2","lightblue2","steelblue1","blue3"))


plot_SCFA_cal=SCFA_with_phenos[,c("Row.names","ibd_Diagnosis","ibd_FecalCalprotectinOver200yesno","Methylbutyric_acid", "acetic_acid", "butyric_acid", "hexanoic_acid", "isobutyric_acid","isovaleric_acid" ,"propionic_acid", "valeric_acid")]
plot_SCFA_cal=melt(plot_SCFA_cal, id.vars = c("Row.names","ibd_Diagnosis", "ibd_FecalCalprotectinOver200yesno"))
plot_SCFA_cal=subset(plot_SCFA_cal, plot_SCFA_cal$ibd_Diagnosis!="IBDU")
plot_SCFA_cal=plot_SCFA_cal[complete.cases(plot_SCFA_cal$ibd_FecalCalprotectinOver200yesno), ]
my_comparisions=list( c("no","yes"))

ggplot (plot_SCFA_cal, aes (ibd_FecalCalprotectinOver200yesno,log10(as.numeric(as.character(value))), fill=ibd_FecalCalprotectinOver200yesno)) + geom_violin() + geom_boxplot(width=0.1,position=position_dodge(1), alpha=0.2) + facet_wrap(ibd_Diagnosis~ variable , nrow=3) + theme_bw() +scale_fill_brewer(palette ="RdBu")  + stat_compare_means(comparisons = my_comparisions, method = "wilcox.test") + ylab ("log10(SCFA µg/g)")  

```



5.PCA analysis on metabolites present in more than 20% of the samples
===

```{r, warning=F,message=FALSE, echo=TRUE}
#filt_1=subset(summary_short2,prevalence_Control>20 | prevalence_UC>20 | prevalence_CD>20  )

#norm_filt=all_new_ID[,colnames(all_new_ID) %in%filt_1$Metabolite]
#norm_filt=q_mtb[,colnames(q_mtb) %in%filt_1$Metabolite]
norm_filt=q_mtb
pca_log= prcomp(norm_filt,scale. = T, center = T)
cmp_log=as.data.frame(pca_log$x[,1:5])
#cc_pheno2=read.delim("~/Documents/Project_Metabolome/1.Input_files/mini_pheno2.txt", row.names=1)
cmp_log2=merge(cc_pheno2,cmp_log,by="row.names")
v_exp = pca_log$sdev^2
prop_v_exp= data.frame( PC=1:length(v_exp),perc= 100*(v_exp / sum(v_exp)))

```



Percentage of variance explained per component
---

```{r}
prop_v_exp2=prop_v_exp[1:20,]
ggplot(prop_v_exp2, aes (PC,perc)) + geom_bar (stat="identity") + geom_text(aes(label=round(perc, 2)), size=3, vjust=-.5) + theme_bw() + xlab ("Principal components") + ylab ("% explained variance")
```


PC1 & PC2: Diagnosis
---

```{r}
ggplot(cmp_log2, aes(-PC1,PC2, color=ibd_Diagnosis)) + geom_point(size=2) + theme_bw() + scale_colour_manual(values =c("firebrick3","black","gold3" ,"steelblue2"))
```

PC2 & PC3: Diagnosis
---

```{r}
ggplot(cmp_log2, aes(PC2,PC3, color=ibd_Diagnosis)) + geom_point() + theme_bw() + scale_colour_manual(values =c("firebrick3","black","gold3" ,"steelblue2"))
```


Exploring different phenotypes
---

__PC1 & PC2: Bowel Movements a day__


```{r}
ggplot(cmp_log2, aes(-PC1,PC2, color=clinical_BowelMovementADayDef)) + geom_point() + theme_bw()
```


__PC1 & PC2: Bristol stool scale binary (soft vs hard)__


```{r}
ggplot(cmp_log2, aes(-PC1,PC2, color=clinical_BinaryBSS)) + geom_point() + theme_bw()
```



__PC1 & PC2: Number of months that the sample spend in the -80 freezer__


```{r}
ggplot(cmp_log2, aes(-PC1,PC2, color=metabolon_Month_in_freezer)) + geom_point() + theme_bw()
```



__PC1 & PC2:Activity__


```{r}
ggplot(cmp_log2, aes(-PC1,PC2, color=ibd_ActiveDisease)) + geom_point() + theme_bw() + scale_colour_manual(values=c("red2","gray32","blue2","snow"))
```




__PC1 & PC2: Food frequency: Sum of Carhydrates__


```{r}
ggplot(cmp_log2, aes(-PC1,PC2, color=diet_SUMOFKHTOT.Res)) + geom_point() + theme_bw() + scale_colour_viridis()
```


__PC1 & PC2: Food frequency: Sum of fat__


```{r}
ggplot(cmp_log2, aes(-PC1,PC2, color=diet_SUMOFVETTOT.Res)) + geom_point() + theme_bw() + scale_colour_viridis()
```


__PC1 & PC2: Food frequency: plant protein vs animal proten__


```{r}
ggplot(cmp_log2, aes(-PC1,PC2, color=diet_PlanttoAnimal)) + geom_point() + theme_bw() + scale_colour_viridis()
```



__PC1 & PC2: Montreal classifications__



```{r, warning=F, echo=F}
rownames(cmp_log2)=cmp_log2$Row.names
cmp_log2$Row.names=NULL
montreal=read.table("~/Documents/Project_Metabolome/1.Input_files/only_montreal.txt", sep = "\t", header = T, row.names = 1)
cmp_log3=merge(montreal,cmp_log2, by="row.names")
cmp_log4=cmp_log3[,c("Row.names","PC1","PC2","ibd_montreal_B","ibd_montreal_Bperianal","ibd_montreal_S","ibd_montreal_A","ibd_Montreal_L","ibd_MontrealE")]
cmp_log4=melt(cmp_log4, id.vars=c("Row.names","PC1","PC2"))

ggplot(cmp_log4, aes(-PC1,PC2, color=value)) + geom_point() + theme_bw() + facet_wrap(.~ variable , ncol=2) + scale_color_manual(values=c("lightsalmon","tomato","red4","lightsalmon","tomato","red4","gray88","lightcyan2","lightblue2","steelblue1","lightcyan2","lightblue2","steelblue1","blue3", "black", "lightsalmon","tomato","red", "red4", "red1","snow" ))

table(cmp_log3$ibd_Diagnosis,cmp_log3$ibd_montreal_Bperianal)
table(cmp_log3$ibd_Diagnosis,cmp_log3$ibd_montreal_B)
table(cmp_log3$ibd_Diagnosis,cmp_log3$ibd_montreal_S)

```


5.PCA & PCoA analysis on bacteria present in more than 20% of the samples
===

__Calculate PCA based on filtered clr relative abundaces__

```{r, echo=F}
print(paste("Number of species used for PCA analysis:", ncol(taxa_filt)))
```

```{r, echo=T}
pca_clr= prcomp(taxa_filt,scale. = T, center = T)
cmp_clr=as.data.frame(pca_clr$x[,1:5])
cmp_clr2=merge(cc_pheno2,cmp_clr,by="row.names")

```

```{r, echo=F}

ggplot(cmp_clr2, aes(PC1,-PC2, color=ibd_Diagnosis)) + geom_point() + theme_bw() + scale_colour_manual(values =c("firebrick3","black","gold3" ,"steelblue2"))

```


```{r, echo=F}

ggplot(cmp_clr2, aes(PC1,-PC2, color=clinical_BowelMovementADayDef)) + geom_point() + theme_bw()

```


__Repeat for disease scores Monteral__

```{r, message=F, warning=F}

rownames(cmp_clr2)=cmp_clr2$Row.names
cmp_clr2$Row.names=NULL
cmp_clr3=merge(montreal,cmp_clr2, by="row.names")

cmp_clr4=cmp_clr3[,c("Row.names","PC1","PC2","ibd_montreal_B","ibd_montreal_Bperianal","ibd_montreal_S","ibd_montreal_A","ibd_Montreal_L","ibd_MontrealE")]
cmp_clr4=melt(cmp_clr4, id.vars=c("Row.names","PC1","PC2"))

ggplot(cmp_clr4, aes(PC1,-PC2, color=value)) + geom_point() + theme_bw() + facet_wrap(.~ variable , ncol=2) + scale_color_manual(values=c("lightsalmon","tomato","red4","lightsalmon","tomato","red4","gray88","lightcyan2","lightblue2","steelblue1","lightcyan2","lightblue2","steelblue1","blue3", "black", "lightsalmon","tomato","red", "red4", "red1","snow" ))

```

__Calculate PCoA based on Bray-Curtis distances__


```{r, warning=F,message=FALSE, echo=TRUE}
#Filter present in at least 20% of the samples
taxa2=taxa2/100
taxa2[taxa2=="NA"]=0
taxa2[taxa2=="NaN"]=0
taxa_filt=taxa2[,((colSums(taxa2 !=0) / nrow(taxa2)) *100 )>20]
#Data transformation
#Choose square root arcsine transformation
taxa_asin=asin(sqrt(taxa_filt))

#Calculate bray curtis dissimilarity
bc_dis=vegdist(taxa_asin,method = "bray")
tax_mds <- metaMDS(comm=bc_dis,k=5, autotransform = FALSE)
data.scores <- as.data.frame(scores(tax_mds))
data.scores$site <- rownames(tax_mds) 
bc_mds=merge(cc_pheno2,data.scores,by="row.names")

```


```{r, echo=F}

ggplot(bc_mds, aes(NMDS1,NMDS2, color=ibd_Diagnosis)) + geom_point() + theme_bw() + scale_colour_manual(values =c("firebrick3","black","gold3" ,"steelblue2"))

```


6. Clustering metabolites
===


__Regress batch & diseases effects__

Here we use all metabolites present in more than 20% of the samples. 

We extract residuals from the following linear model (lm) : 

__lm(Metabolite ~ Day_of_measurment  + Amount_of_input_material + LC Column + Months_sample_in_freezer + ibd_Diagnosis (Control/CD/UC) )__

```{r}
rownames(cc_pheno4)=cc_pheno4$Row.names
cc_pheno4$Row.names=NULL
cc_pheno5=merge(my_batch_id,cc_pheno4, by="row.names")
my_regress_phenos=cc_pheno5[,c("Row.names","run_day_cat", "Amount_sample_gram", "LC.COLUMN" , "metabolon_Month_in_freezer" , "ibd_Diagnosis")]
rownames(my_regress_phenos)=my_regress_phenos$Row.names
my_regress_phenos$Row.names=NULL
rgs_mb=merge(my_regress_phenos,norm_filt, by="row.names")

rgs_mb2=matrix(nrow=nrow(my_regress_phenos), ncol = ncol(norm_filt))
 n=1
for (i in 7:ncol(rgs_mb)){
 my_lm=lm(rgs_mb[,i] ~ run_day_cat+Amount_sample_gram+LC.COLUMN+metabolon_Month_in_freezer+ibd_Diagnosis,data = rgs_mb)
 rgs_mb2[,n] = my_lm$residuals
 n=n+1
}
rgs_mb2=as.data.frame(rgs_mb2)
rownames(rgs_mb2)=rgs_mb$Row.names
colnames(rgs_mb2)=colnames(rgs_mb)[7:ncol(rgs_mb)]
```

```{r}
#Select metabolite annotation
annot_v2=annot
annot_v2$SUB.PATHWAY=NULL
annot_v2=subset(annot_v2, rownames(annot_v2) %in% colnames(rgs_mb2))
cor_metabolites=cor(rgs_mb2, method = "spearman")
cor_p=cor_pmat(rgs_mb2)
#heatmaply_cor(cor(rgs_mb2, method = "spearman"), showticklabels = c(FALSE, FALSE), main ="Spearman correlation between metabolites", plot_method = 'plotly', scale="none", row_side_colors =annot_v2)
ggcorrplot(cor_metabolites, hc.order = TRUE, outline.col = "white", colors = c("#6D9EC1", "white", "#E46726"), type = "upper", p.mat = cor_p, insig = "blank", tl.cex=0.9)
```



7. Evaluating the effect of technical factors and host age and sex
===

```{r, message=F, warning=F}

rownames(cc_pheno5)=cc_pheno5$Row.names
cc_pheno5$Row.names=NULL
cc_pheno6=cc_pheno5
table(cc_pheno6$run_day_cat, cc_pheno6$COMMENT)
cc_pheno6=subset(cc_pheno6,select = -c(Preparation_batch,Preparation_day,Preparation_order,CLIENT.IDENTIFIER,Box,Preparation_day_cat, RUN.DAY,SPL_AMNT_GRAM))

#Correction factors: day measurment was done, LC column, ammount sample per gram, month sample in a freezer, sex and age. 
my_correction_factors=cc_pheno6[,c("run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer","host_Sex","host_Age_sampling")]
my_correction_factors_test=merge(my_correction_factors,q_mtb,by="row.names")
rownames(my_correction_factors_test)=my_correction_factors_test$Row.names
my_correction_factors_test$Row.names=NULL

#Box and day are correlated (i.e Box1 was analyzed between day 1 and 3, box10 only on day21)
#Therefore I will only use day for correction
#table(my_correction_factors_test$run_day_cat, test_mtb_quantitative$COMMENT)

my_corr_factors_results=matrix(ncol = 5, nrow = 5124)
b=1
for ( a in 1:ncol(my_correction_factors)){
  for (x in (ncol(my_correction_factors)+1):ncol(my_correction_factors_test)){
    if(is.numeric(my_correction_factors[,a])){
      my_corr_factors_results[b,1]=colnames(my_correction_factors_test)[a]
      my_corr_factors_results[b,2]=colnames(my_correction_factors_test)[x]
      my_test=cor.test(my_correction_factors_test[,a],my_correction_factors_test[,x], method = "spearman")
      my_corr_factors_results[b,3]=my_test$estimate
      my_corr_factors_results[b,4]=my_test$p.value
      my_corr_factors_results[b,5]="spearman"
      b=b+1
    } else{
      my_corr_factors_results[b,1]=colnames(my_correction_factors_test)[a]
      my_corr_factors_results[b,2]=colnames(my_correction_factors_test)[x]
      my_test=kruskal.test(my_correction_factors_test[,x]~my_correction_factors_test[,a])
      my_corr_factors_results[b,3]=my_test$statistic
      my_corr_factors_results[b,4]=my_test$p.value
      my_corr_factors_results[b,5]="krustal"
      b=b+1
    }
  }
}

my_corr_factors_results=as.data.frame(my_corr_factors_results)
colnames(my_corr_factors_results)=c("Factor", "Metabolite","Estimate","p.value", "test")
my_corr_factors_results$p.value=as.numeric(as.character(my_corr_factors_results$p.value))
my_corr_factors_results$FDR=p.adjust(my_corr_factors_results$p.value,method = "fdr")
my_corr_factors_results$Bonferroni=p.adjust(my_corr_factors_results$p.value,method = "bonferroni")

x=as.data.frame(table(my_corr_factors_results$Factor[my_corr_factors_results$Bonferroni<0.05]))
y=as.data.frame(table(my_corr_factors_results$Factor[my_corr_factors_results$FDR<0.05]))
associations_factors=as.data.frame(cbind(x,y))
associations_factors[,3]=NULL
colnames(associations_factors)=c("Name","Bonferroni","FDR")
plot_asso=melt(associations_factors)


write.table(my_corr_factors_results, "~/Documents/Project_Metabolome/6.Results/confouders_quantitative_v2", sep = "\t", quote = F)

ggplot(plot_asso,aes(Name,value, fill=variable)) + geom_bar(stat="identity", position =position_dodge(), colour="black") + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + xlab("") +ylab ("Number of associations")+ scale_x_discrete(labels=c("Amount_sample_gram" = "Amount_input_sample", "run_day_cat" = "Run day","host_Age_sampling" = "Age", "host_Sex"="Sex", "LC.COLUMN"="LC-Column","metabolon_Month_in_freezer"="storage_time"))

test_plot=merge(cc_pheno6,q_mtb,by="row.names")
ggplot(test_plot, aes(run_day_cat,alpha_ketoglutarate)) + geom_violin(fill="gray88") + geom_jitter(aes(color=ibd_Diagnosis), position=position_jitter(0.2))+ theme_bw() + scale_color_manual(values = c("firebrick2", "black", "gray88","blue2")) 


my_correction_factors_test_bi=merge(my_correction_factors,bi_mtb,by="row.names")
rownames(my_correction_factors_test_bi)=my_correction_factors_test_bi$Row.names
my_correction_factors_test_bi$Row.names=NULL
colnames(my_correction_factors_test_bi)=make.names(colnames(my_correction_factors_test_bi))

my_corr_factors_results_bi=matrix(ncol = 5, nrow = 3084)
b=1
for ( a in 1:ncol(my_correction_factors)){
  for (x in (ncol(my_correction_factors)+1):ncol(my_correction_factors_test_bi)){
    if(is.numeric(my_correction_factors[,a])){
      my_corr_factors_results_bi[b,1]=colnames(my_correction_factors_test_bi)[a]
      my_corr_factors_results_bi[b,2]=colnames(my_correction_factors_test_bi)[x]
      my_frm=as.formula(paste(colnames(my_correction_factors_test_bi)[x], "~ ", colnames(my_correction_factors_test_bi)[a]))
      my_test=summary(glm(my_frm, family = binomial(link="logit"), data =my_correction_factors_test_bi))
      my_corr_factors_results_bi[b,3]=my_test$coefficients[2,1]
      my_corr_factors_results_bi[b,4]=my_test$coefficients[2,4]
      my_corr_factors_results_bi[b,5]="logit"
      b=b+1
    } else{
      my_corr_factors_results_bi[b,1]=colnames(my_correction_factors_test_bi)[a]
      my_corr_factors_results_bi[b,2]=colnames(my_correction_factors_test_bi)[x]
      my_test=chisq.test(my_correction_factors_test_bi[,x],my_correction_factors_test_bi[,a])
      my_corr_factors_results_bi[b,3]=my_test$statistic
      my_corr_factors_results_bi[b,4]=my_test$p.value
      my_corr_factors_results_bi[b,5]="chisq"
      b=b+1
    }
  }
}


my_corr_factors_results_bi=as.data.frame(my_corr_factors_results_bi)
colnames(my_corr_factors_results_bi)=c("Factor", "Metabolite","Estimate","p.value")
my_corr_factors_results_bi$p.value=as.numeric(as.character(my_corr_factors_results_bi$p.value))
my_corr_factors_results_bi$FDR=p.adjust(my_corr_factors_results_bi$p.value,method = "fdr")
my_corr_factors_results_bi$Bonferroni=p.adjust(my_corr_factors_results_bi$p.value,method = "bonferroni")


write.table(my_corr_factors_results_bi, "~/Documents/Project_Metabolome/6.Results/confouders_prevalence_v2.txt", sep = "\t", quote = F)

x=as.data.frame(table(my_corr_factors_results_bi$Factor[my_corr_factors_results_bi$Bonferroni<0.05]))
y=as.data.frame(table(my_corr_factors_results_bi$Factor[my_corr_factors_results_bi$FDR<0.05]))
association_corr_bi=as.data.frame(cbind(x,y))
association_corr_bi[,3]=NULL
colnames(association_corr_bi)=c("Name","Bonferroni","FDR")
plot_asso_bi=melt(association_corr_bi)

ggplot(plot_asso_bi,aes(Name,value, fill=variable)) + geom_bar(stat="identity", position =position_dodge(), colour="black") + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + xlab("") +ylab ("Number of associations")+ scale_x_discrete(labels=c("Amount_sample_gram" = "Amount_input_sample", "COMMENT" = "Box","host_Age_sampling" = "Age", "host_Sex"="Sex", "LC.COLUMN"="LC-Column","metabolon_Month_in_freezer"="storage_time"))


test_plot2=merge(cc_pheno6,bi_mtb,by="row.names")
test_pv=as.data.frame(table(test_plot2$run_day_cat, test_plot2$`cerotoylcarnitine__C26*`))
ggplot(test_pv, aes(Var1,Freq, fill=Var2)) + geom_bar(stat = "identity") +coord_flip()+ theme_bw() + ylab ("Presence of Cerotoylcarnitine") + xlab ("Day of the experiment")
```


8. Univariate analyses, covariates: age, sex, day measuring (run day), amount of sample, month sample in a freezer
===


```{r}

#q_mtb
#bi_mtb
test_mtb_quantitative=merge(cc_pheno6,q_mtb,by="row.names")
test_mtb_quantitative=as.data.frame(lapply(test_mtb_quantitative, gsub, pattern="Control", replacement="A_Control", fixed=T))
rownames(test_mtb_quantitative)=test_mtb_quantitative$Row.names
test_mtb_quantitative$Row.names=NULL
test_mtb_quantitative$ibd_FecalCalprotectin=NULL
test_mtb_quantitative$COMMENT=NULL

#write.table(test_mtb_quantitative,"~/Documents/Project_Metabolome/1.Input_files/Univariate_cc2_v2.txt",sep="\t", quote = F, row.names = T)

##REMOVE DIET & IBD PHENOS##
mtb_quantitative_ibd=read.table("~/Documents/Project_Metabolome/1.Input_files/Models_032020/Univariate_quant_ibd_meds_v3.txt",sep="\t", header = T, row.names = 1)
mtb_quantitative_diet=read.table("~/Documents/Project_Metabolome/1.Input_files/Models_032020/Univariate_quant_diet_v3.txt",sep="\t", header = T, row.names = 1)
mtb_quantitative_bugs=read.table("~/Documents/Project_Metabolome/1.Input_files/Models_032020/Univariate_quant_bugs_v3.txt",sep="\t", header = T, row.names = 1)

#corr_vars=c("host_Sex","host_Age_sampling","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer")


flag=1
for ( i in 1:61) {
  my_pheno=colnames(mtb_quantitative_ibd)[i]
  if (my_pheno=="run_day_cat" | my_pheno=="LC.COLUMN"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age_sampling") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 62:ncol(mtb_quantitative_ibd)){
      my_trait=colnames(mtb_quantitative_ibd)[a]
      my_uni_test=mtb_quantitative_ibd[,c("host_Sex","host_Age_sampling","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age_sampling","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      #my_uni_test[,8]=as.numeric(as.character(my_uni_test[,8]))
      my_samples=nrow(my_uni_test)
      my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
          my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
          my_univariate_results=my_lm_pheno
          flag=5
      }
    }
  }
}

my_univariate_ibd=my_univariate_results

#HERE#

flag=1
for ( i in 1:185) {
  my_pheno=colnames(mtb_quantitative_bugs)[i]
  if (my_pheno=="run_day_cat" | my_pheno=="LC.COLUMN"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age_sampling"| my_pheno=="ibd_Diagnosis") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 186:ncol(mtb_quantitative_bugs)){
      my_trait=colnames(mtb_quantitative_bugs)[a]
      my_uni_test=mtb_quantitative_bugs[,c("host_Sex","host_Age_sampling","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer","ibd_Diagnosis",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age_sampling","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer","ibd_Diagnosis",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      #my_uni_test[,8]=as.numeric(as.character(my_uni_test[,8]))
      my_samples=nrow(my_uni_test)
      my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
          my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
          my_univariate_results=my_lm_pheno
          flag=5
      }
    }
  }
}

my_univariate_bugs=my_univariate_results
my_univariate_bugs[my_univariate_bugs$factor!="host_BMI",]$factor="species"
my_univariate_bugs[my_univariate_bugs$phenotype=="Shannon_Index",]$factor="sp_richness"
my_univariate_bugs[my_univariate_bugs$phenotype=="Simpson_Index",]$factor="sp_richness"
	
flag=1
for ( i in 1:151) {
  my_pheno=colnames(mtb_quantitative_diet)[i]
  if (my_pheno=="run_day_cat" | my_pheno=="LC.COLUMN"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age_sampling") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 152:ncol(mtb_quantitative_diet)){
      my_trait=colnames(mtb_quantitative_diet)[a]
      my_uni_test=mtb_quantitative_diet[,c("host_Sex","host_Age_sampling","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age_sampling","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      #my_uni_test[,8]=as.numeric(as.character(my_uni_test[,8]))
      my_samples=nrow(my_uni_test)
      my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
          my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
          my_univariate_results=my_lm_pheno
          flag=5
      }
    }
  }
}

my_univariate_diet=my_univariate_results

my_univariate_ibd2=my_univariate_ibd[my_univariate_ibd$phenotype!="ibd_CurrentStomaOrPouch",]
my_univariate_ibd2=my_univariate_ibd2[my_univariate_ibd2$phenotype!="ibd_comb_diag_stoma",]
my_univariate_ibd2=my_univariate_ibd2[my_univariate_ibd2$phenotype!="host_BMI",]
my_univariate_bugs2=my_univariate_bugs[my_univariate_bugs$phenotype!="host_BMI",]


all_uni_quant=rbind(my_univariate_ibd2, my_univariate_diet)
all_uni_quant=rbind(all_uni_quant, my_univariate_bugs2)
all_uni_quant$FDR=p.adjust(all_uni_quant$`Pr(>|t|)`,method = "BH")
all_uni_quant$Bonferroni=p.adjust(all_uni_quant$`Pr(>|t|)`,method = "bonferroni")


##################
##SAVING RESULTS##
##################
write.table(all_uni_quant,"~/Documents/Project_Metabolome/6.Results/Results_quantitative_mtb_042020_v2.txt",sep="\t", quote = F, row.names = T)

quant_significant=all_uni_quant[all_uni_quant$FDR<0.05,]
quant_significant=all_uni_quant[all_uni_quant$Bonferroni<0.05,]
#quant_significant=quant_significant[quant_significant$metabolite!="Veillonella_unclassified",]


diet=unlist(quant_significant$metabolite[grep("diet_", quant_significant$phenotype)])
meds=unlist(quant_significant$metabolite[grep("med_", quant_significant$phenotype)])
CD=unlist(quant_significant$metabolite[quant_significant$factor=="ibd_DiagnosisCD"])
UC=unlist(quant_significant$metabolite[quant_significant$factor=="ibd_DiagnosisUC"])
Bugs=unlist(quant_significant$metabolite[quant_significant$factor=="species"])
Richness=unlist(quant_significant$metabolite[quant_significant$factor=="sp_richness"])
BMI=unlist(quant_significant$metabolite[quant_significant$phenotype=="host_BMI"])

my_test_list=list(CD =CD, UC=UC,BMI = BMI, Diet = diet, Bugs=Bugs ,Richness=Richness,Meds=meds)
upset(fromList(my_test_list), order.by = "freq", nsets = 7)


ggplot(mtb_quantitative_diet, aes(host_BMI, X7_ketocholesterol)) + geom_point() + theme_bw() + geom_smooth(method='lm')
ggplot(mtb_quantitative_diet, aes(diet_coffee.Res, caffeine)) + geom_point() + theme_bw() + geom_smooth(method='lm')


plot_cd=quant_significant[quant_significant$factor=="ibd_DiagnosisCD",]
annot$clean = make.names(rownames(annot))
plot_cd2=merge(plot_cd,annot, by.x = "metabolite", by.y = "clean")
plot_cd2$dir=-1
plot_cd2[plot_cd2$Estimate>0,]$dir=1

ggplot(plot_cd2, aes(SUB.PATHWAY,dir, fill=as.factor(dir))) + geom_bar(stat = "identity") + coord_flip() + scale_fill_manual(values=c("blue2", "red3")) + theme_bw()


plot_IBD=mtb_quantitative_ibd[mtb_quantitative_ibd$ibd_Diagnosis!="IBDU",]
plot_IBD2=mtb_quantitative_bugs[mtb_quantitative_bugs$ibd_Diagnosis!="IBDU",]
ggplot (plot_IBD, aes(ibd_Diagnosis,N_palmitoyl_sphingosine_d18_1_16_0, fill=ibd_Diagnosis)) + geom_boxplot(outlier.size = 0) + scale_fill_manual(values = c("white","firebrick2", "blue2")) + theme_classic() + geom_jitter(alpha=0.2)



ggplot(plot_IBD2, aes( Ruminococcus._gnavus, palmitoylcarnitine__C16,colour=ibd_Diagnosis)) + geom_point() + theme_bw() + geom_smooth(method='lm') + scale_color_manual(values=c("black","firebrick2","blue2"))

ggplot(plot_IBD2, aes( Shannon_Index, cholate,colour=ibd_Diagnosis)) + geom_point() + theme_bw() + geom_smooth(method='lm') + scale_color_manual(values=c("black","firebrick2","blue2"))


ggplot(plot_IBD2, aes( Faecalibacterium_prausnitzii, riboflavin__Vitamin_B2,colour=ibd_Diagnosis)) + geom_point() + theme_bw() + geom_smooth(method='lm') + scale_color_manual(values=c("black","firebrick2","blue2"))

plot_uc=quant_significant[quant_significant$factor=="ibd_DiagnosisUC",]

plot_uc2=merge(plot_uc,annot, by.x = "metabolite", by.y = "clean")
plot_uc2$dir=-1
plot_uc2[plot_uc2$Estimate>0,]$dir=1

ggplot(plot_uc2, aes(SUB.PATHWAY,dir, fill=as.factor(dir))) + geom_bar(stat = "identity") + coord_flip() + scale_fill_manual(values=c("blue2", "red3")) + theme_bw()

```


9. Logistic regression, univariate
===


```{r}
test_mtb_presence=merge(cc_pheno6,bi_mtb,by="row.names")
rownames(test_mtb_presence)=test_mtb_presence$Row.names
test_mtb_presence$Row.names=NULL
test_mtb_presence$ibd_FecalCalprotectin=NULL
test_mtb_presence$COMMENT=NULL

#write.table(test_mtb_presence,"~/Documents/Project_Metabolome/1.Input_files/Univariate_cc_prev_v2.txt",sep="\t", quote = F, row.names = T)

mtb_prev_ibd=read.table("~/Documents/Project_Metabolome/1.Input_files/Models_032020/Univariate_prev_ibd_meds_v3.txt",sep="\t", header = T, row.names = 1)
mtb_prev_diet=read.table("~/Documents/Project_Metabolome/1.Input_files/Models_032020/Univariate_prev_diet_v3.txt",sep="\t", header = T, row.names = 1)
mtb_prev_bugs=read.table("~/Documents/Project_Metabolome/1.Input_files/Models_032020/Univariate_prev_bugs_v3.txt",sep="\t", header = T, row.names = 1)



flag=1
for ( i in 1:61) {
  my_pheno=colnames(mtb_prev_ibd)[i]
  if (my_pheno=="run_day_cat" | my_pheno=="LC.COLUMN"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age_sampling") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 62:ncol(mtb_prev_ibd)){
      my_trait=colnames(mtb_prev_ibd)[a]
      my_uni_test=mtb_prev_ibd[,c("host_Sex","host_Age_sampling","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age_sampling","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      my_uni_test[,8]=as.numeric(as.character(my_uni_test[,8]))
      my_samples=nrow(my_uni_test)
      #my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm=summary(glm(my_f, family = binomial(link="logit"), data =my_uni_test))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
          my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
          my_univariate_results=my_lm_pheno
          flag=5
      }
    }
  }
}

prev_univariate_ibd=my_univariate_results


flag=1
for ( i in 1:185) {
  my_pheno=colnames(mtb_prev_bugs)[i]
  if (my_pheno=="run_day_cat" | my_pheno=="LC.COLUMN"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age_sampling"| my_pheno=="ibd_Diagnosis") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 186:ncol(mtb_prev_bugs)){
      my_trait=colnames(mtb_prev_bugs)[a]
      my_uni_test=mtb_prev_bugs[,c("host_Sex","host_Age_sampling","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer","ibd_Diagnosis",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age_sampling","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer","ibd_Diagnosis",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      my_uni_test[,8]=as.numeric(as.character(my_uni_test[,8]))
      my_samples=nrow(my_uni_test)
      #my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm=summary(glm(my_f, family = binomial(link="logit"), data =my_uni_test))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
          my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
          my_univariate_results=my_lm_pheno
          flag=5
      }
    }
  }
}

prev_univariate_bugs=my_univariate_results
prev_univariate_bugs[prev_univariate_bugs$factor!="host_BMI",]$factor="species"
prev_univariate_bugs[prev_univariate_bugs$phenotype=="Shannon_Index",]$factor="sp_richness"
prev_univariate_bugs[prev_univariate_bugs$phenotype=="Simpson_Index",]$factor="sp_richness"


flag=1
for ( i in 1:151) {
  my_pheno=colnames(mtb_prev_diet)[i]
  if (my_pheno=="run_day_cat" | my_pheno=="LC.COLUMN"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age_sampling") {
    print (paste("Skipping phenotype:",my_pheno))
  } else {
    print (paste("Testing:",my_pheno))
    for (a in 152:ncol(mtb_prev_diet)){
      my_trait=colnames(mtb_prev_diet)[a]
      my_uni_test=mtb_prev_diet[,c("host_Sex","host_Age_sampling","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age_sampling","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      my_uni_test[,8]=as.numeric(as.character(my_uni_test[,8]))
      my_samples=nrow(my_uni_test)
      #my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm=summary(glm(my_f, family = binomial(link="logit"), data =my_uni_test))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
          my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
          my_univariate_results=my_lm_pheno
          flag=5
      }
    }
  }
}

prev_univariate_diet=my_univariate_results


prev_univariate_ibd2=prev_univariate_ibd[prev_univariate_ibd$phenotype!="ibd_CurrentStomaOrPouch",]
prev_univariate_ibd2=prev_univariate_ibd2[prev_univariate_ibd2$phenotype!="ibd_comb_diag_stoma",]
prev_univariate_ibd2=prev_univariate_ibd2[prev_univariate_ibd2$phenotype!="host_BMI",]
prev_univariate_bugs2=prev_univariate_bugs[prev_univariate_bugs$phenotype!="host_BMI",]


all_uni_prev=rbind(prev_univariate_ibd2, prev_univariate_diet)
all_uni_prev=rbind(all_uni_prev, prev_univariate_bugs2)
all_uni_prev$FDR=p.adjust(all_uni_prev$`Pr(>|z|)`,method = "BH")
all_uni_prev$Bonferroni=p.adjust(all_uni_prev$`Pr(>|z|)`,method = "bonferroni")

#write.table(all_uni_prev,"~/Documents/Project_Metabolome/6.Results/Results_prevalence_mtb_042020.txt",sep="\t", quote = F, row.names = T)

prev_significant=all_uni_prev[all_uni_prev$FDR<0.05,]
prev_significant=all_uni_prev[all_uni_prev$Bonferroni<0.05,]

diet=unlist(prev_significant$metabolite[grep("diet_", prev_significant$phenotype)])
meds=unlist(prev_significant$metabolite[grep("med_", prev_significant$phenotype)])
CD=unlist(prev_significant$metabolite[prev_significant$factor=="ibd_DiagnosisCD"])
UC=unlist(prev_significant$metabolite[prev_significant$factor=="ibd_DiagnosisUC"])
Bugs=unlist(prev_significant$metabolite[prev_significant$factor=="species"])
Richness=unlist(prev_significant$metabolite[prev_significant$factor=="sp_richness"])
BMI=unlist(prev_significant$metabolite[prev_significant$phenotype=="host_BMI"])

my_test_list=list(CD =CD, UC=UC,BMI = BMI, Diet = diet, Bugs=Bugs ,Meds=meds, Richness=Richness)
upset(fromList(my_test_list), order.by = "freq", nsets = 7)

ggplot(mtb_prev_bugs, aes(as.factor(succinoyltaurine),Bilophila_wadsworthia, fill=as.factor(succinoyltaurine))) + geom_boxplot(outlier.colour = "white") + geom_jitter(alpha=0.3) + theme_classic() + scale_fill_manual(values = c("#E69F00", "#56B4E9"))



test_pv=as.data.frame(table(mtb_prev_ibd$ibd_FecalCalprotectinOver200yesno, mtb_prev_ibd$lignoceroyl_sphingomyelin_d18_1_24_0))
setDT(test_pv)[,prop:=Freq/sum(Freq),by=Var1]
ggplot(test_pv, aes(Var1,prop, fill=Var2)) + geom_bar(stat = "identity") + theme_bw() + ylab ("% Detection lignoceroyl sphingomyelin") + xlab ("Fecal Calprotectin > 200")

```



10. Associations only in the IBD cohort
===

```{r}


only_ibd_quant=read.table("~/Documents/Project_Metabolome/1.Input_files/Models_032020/IBD_only_quantitative.txt",sep="\t", header = T, row.names = 1)
only_ibd_quant$ibd_CurrentStomaOrPouch=NULL
only_ibd_quant$host_Sex.1=NULL
only_ibd_quant$med_parasympathicolytic_inhaler=NULL
only_ibd_quant$med_ranitidine=NULL

flag=1
for ( i in 1:428) {
  my_pheno=colnames(only_ibd_quant)[i]
  if (my_pheno=="run_day_cat" | my_pheno=="LC.COLUMN"| my_pheno=="Amount_sample_gram"| my_pheno=="metabolon_Month_in_freezer" | my_pheno=="host_Sex" | my_pheno=="host_Age_sampling") {
    print (paste("Skipping phenotype:",my_pheno))
    
  } 
  else if ( my_pheno=="ibd_Diagnosis"){
    print (paste("Testing:",my_pheno))
    for (a in 429:ncol(only_ibd_quant)){
      my_trait=colnames(only_ibd_quant)[a]
      my_uni_test=only_ibd_quant[,c("host_Sex","host_Age_sampling","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age_sampling","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      #my_uni_test[,8]=as.numeric(as.character(my_uni_test[,8]))
      my_samples=nrow(my_uni_test)
      my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
          my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
          my_univariate_results=my_lm_pheno
          flag=5
      }
    }
  }else {
    print (paste("Testing:",my_pheno))
    for (a in 429:ncol(only_ibd_quant)){
      my_trait=colnames(only_ibd_quant)[a]
      my_uni_test=only_ibd_quant[,c("host_Sex","host_Age_sampling","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer","ibd_Diagnosis",my_pheno,my_trait)]
      my_preds=c("host_Sex","host_Age_sampling","run_day_cat","LC.COLUMN","Amount_sample_gram","metabolon_Month_in_freezer","ibd_Diagnosis",my_pheno)
      my_f=as.formula(paste(my_trait, paste(my_preds, collapse = " + "), sep = " ~ "))
      #my_uni_test[,8]=as.numeric(as.character(my_uni_test[,8]))
      my_samples=nrow(my_uni_test)
      my_lm=summary(lm(my_f,data = my_uni_test ))
      my_lm_coef=as.data.frame(my_lm$coefficients)
      my_lm_pheno=try(my_lm_coef[grep(my_pheno, rownames(my_lm_coef)), ])
      my_lm_pheno$metabolite=my_trait
      my_lm_pheno$phenotype=my_pheno
      my_lm_pheno$factor=rownames(my_lm_pheno)
      if (flag!=1){
          my_univariate_results=rbind(my_univariate_results,my_lm_pheno)
      }else{
          my_univariate_results=my_lm_pheno
          flag=5
      }
    }
  }
}

ibd_only_results=my_univariate_results
ibd_only_results[ibd_only_results$phenotype=="Shannon_Index",]$factor="sp_richness"
ibd_only_results[ibd_only_results$phenotype=="Simpson_Index",]$factor="sp_richness"
ibd_only_res_clean=ibd_only_results
ibd_only_res_clean=ibd_only_res_clean[ibd_only_res_clean$phenotype!="Methylbutyric_acid",]
ibd_only_res_clean=ibd_only_res_clean[ibd_only_res_clean$phenotype!="acetic_acid",]
ibd_only_res_clean=ibd_only_res_clean[ibd_only_res_clean$phenotype!="butyric_acid",]
ibd_only_res_clean=ibd_only_res_clean[ibd_only_res_clean$phenotype!="hexanoic_acid",]
ibd_only_res_clean=ibd_only_res_clean[ibd_only_res_clean$phenotype!="isovaleric_acid",]
ibd_only_res_clean=ibd_only_res_clean[ibd_only_res_clean$phenotype!="isobutyric_acid",]
ibd_only_res_clean=ibd_only_res_clean[ibd_only_res_clean$phenotype!="propionic_acid",]
ibd_only_res_clean=ibd_only_res_clean[ibd_only_res_clean$phenotype!="valeric_acid",]

ibd_only_res_clean$FDR=p.adjust(ibd_only_res_clean$`Pr(>|t|)`,method = "BH")
ibd_only_res_clean$Bonferroni=p.adjust(ibd_only_res_clean$`Pr(>|t|)`,method = "bonferroni")
#write.table(ibd_only_res_clean,"~/Documents/Project_Metabolome/6.Results/IBD_only_results_quantitative_mtb_042020.txt",sep="\t", quote = F, row.names = T)
ibd_only_sig=ibd_only_res_clean[ibd_only_res_clean$FDR<0.05,]
ibd_only_sig=ibd_only_res_clean[ibd_only_res_clean$Bonferroni<0.05,]





diet=unlist(ibd_only_sig$metabolite[grep("diet_", ibd_only_sig$phenotype)])
meds=unlist(ibd_only_sig$metabolite[grep("med_", ibd_only_sig$phenotype)])
CD_vs_UC=unlist(ibd_only_sig$metabolite[ibd_only_sig$factor=="ibd_DiagnosisUC"])
Richness=unlist(ibd_only_sig$metabolite[ibd_only_sig$factor=="sp_richness"])
Bowel_move=unlist(ibd_only_sig$metabolite[ibd_only_sig$factor=="host_BowelMovementADay"])

Resection=unlist(ibd_only_sig$metabolite[ibd_only_sig$factor=="ibd_ResectionAnyyes"])
Ileocecal_valve=unlist(ibd_only_sig$metabolite[ibd_only_sig$factor=="ibd_IleocecalValveInSituyes"])

Num_resections=unlist(ibd_only_sig$metabolite[ibd_only_sig$factor=="ibd_NumberOfResectionsAny"])
Active_disease=unlist(ibd_only_sig$metabolite[ibd_only_sig$factor=="ibd_ActiveDiseaseNotActive"])
bugs=unlist(ibd_only_sig$metabolite[645:nrow(ibd_only_sig)])


my_test_list=list(CD_vs_UC =CD_vs_UC, Bowel_move=Bowel_move, Resection = Resection, Diet = diet, bugs=bugs ,Meds=meds, Richness=Richness,Ileocecal_valve=Ileocecal_valve,Num_resections=Num_resections,Active_disease=Active_disease)
upset(fromList(my_test_list), order.by = "freq", nsets = 10)



ggplot(only_ibd_quant, aes( Veillonella_atypica, X___23438)) + geom_point() + theme_bw() + geom_smooth(method='lm') 
ggplot(only_ibd_quant, aes( Ruminococcus._gnavus, tryptamine)) + geom_point() + theme_bw() + geom_smooth(method='lm')

my_plot=only_ibd_quant[,c("ibd_IleocecalValveInSitu","X7_ketodeoxycholate")]
my_plot=my_plot[complete.cases(my_plot$ibd_IleocecalValveInSitu),]
my_plot$my_ord="Without valve"
my_plot$my_ord[my_plot$ibd_IleocecalValveInSitu=="yes"]="in situ"
ggplot(my_plot, aes( my_ord, X7_ketodeoxycholate, fill=my_ord)) + geom_boxplot(outlier.color = "white") + theme_bw() + geom_jitter(alpha=0.2) + xlab("") + scale_fill_manual(values=c("lightblue","firebrick2"))

```





11. Calculate ratios
===

```{r}




```