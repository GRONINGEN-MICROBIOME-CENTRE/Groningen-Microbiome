suppressWarnings(suppressMessages(library(igraph)))
suppressWarnings(suppressMessages(library(ggraph)))
suppressWarnings(suppressMessages(library(tidyverse)))
suppressWarnings(suppressMessages(library(viridis)))
suppressWarnings(suppressMessages(library(data.tree)))
suppressWarnings(suppressMessages(library(phyloseq)))
suppressWarnings(suppressMessages(library(ggtree)))
suppressWarnings(suppressMessages(library(RColorBrewer)))
suppressWarnings(suppressMessages(library(ggsci)))
# library(igraph)
# library(tidyverse)
# library(viridis)
# library(data.tree)
# library(phyloseq)
# library(ggtree)
# library(RColorBrewer)#调色板调用包


data_to_maptree = function(otu,tax,N){
  ##-------------------------------------------依赖包-----------
  
  # 导入功能函数
  vegan_otu <-  function(physeq){
    OTU <-  otu_table(physeq)
    if(taxa_are_rows(OTU)){
      OTU <-  t(OTU)
    }
    return(as(OTU,"matrix"))
  }
  vegan_tax <-  function(physeq){
    tax <-  tax_table(physeq)
    
    return(as(tax,"matrix"))
  }
  ps <- phyloseq(otu_table(otu, taxa_are_rows=TRUE), 
                 tax_table(tax)
  )
  #相对丰富转换
  ps1_rela  = transform_sample_counts(ps, function(x) x / sum(x) );ps1_rela 
  # 提取otu表格
  otu_table = as.data.frame(t(vegan_otu(ps1_rela)))
  otu_table$mean = rowMeans(otu_table)
  otu_table$ID = row.names(otu_table)
  head(otu_table)
  #按照从大到小排序
  otu_table<- arrange(otu_table, desc(mean))
  subtab = head(otu_table,N)
  head(subtab)
  row.names(subtab) =subtab$ID
  subtab = subtab[,1:(dim(subtab)[2]-2)]
  subtab = as.matrix(subtab)
  
  #对phyloseq取子集
  ps_sub <- phyloseq(otu_table(subtab, taxa_are_rows=TRUE), 
                     tax_table(tax))
  ps_sub
  #--------------------整理tax文件-----------------
  #注意我们本次制作的是OTU水平的maptree
  tax = as.data.frame(vegan_tax(ps_sub))
  #添加水平识别标示
  tax$Kingdom = paste("D_",tax$Kingdom,sep = "--")
  tax$Phylum = paste(tax$Kingdom,"P_",tax$Phylum,sep = "--")
  tax$Class = paste(tax$Phylum,"C_",tax$Class,sep = "--")
  tax$Order = paste(tax$Class,"O_",tax$Order,sep = "--")
  tax$Family = paste(tax$Order,"F_",tax$Family ,sep = "--")
  tax$Genus = paste(tax$Family,"G_",tax$Genus,sep = "--")
  tax$Species = paste(tax$Genus,"S_",tax$Species,sep = "--")
  tax$OTU = paste("ASV",row.names(tax),sep = "--")
  # # 对不同分类水平的tax未知物种进行区分
  tax_table(ps_sub) = as.matrix(tax)
  head(tax)
  
  #--------------------构造边文件--------------------
  #提取分组信息
  Desep_group <- as.character(colnames(tax))
  #按照form--to格式来排布数据
  edge_t = tax[c(Desep_group[1:2])]
  dim(edge_t)
  edge_t <-  dplyr::distinct(edge_t)
  dim(edge_t)
  for (i in 2:7) {
    result = tax[c(Desep_group[i:(i+1)])]
    colnames(result) = colnames(edge_t)
    result <-  dplyr::distinct(result)
    edge_t = rbind(edge_t,result)
  }
  dim(edge_t)
  colnames(edge_t) = c("from","to")
  if (length(unique(tax$Kingdom)) >1) {
    edge_t$from = as.character(edge_t$from)
    edge_t$to = as.character(edge_t$to)
    buc = data.frame(from = c("king_up","king_up","king_up","king_up","king_up","king_up","king_up","king_up","king_up","king_up"),
                     to =c("D_--Amino Acid","D_--Carbohydrate", "D_--Cofactors and Vitamins","D_--Energy","D_--Lipid","D_--Nucleotide","D_--Peptide","D_--Unknown_compount","D_--Xenobiotics","D_--SCFA") )
    row.names(buc) = c("sp_K","sp_k1","sp_k2","sp_k3","sp_k4","sp_k5","sp_k6","sp_k7","sp_k8","sp_k9")
    edge_t = rbind(edge_t,buc)
  }
  deg = edge_t
  #---------------------------构造基本节点信息文件
  #构造tree用于提取分级结构
  tree <- FromDataFrameNetwork(deg)
  vertices_t  <-  data.frame(
    name = unique(c(as.character(deg$from), as.character(deg$to)))
  )
  # Then I can easily get the level of each node, and add it to the initial data frame:
  mylevels <- data.frame( name=tree$Get('name'), level=tree$Get("level") )
  vertices_t <- vertices_t %>% 
    left_join(., mylevels, by=c("name"="name"))
  #这里提取名称信息
  AA = rep("A",length(vertices_t$name))
  for (i in 1:length(vertices_t$name)) {
    AA [i] = strsplit(basename(as.character(vertices_t$name)), "--")[[i]][length(strsplit(basename(as.character(vertices_t$name)), "--")[[i]])]
  }
  vertices_t$shortName<- AA
  # #设置level为2的定义为标签，其他偶读都省略掉，避免杂乱无章
  vertices_t <- vertices_t %>%
    mutate(new_label=ifelse(level==2, shortName, NA))
  row.names(vertices_t) = vertices_t$name
  
  #----------------------------------构造网络文件------------------------------
  mygraph <- graph_from_data_frame( deg, vertices= vertices_t )
  
  p = ggraph(mygraph, layout = 'circlepack', sort.by = NULL, direction = "out") + 
    geom_node_circle(aes(fill = as.factor(depth),color = as.factor(depth) ) ) +
    scale_fill_manual(values= c("white","white","white","white","white","white","white","white","yellow") ) +
    scale_color_manual( values=c("0" = "white", "1" = "black", "2" = "black", "3" = "black", "4"="black", "5"="black", "6"="black", "7"="black","8"="black","9"="black") ) +
    geom_node_text( aes(label=new_label), size=6,repel = TRUE) +
    # geom_node_label( aes(label=new_label), size=3,repel = TRUE) +
    theme_void() + 
    theme( legend.position="FALSE",plot.margin = unit(rep(0,4), "cm"))#
  # p
  
  return(list(p,deg,vertices_t,ps_sub,mygraph))
}




#--------------------------------------------------添加高级节点信息进入基本节点信息中---------------
##----------------构造高级节点注释文件-------------

maptree_add1_plot = function(x){
  ps_sub = mapdata[[4]]
  vertices_t = mapdata[[3]]
  deg = mapdata[[2]]
  head(vertices_t)
  
  vegan_otu <-  function(physeq){
    OTU <-  otu_table(physeq)
    if(taxa_are_rows(OTU)){
      OTU <-  t(OTU)
    }
    return(as(OTU,"matrix"))
  }
  vegan_tax <-  function(physeq){
    tax <-  tax_table(physeq)
    
    return(as(tax,"matrix"))
  }
  
  tax_table = as.data.frame(vegan_tax(ps_sub))
  otu_table = as.data.frame(t(vegan_otu(ps_sub)))
  #计算全部均值
  otu_table$mean = rowMeans(otu_table)
  #组合结果
  inde = merge(otu_table,tax_table,by = "row.names", all = TRUE)
  head(inde)
  row.names(inde) = inde$Row.names
  inde$Row.names = NULL
  
  #添加高级注释信息进入函数
  row.names(inde) = paste("ASV",row.names(inde),sep = "--")
  ##将全部信息合并到节点属性中
  data_plot = merge(vertices_t,inde,by = "row.names",all = TRUE)
  row.names(data_plot) = data_plot$Row.names
  data_plot$Row.names = NULL
  
  #指定大小映射列将NA值做转换为0
  asa =data_plot$mean
  data_plot$mean[is.na(asa)] = 0
  #选择是否平方根标准化丰度
  # data_plot$mean[!is.na(asa)] = sqrt(data_plot$mean[!is.na(asa)])
  
  
  mygraph <- graph_from_data_frame( deg, vertices= data_plot )
  #-----------------------------------设置颜色映射参数-------------------------
  data = create_layout(mygraph, layout = 'circlepack',weight = mean, sort.by = NULL, direction = "out")
  #设置颜色
  data$Phylum = as.character(data$Phylum)
  data$Phylum[is.na(data$Phylum)] = "AA"
  data$Phylum = factor(data$Phylum,levels =unique(data$Phylum) )
  colbar <-length(unique(data$Phylum))
  fil_colors = colorRampPalette(c( "white","#CBD588", "#599861", "orange","#DA5724", "#508578", "#CD9BCD",
                                   "#AD6F3B", "#673770","#D14285", "#652926", "#C84248", 
                                   "#8569D5", "#5E738F","#D1A33D", "#8A7C64","black","yellow"))(colbar)
  names(fil_colors ) = unique(data$Phylum)
  fil_colors[1] = "white"
  p = ggraph(mygraph, layout = 'circlepack',weight = mean, sort.by = NULL, direction = "out") +
    geom_node_circle(aes(fill = as.factor(Phylum),color = as.factor(depth) ) ) +
    scale_fill_manual(values= fil_colors ) +
    scale_color_manual( values=c("0" = "white", "1" = "black", "2" = "black", "3" = "black", "4"="black", "5"="black", "6"="black", "7"="black","8"="black","9"="black") ) +
    geom_node_text( aes(label=new_label), size=6,repel = TRUE) +
    # geom_node_label( aes(label=new_label), size=3,repel = TRUE) +
    theme_void() +
    theme( legend.position="FALSE",plot.margin = unit(rep(0,4), "cm"))#
  # p
  
  return(list(p,mygraph,fil_colors))
  
}


maptree_add2_plot = function(x,fillcolor ){
  #解析输入
  ps_sub = mapdata[[4]]
  vertices_t = mapdata[[3]]
  deg = mapdata[[2]]
  # 防止合并后名称改变
  fillcolor = paste("addtab",fillcolor,sep = "_")
  colnames(addtab) = paste("addtab",colnames(addtab),sep = "_")
  vegan_otu <-  function(physeq){
    OTU <-  otu_table(physeq)
    if(taxa_are_rows(OTU)){
      OTU <-  t(OTU)
    }
    return(as(OTU,"matrix"))
  }
  vegan_tax <-  function(physeq){
    tax <-  tax_table(physeq)
    
    return(as(tax,"matrix"))
  }
  
  tax_table = as.data.frame(vegan_tax(ps_sub))
  otu_table = as.data.frame(t(vegan_otu(ps_sub)))
  #计算全部均值
  otu_table$mean = rowMeans(otu_table)
  #组合结果
  inde = merge(otu_table,tax_table,by = "row.names", all = TRUE)
  head(inde)
  row.names(inde) = inde$Row.names
  inde$Row.names = NULL
  
  dim(inde)
  inde = merge(inde,addtab,by = "row.names",all.x = TRUE)
  row.names(inde) = inde$Row.names
  inde$Row.names = NULL
  dim(inde)
  #更改颜色列统一为fill_color
  colnames(inde) <- gsub(fillcolor,"fill_color",colnames(inde))
  #添加高级注释信息进入函数
  row.names(inde) = paste("ASV",row.names(inde),sep = "--")
  ##将全部信息合并到节点属性中
  data_plot = merge(vertices_t,inde,by = "row.names",all = TRUE)
  row.names(data_plot) = data_plot$Row.names
  data_plot$Row.names = NULL
  head(data_plot)
  #指定大小映射列将NA值做转换为0
  asa =data_plot$mean
  data_plot$mean[is.na(asa)] = 0
  #选择是否平方根标准化丰度
  # data_plot$mean[!is.na(asa)] = sqrt(data_plot$mean[!is.na(asa)])
  
  mygraph <- graph_from_data_frame( deg, vertices= data_plot )
  #-----------------------------------设置颜色映射参数-------------------------
  data = create_layout(mygraph, layout = 'circlepack',weight = mean, sort.by = NULL, direction = "out")
  colnames(data)
  i = "fill_color"
  data[[i]] = as.character(data[[i]])
  data[[i]][is.na(data[[i]])] = "AA"
  unique(data[[i]])
  data[[i]] = factor(data[[i]],levels =unique(data[[i]]) )
  levels(data[[i]])
  data[i] = data[[i]]
  colbar <-length(unique(data[[i]]))
  mi = brewer.pal(9,"Set3")
  fil_colors = mi[1:colbar ]
  names(fil_colors ) = unique(data$KOWT_level)
  fil_colors
  p = ggraph(mygraph, layout = 'circlepack',weight = mean, sort.by = NULL, direction = "out") +
    geom_node_circle(aes(fill = as.factor(fill_color),color = as.factor(depth)),size = 0.25 ) +
    scale_fill_jama()+
    scale_color_manual( values=c("0" = "white", "1" = "grey80", "2" = "grey80", "3" = "grey80", "4"="grey80", "5"="grey80", "6"="grey80", "7"="grey80","8"="grey80","9"="grey80") ) +
    geom_node_text( aes(label=new_label), size=5,repel = TRUE) +
    # geom_node_label( aes(label=new_label), size=3,repel = TRUE) +
    theme_void() +
    theme(plot.margin = unit(rep(0,4), "cm"))+guides(color=F)
  # p
  
  return(list(p,mygraph,fil_colors))
}