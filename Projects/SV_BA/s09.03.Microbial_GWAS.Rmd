---
title: "Microbial GWAS (corrected for abundance)"
author: "Daoming Wang"
date: "2020/10/22"
output:
  html_document: 
    theme: flatly
    highlight: espresso
    toc: true
    toc_depth: 4
    toc_float: true
  word_document: default
  pdf_document:
    includes:
      in_header: header.tex
      keep_tex: yes
      latex_engine: xelatex
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

## 1 Preparation

### 1.1 Import

Import packages and functions.

```{r 1.1, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
source("functions.R")
```

### 1.2 Inputs

Read input files.

```{r 1.2, echo=TRUE}
lld_dsv <- read.table("01.cleanData/SV_lld/20200801_LLD_deletionStructuralVariation_1135samples.tsv",check.names = F)
lld_vsv <- read.table("01.cleanData/SV_lld/20200801_LLD_variableStructuralVariation_1135samples.tsv",check.names = F)
ob_dsv  <- read.table("01.cleanData/SV_300OB/20200801_300OB_deletionStructuralVariation_302samples.tsv",check.names = F)
ob_vsv  <- read.table("01.cleanData/SV_300OB/20200801_300OB_variableStructuralVariation_302samples.tsv",check.names = F)
all_dsv<-read.table("01.cleanData/SV_all/20200801_LLD_300OB_deletionStructuralVariation_1437samples.tsv",check.names = F)
all_vsv<-read.table("01.cleanData/SV_all/20200801_LLD_300OB_variableStructuralVariation_1437samples.tsv",check.names = F)

info    <- read.table("01.cleanData/SV_info/20200801_LLD_300OB_Informative_species_information.tsv",
                      sep = "\t", header = T, stringsAsFactors = F)
vsv_info<-read.table("01.cleanData/SV_info/20200801_LLD_300OB_vsgv_info_anno.tsv",
                     sep = "\t",header = T,stringsAsFactors = F, quote = "")
dsv_info<-read.table("01.cleanData/SV_info/20200801_LLD_300OB_dsgv_info_anno.tsv",
                     sep = "\t",header = T,stringsAsFactors = F,quote = "")


lld_ba <- read.table("01.cleanData/phen_lld/20200801_LLD_39BA_1135samples.tsv")
lld_basic <- read.table("01.cleanData/phen_lld/20200801_LLD_basic_1135samples.tsv")
ob_ba <- read.table("01.cleanData/phen_300OB/20200801_300OB_39BA_302samples.tsv")
ob_basic <- read.table("01.cleanData/phen_300OB/20200801_300OB_basic_302samples.tsv")
all_ba<-read.table("01.cleanData/phen_all/20200801_LLD_300OB_39BA_1437samples.tsv")
all_covar<-read.table("01.cleanData/phen_all/20200801_LLD_covar_1437samples.tsv")
all_basic<-read.table("01.cleanData/phen_all/20200801_LLD_basic_1437samples.tsv")

lld_abun<-read.table("01.cleanData/mbio_lld/20200801_LLD_metaphlan3_species_1135samples.tsv") 
ob_abun<-read.table("01.cleanData/mbio_300OB/20200801_300OB_metaphlan3_species_302samples.tsv") 
all_abun<-read.table("01.cleanData/mbio_all/20200801_LLD_300OB_metaphlan3_species_1437samples.tsv")

load("09.Microbial_GWAS/RData/lld_vsv_ba_lm_res.RData")
load("09.Microbial_GWAS/RData/ob_vsv_ba_lm_res.RData")
load("09.Microbial_GWAS/RData/lld_dsv_ba_lm_res.RData")
load("09.Microbial_GWAS/RData/ob_dsv_ba_lm_res.RData")

```



## 2 Associations between SVs and BAs

### 2.1 linear model 

Linear model adjusted gender and age.

```{r 2.1, eval = FALSE}
if (!dir.exists("09.Microbial_GWAS")) {dir.create("09.Microbial_GWAS")}
if (!dir.exists("09.Microbial_GWAS/RData")) {dir.create("09.Microbial_GWAS/RData")}

## Prepare covariate table
lld_abun_clr<-abundances(x=as.data.frame(na.omit(lld_abun)), transform="clr") %>%as.data.frame
lld_abun_clr <- lld_abun_clr[match(rownames(lld_abun), rownames(lld_abun_clr)),]
rownames(lld_abun_clr) <- rownames(lld_abun)

lld_covar<-cbind(lld_basic,lld_abun_clr)

ob_abun_clr<-abundances(x=as.data.frame(na.omit(ob_abun)), transform="clr") %>%as.data.frame
ob_abun_clr <- ob_abun_clr[match(rownames(ob_abun), rownames(ob_abun_clr)),]
rownames(ob_abun_clr) <- rownames(ob_abun)

ob_covar<-cbind(ob_basic,ob_abun_clr)

covar <- c('Gender','Age','BMI','Reads_number')

### linear model
## vsv
lld_vsv_ba_lm_adjAbun_res<-lm_btw_mats_adjAbun(lld_ba,lld_vsv,lld_covar,covar,lld_abun_clr,info,paste(lld_vsv_ba_lm_res$table$Taxa,lld_vsv_ba_lm_res$table$Phenotype),y_mat = 0)
save(lld_vsv_ba_lm_adjAbun_res, file = "09.Microbial_GWAS/RData/lld_vsv_ba_lm_adjAbun_res.RData")

ob_vsv_ba_lm_adjAbun_res<-lm_btw_mats_adjAbun(ob_ba,ob_vsv,ob_covar,covar,ob_abun_clr,info,paste(ob_vsv_ba_lm_res$table$Taxa,ob_vsv_ba_lm_res$table$Phenotype),y_mat = 0)
save(ob_vsv_ba_lm_adjAbun_res, file = "09.Microbial_GWAS/RData/ob_vsv_ba_lm_adjAbun_res.RData")

# meta-analysis
cbind_vsv_ba_lm_adjAbun_edge<-cbind(lld_vsv_ba_lm_adjAbun_res$table, ob_vsv_ba_lm_adjAbun_res$table)[,-c(10,11)]
colnames(cbind_vsv_ba_lm_adjAbun_edge)<-c("SV","BA",
                                paste("LLD.",colnames(cbind_vsv_ba_lm_adjAbun_edge)[3:9],sep = ""),
                                paste("X300OB.",colnames(cbind_vsv_ba_lm_adjAbun_edge)[3:9],sep = ""))
all_vsv_ba_lm_adjAbun_res <- my_batch_meta_lm(cbind_vsv_ba_lm_adjAbun_edge, c("LLD", "300OB"), c(3,10), c(4,11))
save(all_vsv_ba_lm_adjAbun_res, file = "09.Microbial_GWAS/RData/all_vsv_ba_lm_adjAbun_res.RData")

## dsv
lld_dsv_ba_lm_adjAbun_res<-lm_btw_mats_adjAbun(lld_ba,lld_dsv,lld_covar,covar,lld_abun_clr,info,paste(lld_dsv_ba_lm_res$table$Taxa,lld_dsv_ba_lm_res$table$Phenotype),y_mat = 0)
save(lld_dsv_ba_lm_adjAbun_res, file = "09.Microbial_GWAS/RData/lld_dsv_ba_lm_adjAbun_res.RData")

ob_dsv_ba_lm_adjAbun_res<-lm_btw_mats_adjAbun(ob_ba,ob_dsv,ob_covar,covar,ob_abun_clr,info,paste(ob_dsv_ba_lm_res$table$Taxa,ob_dsv_ba_lm_res$table$Phenotype),y_mat = 0)
save(ob_dsv_ba_lm_adjAbun_res, file = "09.Microbial_GWAS/RData/ob_dsv_ba_lm_adjAbun_res.RData")

# meta-analysis
cbind_dsv_ba_lm_adjAbun_edge<-cbind(lld_dsv_ba_lm_adjAbun_res$table, ob_dsv_ba_lm_adjAbun_res$table)[,-c(10,11)]
colnames(cbind_dsv_ba_lm_adjAbun_edge)<-c("SV","BA",
                                paste("LLD.",colnames(cbind_dsv_ba_lm_adjAbun_edge)[3:9],sep = ""),
                                paste("X300OB.",colnames(cbind_dsv_ba_lm_adjAbun_edge)[3:9],sep = ""))
all_dsv_ba_lm_adjAbun_res <- my_batch_meta_lm(cbind_dsv_ba_lm_adjAbun_edge, c("LLD", "300OB"), c(3,10), c(4,11))
save(all_dsv_ba_lm_adjAbun_res, file = "09.Microbial_GWAS/RData/all_dsv_ba_lm_adjAbun_res.RData")

## hetero number
sum(vsv_ba_lm_adjAbun_res.edge$LLD.p<0.05 & vsv_ba_lm_adjAbun_res.edge$X300OB.p<0.05 & vsv_ba_lm_adjAbun_res.edge$Meta.hetero.p<0.05 & vsv_ba_lm_adjAbun_res.edge$LLD.uniq_N>10 & vsv_ba_lm_adjAbun_res.edge$X300OB.uniq_N>10  ,na.rm = T)
```


### 2.2 Merge results

#### 2.2.1 vSV associations
```{r 2.2.1}
## vsv
## load result data
load("09.Microbial_GWAS/RData/lld_vsv_ba_lm_adjAbun_res.RData")
load("09.Microbial_GWAS/RData/ob_vsv_ba_lm_adjAbun_res.RData")
load("09.Microbial_GWAS/RData/all_vsv_ba_lm_adjAbun_res.RData")

## merge result tables
vsv_ba_lm_adjAbun_res.edge<-all_vsv_ba_lm_adjAbun_res$table

vsv_ba_lm_adjAbun_res.sig.edge <- vsv_ba_lm_adjAbun_res.edge[vsv_ba_lm_adjAbun_res.edge$Meta.fdr.p < 0.05 & 
                                               vsv_ba_lm_adjAbun_res.edge$LLD.p < 0.05 &
                                               vsv_ba_lm_adjAbun_res.edge$X300OB.p < 0.05 &
                                                 vsv_ba_lm_adjAbun_res.edge$LLD.Beta*vsv_ba_lm_adjAbun_res.edge$X300OB.Beta>0 &
                                                 vsv_ba_lm_adjAbun_res.edge$LLD.uniq_N>10 &
                                                 vsv_ba_lm_adjAbun_res.edge$X300OB.uniq_N>10 &
                                               #abs(vsv_ba_lm_adjAbun_res.edge$Meta.beta)>0.1 &
                                               vsv_ba_lm_adjAbun_res.edge$Meta.hetero.p>0.05,]

vsv_ba_lm_adjAbun_res.sig.anno.edge<-left_join(vsv_ba_lm_adjAbun_res.sig.edge, vsv_info, by = c("SV" = "SV_Name"))
write.table(vsv_ba_lm_adjAbun_res.sig.anno.edge,"09.Microbial_GWAS/vsv_ba_lm_adjAbun.sig.anno.tsv",sep = "\t",col.names = T, row.names = F, quote = F)


## hetero number
sum(dsv_ba_lm_adjAbun_res.edge$LLD.p<0.05 & dsv_ba_lm_adjAbun_res.edge$X300OB.p<0.05 & dsv_ba_lm_adjAbun_res.edge$Meta.hetero.p<0.05 & dsv_ba_lm_adjAbun_res.edge$LLD.uniq_N>10 & dsv_ba_lm_adjAbun_res.edge$X300OB.uniq_N>10  ,na.rm = T)

sum(dsv_ba_lm_adjAbun_res.edge$LLD.p<0.01 & dsv_ba_lm_adjAbun_res.edge$X300OB.p<0.01 & dsv_ba_lm_adjAbun_res.edge$Meta.hetero.p<0.05 & dsv_ba_lm_adjAbun_res.edge$LLD.uniq_N>10 & dsv_ba_lm_adjAbun_res.edge$X300OB.uniq_N>10  ,na.rm = T)
```
```

#### 2.2.2 dSV associations

```{r 2.2.2}
## dsv
## load result data
load("09.Microbial_GWAS/RData/lld_dsv_ba_lm_adjAbun_res.RData")
load("09.Microbial_GWAS/RData/ob_dsv_ba_lm_adjAbun_res.RData")
load("09.Microbial_GWAS/RData/all_dsv_ba_lm_adjAbun_res.RData")

## merge result tables
dsv_ba_lm_adjAbun_res.edge<-all_dsv_ba_lm_adjAbun_res$table

dsv_ba_lm_adjAbun_res.sig.edge <- dsv_ba_lm_adjAbun_res.edge[dsv_ba_lm_adjAbun_res.edge$Meta.fdr.p < 0.05 & 
                                               dsv_ba_lm_adjAbun_res.edge$LLD.p < 0.05 &
                                               dsv_ba_lm_adjAbun_res.edge$X300OB.p < 0.05 &
                                               dsv_ba_lm_adjAbun_res.edge$LLD.Beta*dsv_ba_lm_adjAbun_res.edge$X300OB.Beta>0 &
                                                 dsv_ba_lm_adjAbun_res.edge$LLD.uniq_N>10 &
                                                 dsv_ba_lm_adjAbun_res.edge$X300OB.uniq_N>10 &
                                               #abs(dsv_ba_lm_adjAbun_res.edge$Meta.beta)>0.1 &
                                               dsv_ba_lm_adjAbun_res.edge$Meta.hetero.p>0.05,]

dsv_ba_lm_adjAbun_res.sig.anno.edge<-left_join(dsv_ba_lm_adjAbun_res.sig.edge, dsv_info, by = c("SV" = "SV_Name"))
write.table(dsv_ba_lm_adjAbun_res.sig.anno.edge,"09.Microbial_GWAS/dsv_ba_lm_adjAbun.sig.anno.tsv",sep = "\t",col.names = T, row.names = F, quote = F)
```

#### 2.2.3 Volcano plot

```{r 2.2.3}
vsv_ba_lm_adjAbun_res.edge$MetaSigAssoc<-rep('No', nrow(vsv_ba_lm_adjAbun_res.edge))

vsv_ba_lm_adjAbun_res.edge$MetaSigAssoc[vsv_ba_lm_adjAbun_res.edge$Meta.fdr.p < 0.05]<-'Yes' #  &  abs(vsv_ba_lm_adjAbun_res.edge$Meta.beta)>0.1
vsv_ba_lm_adjAbun_res.edge.plot<-vsv_ba_lm_adjAbun_res.edge[vsv_ba_lm_adjAbun_res.edge$LLD.uniq_N>10 &
                                                         vsv_ba_lm_adjAbun_res.edge$X300OB.uniq_N>10,]

p_vsv_volcano<-ggplot(vsv_ba_lm_adjAbun_res.edge.plot,aes(Meta.beta, -log10(Meta.p), color=MetaSigAssoc))+
  geom_point(alpha = 0.5,size = 0.5)+
  #geom_text_repel(size = 3)+
  #geom_hline(yintercept=-log10(0.05), linetype="dashed", color = "grey50")+
  #geom_vline(xintercept=1, linetype="dashed", color = "#ff4040")+
  #geom_vline(xintercept=-1, linetype="dashed", color = "#4f94cd")+
  xlab('Beta coefficient')+
  ylab('-log10(P)')+
  scale_color_manual(name   = NULL,
                     breaks = c("Yes", "No"),
                     labels = c("Associated    ", "Not associated"),
                     values = c("#ff4040","#4f94cd"))+
  scale_shape_discrete(name = NULL)+
  theme_bw()+
  theme(legend.position = "top",
        legend.key = element_rect(fill = NA))

dsv_ba_lm_adjAbun_res.edge$MetaSigAssoc<-rep('No', nrow(dsv_ba_lm_adjAbun_res.edge))

dsv_ba_lm_adjAbun_res.edge$MetaSigAssoc[dsv_ba_lm_adjAbun_res.edge$Meta.fdr.p < 0.05 ]<-'Yes' # & abs(dsv_ba_lm_adjAbun_res.edge$Meta.beta)>0.1
dsv_ba_lm_adjAbun_res.edge.plot<-dsv_ba_lm_adjAbun_res.edge[dsv_ba_lm_adjAbun_res.edge$LLD.uniq_N>10 &
                                                         dsv_ba_lm_adjAbun_res.edge$X300OB.uniq_N>10,]

p_dsv_volcano<-ggplot(dsv_ba_lm_adjAbun_res.edge.plot,aes(Meta.beta, -log10(Meta.p), color=MetaSigAssoc))+
  geom_point(alpha = 0.5,size = 0.5)+
  #geom_text_repel(size = 3)+
  #geom_hline(yintercept=-log10(0.05), linetype="dashed", color = "grey50")+
  #geom_vline(xintercept=1, linetype="dashed", color = "#ff4040")+
  #geom_vline(xintercept=-1, linetype="dashed", color = "#4f94cd")+
  xlab('Beta coefficient')+
  ylab('-log10(P)')+
  scale_color_manual(name   = NULL,
                     breaks = c("Yes", "No"),
                     labels = c("Associated    ", "Not associated"),
                     values = c("#ff4040","#4f94cd"))+
  scale_shape_discrete(name = NULL)+
  theme_bw()+
  theme(legend.position = "top",
        legend.key = element_rect(fill = NA))

## plot
p_title_volcano <- ggdraw() + 
    draw_label(
      ' ', # Volcano plot
      fontface = 'bold', x = 0, hjust = 0,size = 10) +
    theme(
      # add margin on the left of the drawing canvas,
      # so title is aligned with left edge of first plot
      plot.margin = margin(0, 0, 0, 7))

p_sv_ba_volcano<-plot_grid(
    p_title_volcano, 
    plot_grid(p_vsv_volcano,p_dsv_volcano,
              rel_widths = c(1, 1),align = 'hv',
              #labels = c("vSVs-BAs", "dSVs-BAs"),
              ncol = 2,label_size	= 8,vjust = 0),
    ncol = 1,
    # rel_heights values control vertical title margins
    rel_heights = c(0.1, 2)
  )

if(!dir.exists("09.Microbial_GWAS/")){dir.create("09.Microbial_GWAS/")}
pdf("09.Microbial_GWAS/sv_adjAbun_ba_volcano.pdf", height = 4, width = 7)
print(p_sv_ba_volcano)
dev.off()

#print(p_sv_ba_volcano)


```

### 2.3 Replication

#### 2.3.1 vSV

```{r 2.3.1}
## Correlation of effect size between LLD and 300OB
vsv_ba_lm_adjAbun_res.sig.edge_r_density <- get_density(vsv_ba_lm_adjAbun_res.sig.edge$LLD.Beta, vsv_ba_lm_adjAbun_res.sig.edge$X300OB.Beta, n = 200)

es_cor<-cor.test(vsv_ba_lm_adjAbun_res.sig.edge$LLD.Beta, vsv_ba_lm_adjAbun_res.sig.edge$X300OB.Beta,method = "spearman")
text_r<-paste("R=",round(es_cor$estimate,digits = 2),
              ", P<2.20e-16",
              sep = "")

p_vsv_ba_es<-ggplot(vsv_ba_lm_adjAbun_res.sig.edge) + 
  geom_point(aes(LLD.Beta, X300OB.Beta, color = vsv_ba_lm_adjAbun_res.sig.edge_r_density),alpha = 0.25) +
  #geom_smooth(data=vsv_ba_lm_adjAbun_res.sig.edge,aes(LLD.Beta,X300OB.Beta),method = "lm_adjAbun", color = "white", alpha = 0.2,size = 0.5)+
  annotate("text",x = c(-0.5), y = c(0.5), label = c(text_r),hjust = 0)+
  geom_hline(yintercept=0, linetype="dashed",  color = "red", size=1, alpha = 0.5)+
  geom_vline(xintercept=0, linetype="dashed",  color = "red", size=1, alpha = 0.5)+
  xlab('Effect size in LLD')+
  ylab('Effect size in 300OB')+
  scale_color_viridis()+
  theme_bw()+
  theme(legend.position = 'none')

## Correlation of effect size between LLD and 300OB
vsv_ba_lm_adjAbun_res.sig.edge_p_density <- get_density(log10(vsv_ba_lm_adjAbun_res.sig.edge$LLD.p), log10(vsv_ba_lm_adjAbun_res.sig.edge$X300OB.p), n = 200)

p_cor<-cor.test(log10(vsv_ba_lm_adjAbun_res.sig.edge$LLD.p), log10(vsv_ba_lm_adjAbun_res.sig.edge$X300OB.p),method = "spearman")
text_p<-paste("R=",round(p_cor$estimate,digits = 2),
              ", P<2.20e-16",
              sep = "")

p_vsv_ba_p<-ggplot(vsv_ba_lm_adjAbun_res.sig.edge) + 
  geom_point(aes(LLD.p, X300OB.p, color = vsv_ba_lm_adjAbun_res.sig.edge_p_density),alpha = 0.25) +
  #geom_smooth(data=vsv_ba_lm_adjAbun_res.sig.edge,aes(log10(LLD.p),log10(X300OB.p)),method = "lm_adjAbun", color = "white", alpha = 0.2,size = 0.5)+
  annotate("text",x = c(1e-21), y = c(1e-3), label = c(text_p),hjust = 0)+
  xlab('P-value in LLD')+
  ylab('P-value in 300OB')+
  scale_x_log10()+
  scale_y_log10()+
  scale_color_viridis()+
  theme_bw()+
  theme(legend.position = 'none')
```

#### 2.3.2 dSV

```{r 2.3.2}
## Correlation of effect size between LLD and 300OB
dsv_ba_lm_adjAbun_res.sig.edge_r_density <- get_density(dsv_ba_lm_adjAbun_res.sig.edge$LLD.Beta, dsv_ba_lm_adjAbun_res.sig.edge$X300OB.Beta, n = 200)

es_cor<-cor.test(dsv_ba_lm_adjAbun_res.sig.edge$LLD.Beta, dsv_ba_lm_adjAbun_res.sig.edge$X300OB.Beta,method = "spearman")
text_r<-paste("R=",round(es_cor$estimate,digits = 2),
              ", P<2.20e-16",
              sep = "")

p_dsv_ba_es<-ggplot(dsv_ba_lm_adjAbun_res.sig.edge) + 
  geom_point(aes(LLD.Beta, X300OB.Beta, color = dsv_ba_lm_adjAbun_res.sig.edge_r_density),alpha = 0.25) +
  #geom_smooth(data=dsv_ba_lm_adjAbun_res.sig.edge,aes(LLD.Beta,X300OB.Beta),method = "lm_adjAbun", color = "white", alpha = 0.2,size = 0.5)+
  annotate("text",x = c(-0.5), y = c(0.5), label = c(text_r),hjust = 0)+
  geom_hline(yintercept=0, linetype="dashed",  color = "red", size=1, alpha = 0.5)+
  geom_vline(xintercept=0, linetype="dashed",  color = "red", size=1, alpha = 0.5)+
  xlab('Effect size in LLD')+
  ylab('Effect size in 300OB')+
  scale_color_viridis()+
  theme_bw()+
  theme(legend.position = 'none')

## Correlation of effect size between LLD and 300OB
dsv_ba_lm_adjAbun_res.sig.edge_p_density <- get_density(log10(dsv_ba_lm_adjAbun_res.sig.edge$LLD.p), log10(dsv_ba_lm_adjAbun_res.sig.edge$X300OB.p), n = 200)

p_cor<-cor.test(log10(dsv_ba_lm_adjAbun_res.sig.edge$LLD.p), log10(dsv_ba_lm_adjAbun_res.sig.edge$X300OB.p),method = "spearman")
text_p<-paste("R=",round(p_cor$estimate,digits = 2),
              ", P=",formatC(p_cor$p.value, format = "e", digits = 2),
              sep = "")

p_dsv_ba_p<-ggplot(dsv_ba_lm_adjAbun_res.sig.edge) + 
  geom_point(aes(LLD.p, X300OB.p, color = dsv_ba_lm_adjAbun_res.sig.edge_p_density),alpha = 0.25) +
  #geom_smooth(data=dsv_ba_lm_adjAbun_res.sig.edge,aes(log10(LLD.p),log10(X300OB.p)),method = "lm_adjAbun", color = "white", alpha = 0.2,size = 0.5)+
  annotate("text",x = c(1e-21), y = c(1e-3), label = c(text_p),hjust = 0)+
  xlab('P-value in LLD')+
  ylab('P-value in 300OB')+
  scale_x_log10()+
  scale_y_log10()+
  scale_color_viridis()+
  theme_bw()+
  theme(legend.position = 'none')
```

#### 2.3.3 Combine figure

```{R 2.3.3, fig.height = 7, fig.width = 7}
## plot
p_title_replic <- ggdraw() + 
    draw_label(
      'Replication',
      fontface = 'bold', x = 0, hjust = 0) +
    theme(
      # add margin on the left of the drawing canvas,
      # so title is aligned with left edge of first plot
      plot.margin = margin(0, 0, 0, 7))

p_sv_ba_replic<-plot_grid(
    p_title_replic, 
    plot_grid(p_vsv_ba_es,p_dsv_ba_es,p_vsv_ba_p,p_dsv_ba_p,
              rel_widths = c(1, 1, 1, 1),align = 'hv',
              labels = c("vSVs-BAs Effect size", "dSVs-BAs Effect size",
                         "vSVs-BAs P-value", "dSVs-BAs P-value"),
              ncol = 2,label_size	= 8,vjust = 0),
    ncol = 1,
    # rel_heights values control vertical title margins
    rel_heights = c(0.1, 2)
  )

if(!dir.exists("09.Microbial_GWAS/")){dir.create("09.Microbial_GWAS/")}
pdf("09.Microbial_GWAS/sv_ba_lm_adjAbun_scatter.pdf", height = 7, width = 7)
print(p_sv_ba_replic)
dev.off()

print(p_sv_ba_replic)
```

## 3 Visualization
### 3.1 vSV associations
#### 3.1.1 Heatmap

```{r 3.1.1}
all_vsv_ba_lm_adjAbun.r    <- all_vsv_ba_lm_adjAbun_res$beta
all_vsv_ba_lm_adjAbun.p    <- all_vsv_ba_lm_adjAbun_res$p
all_vsv_ba_lm_adjAbun.fdr  <- all_vsv_ba_lm_adjAbun_res$fdr
all_vsv_ba_lm_adjAbun.bon  <- all_vsv_ba_lm_adjAbun_res$bonferroni

lld_vsv_ba_lm_adjAbun.p    <- lld_vsv_ba_lm_adjAbun_res$p
lld_vsv_ba_lm_adjAbun.r    <- lld_vsv_ba_lm_adjAbun_res$beta

ob_vsv_ba_lm_adjAbun.p     <- ob_vsv_ba_lm_adjAbun_res$p
ob_vsv_ba_lm_adjAbun.r     <- ob_vsv_ba_lm_adjAbun_res$beta

vsv_ba_lm_adjAbun_res.sig.edge.plot<-vsv_ba_lm_adjAbun_res.edge[
    vsv_ba_lm_adjAbun_res.edge$Meta.fdr.p < 0.05 & 
    vsv_ba_lm_adjAbun_res.edge$LLD.p < 0.05 &
    vsv_ba_lm_adjAbun_res.edge$X300OB.p < 0.05 &
    vsv_ba_lm_adjAbun_res.edge$LLD.Beta*vsv_ba_lm_adjAbun_res.edge$X300OB.Beta>0 &
    abs(vsv_ba_lm_adjAbun_res.edge$Meta.beta)>0.1 &
    vsv_ba_lm_adjAbun_res.edge$Meta.hetero.p>0.05,]

all_vsv_ba_lm_adjAbun.sign<-as.data.frame(matrix(NA,ncol = ncol(all_vsv_ba_lm_adjAbun.p),nrow = nrow(all_vsv_ba_lm_adjAbun.p)))
colnames(all_vsv_ba_lm_adjAbun.sign)<-colnames(all_vsv_ba_lm_adjAbun.p); rownames(all_vsv_ba_lm_adjAbun.sign)<-rownames(all_vsv_ba_lm_adjAbun.p)
all_vsv_ba_lm_adjAbun.sign[all_vsv_ba_lm_adjAbun.p    < 0.05 & (lld_vsv_ba_lm_adjAbun.p<0.05 & ob_vsv_ba_lm_adjAbun.p < 0.05) & (lld_vsv_ba_lm_adjAbun.r * ob_vsv_ba_lm_adjAbun.r > 0)] <- "*" 
all_vsv_ba_lm_adjAbun.sign[all_vsv_ba_lm_adjAbun.fdr < 0.05  & (lld_vsv_ba_lm_adjAbun.p<0.05 & ob_vsv_ba_lm_adjAbun.p < 0.05) & (lld_vsv_ba_lm_adjAbun.r * ob_vsv_ba_lm_adjAbun.r > 0)] <- "☆" 
all_vsv_ba_lm_adjAbun.sign[all_vsv_ba_lm_adjAbun.bon < 0.05  & (lld_vsv_ba_lm_adjAbun.p<0.05 & ob_vsv_ba_lm_adjAbun.p < 0.05) & (lld_vsv_ba_lm_adjAbun.r * ob_vsv_ba_lm_adjAbun.r > 0)] <- "★" 

vsv_ba_lm_adjAbun.plot.ba  <- vsv_ba_lm_adjAbun_res.sig.edge.plot$BA %>%
  as.character(.) %>%
  .[!duplicated(.)]
vsv_ba_lm_adjAbun.plot.vsv <- vsv_ba_lm_adjAbun_res.sig.edge.plot$SV %>%
  as.character(.) %>%
  .[!duplicated(.)] %>%
  sort(.,decreasing = F)


vsv_ba_lm_adjAbun.r.plot    <- all_vsv_ba_lm_adjAbun.r %>%
  .[match(vsv_ba_lm_adjAbun.plot.vsv,rownames(.)),match(vsv_ba_lm_adjAbun.plot.ba,colnames(.))]
vsv_ba_lm_adjAbun.sign.plot <- all_vsv_ba_lm_adjAbun.sign %>%
  .[match(vsv_ba_lm_adjAbun.plot.vsv,rownames(.)),match(vsv_ba_lm_adjAbun.plot.ba,colnames(.))]


i  <- 256
myBreaks <- c(seq(min(vsv_ba_lm_adjAbun.r.plot), 0, length.out=ceiling(i/2) + 1), 
              seq(max(vsv_ba_lm_adjAbun.r.plot)/i, max(vsv_ba_lm_adjAbun.r.plot), length.out=floor(i/2)))
pdf("09.Microbial_GWAS/vsv_ba_lm_adjAbun.heatmap.pdf", width = 10, height = 32)
 heatmap.2(vsv_ba_lm_adjAbun.r.plot,
          col=colorRampPalette(c("#02CBFB","#FFFFFF","#F20C34"))(i), breaks = ,
          trace = "none", Rowv = F, Colv = F, dendrogram = "none",
          density.info="none",
          cexCol = 1, srtCol = 45, cexRow = 1,
          cellnote = vsv_ba_lm_adjAbun.sign.plot, notecol = "grey50",notecex = 1,
          #colRow = vsgv_ba_lm_adjAbun.vsgv.color,
          key.xlab = "Beta coefficient",
          key.par=list(mar=c(5,0,3,0), cex.axis = 1, cex.lab = 1), 
          lm=rbind( c(0, 4, 3), c(2, 1, 0 )), lhei = c(0.5, 11),lwid=c(0.5, 3.4, 2.6 ),key.title = NA,
          margins=c(10,1) # ("margin.Y", "margin.X")
)
dev.off()
```
#### 3.1.2 Circos plot

```{r 3.1.2}
vsv_ba_lm_adjAbun.sig.ba  <- vsv_ba_lm_adjAbun_res.sig.edge$BA %>%
  as.character(.) %>%
  .[!duplicated(.)]
vsv_ba_lm_adjAbun.sig.vsv <- vsv_ba_lm_adjAbun_res.sig.edge$SV %>%
  as.character(.) %>%
  .[!duplicated(.)] %>%
  sort(.,decreasing = F)


## circos plot
vsv_ba_count<-NULL
for (pheno in vsv_ba_lm_adjAbun.sig.ba) {
  #pheno <-"C4"
  vsv_ba_df<-vsv_ba_lm_adjAbun_res.sig.edge[vsv_ba_lm_adjAbun_res.sig.edge$BA==pheno,]$SV %>%
    str_replace_all(.,"\\:\\d+_\\d+.*", "") %>%
    table %>%
    as.data.frame
  colnames(vsv_ba_df)<-c("Species", "Count")
  vsv_ba_df<-data.frame(BA = rep(pheno,nrow(vsv_ba_df)), vsv_ba_df)
  vsv_ba_count<-rbind(vsv_ba_count,vsv_ba_df)
}

vsv_ba_count$Species<-info$Short_name[match(vsv_ba_count$Species, info$organism)]
vsv_ba_count <- vsv_ba_count[order(vsv_ba_count$Count),]

vsv_ba_count_species_order<-vsv_ba_count %>% group_by(Species) %>% summarise(sum(Count)) %>% .[order(.$`sum(Count)`, decreasing = T),]
vsv_ba_count_ba_order<-vsv_ba_count %>% group_by(BA) %>% summarise(sum(Count)) %>% .[order(.$`sum(Count)`, decreasing = T),]

vsv_ba_count<-vsv_ba_count[order(match(vsv_ba_count$BA, vsv_ba_count_ba_order$BA),decreasing = T),]
#vsv_ba_count<-vsv_ba_count[order(match(vsv_ba_count$Species, vsv_ba_count_species_order$Species),decreasing = T),]


vsv_ba_count_species_order_str<-as.character(vsv_ba_count_species_order$Species)
vsv_ba_count_ba_order_str<-as.character(vsv_ba_count_ba_order$BA)



pdf("09.Microbial_GWAS/vsv_ba_lm_adjAbun.circos.pdf", width = 23, height = 23)
circos.par(start.degree = 0)
chordDiagram(vsv_ba_count,annotationTrack = "grid",
             grid.col =  c(wes_palette("Darjeeling1", length(vsv_ba_count_ba_order_str), type = "continuous"),rep('grey',length(vsv_ba_count_species_order_str))),
             order = c(rev(vsv_ba_count_ba_order_str),rev(vsv_ba_count_species_order_str)),
             big.gap = 10,
             preAllocateTracks = list(track.margin = c(0, uh(70, "mm")), 
                                      track.height = max(strwidth(unlist(dimnames(vsv_ba_count)))))
             )
circos.track(track.index = 1, panel.fun = function(x, y) {
  circos.text(CELL_META$xcenter, CELL_META$ylim[1], CELL_META$sector.index,cex = 0.5,
              #label = log(c(vsv_ba_count_ba_order$`sum(Count)`,vsv_ba_count_species_order$`sum(Count)`))+0.5,
              facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

dev.off()
circos.clear()
```



### 3.2 dSV associations

#### 3.2.1 Heatmap

```{r 3.2.1}
all_dsv_ba_lm_adjAbun.r    <- all_dsv_ba_lm_adjAbun_res$beta
all_dsv_ba_lm_adjAbun.p    <- all_dsv_ba_lm_adjAbun_res$p
all_dsv_ba_lm_adjAbun.fdr  <- all_dsv_ba_lm_adjAbun_res$fdr
all_dsv_ba_lm_adjAbun.bon  <- all_dsv_ba_lm_adjAbun_res$bonferroni

lld_dsv_ba_lm_adjAbun.p    <- lld_dsv_ba_lm_adjAbun_res$p
lld_dsv_ba_lm_adjAbun.r    <- lld_dsv_ba_lm_adjAbun_res$beta

ob_dsv_ba_lm_adjAbun.p     <- ob_dsv_ba_lm_adjAbun_res$p
ob_dsv_ba_lm_adjAbun.r     <- ob_dsv_ba_lm_adjAbun_res$beta

dsv_ba_lm_adjAbun_res.sig.edge.plot<-dsv_ba_lm_adjAbun_res.edge[
  dsv_ba_lm_adjAbun_res.edge$Meta.fdr.p < 0.05 & 
    dsv_ba_lm_adjAbun_res.edge$LLD.p < 0.05 &
    dsv_ba_lm_adjAbun_res.edge$X300OB.p < 0.05 &
    dsv_ba_lm_adjAbun_res.edge$LLD.Beta*dsv_ba_lm_adjAbun_res.edge$X300OB.Beta>0 &
    abs(dsv_ba_lm_adjAbun_res.edge$Meta.beta)>0.1 &
    dsv_ba_lm_adjAbun_res.edge$Meta.hetero.p>0.05,]

all_dsv_ba_lm_adjAbun.sign<-as.data.frame(matrix(NA,ncol = ncol(all_dsv_ba_lm_adjAbun.p),nrow = nrow(all_dsv_ba_lm_adjAbun.p)))
colnames(all_dsv_ba_lm_adjAbun.sign)<-colnames(all_dsv_ba_lm_adjAbun.p); rownames(all_dsv_ba_lm_adjAbun.sign)<-rownames(all_dsv_ba_lm_adjAbun.p)
all_dsv_ba_lm_adjAbun.sign[all_dsv_ba_lm_adjAbun.p    < 0.05 & (lld_dsv_ba_lm_adjAbun.p<0.05 & ob_dsv_ba_lm_adjAbun.p < 0.05) & (lld_dsv_ba_lm_adjAbun.r * ob_dsv_ba_lm_adjAbun.r > 0) ] <- "*" 
all_dsv_ba_lm_adjAbun.sign[all_dsv_ba_lm_adjAbun.fdr < 0.05  & (lld_dsv_ba_lm_adjAbun.p<0.05 & ob_dsv_ba_lm_adjAbun.p < 0.05) & (lld_dsv_ba_lm_adjAbun.r * ob_dsv_ba_lm_adjAbun.r > 0) ] <- "☆" 
all_dsv_ba_lm_adjAbun.sign[all_dsv_ba_lm_adjAbun.bon < 0.05  & (lld_dsv_ba_lm_adjAbun.p<0.05 & ob_dsv_ba_lm_adjAbun.p < 0.05) & (lld_dsv_ba_lm_adjAbun.r * ob_dsv_ba_lm_adjAbun.r > 0) ] <- "★" 

dsv_ba_lm_adjAbun.plot.ba  <- dsv_ba_lm_adjAbun_res.sig.edge.plot$BA %>%
  as.character(.) %>%
  .[!duplicated(.)]
dsv_ba_lm_adjAbun.plot.dsv <- dsv_ba_lm_adjAbun_res.sig.edge.plot$SV %>%
  as.character(.) %>%
  .[!duplicated(.)] %>%
  sort(.,decreasing = F)


dsv_ba_lm_adjAbun.r.plot    <- all_dsv_ba_lm_adjAbun.r %>%
  .[match(dsv_ba_lm_adjAbun.plot.dsv,rownames(.)),match(dsv_ba_lm_adjAbun.plot.ba,colnames(.))]
dsv_ba_lm_adjAbun.sign.plot <- all_dsv_ba_lm_adjAbun.sign %>%
  .[match(dsv_ba_lm_adjAbun.plot.dsv,rownames(.)),match(dsv_ba_lm_adjAbun.plot.ba,colnames(.))]


i  <- 256
myBreaks <- c(seq(min(dsv_ba_lm_adjAbun.r.plot), 0, length.out=ceiling(i/2) + 1), 
              seq(max(dsv_ba_lm_adjAbun.r.plot)/i, max(dsv_ba_lm_adjAbun.r.plot), length.out=floor(i/2)))
pdf("09.Microbial_GWAS/dsv_ba_lm_adjAbun.heatmap.pdf", width = 8, height = 7)
 heatmap.2(dsv_ba_lm_adjAbun.r.plot,
          col=colorRampPalette(c("#02CBFB","#FFFFFF","#F20C34"))(i), breaks = ,
          trace = "none", Rowv = F, Colv = F, dendrogram = "none",
          density.info="none",
          cexCol = 1, srtCol = 45, cexRow = 1,
          cellnote = dsv_ba_lm_adjAbun.sign.plot, notecol = "grey50",notecex = 1,
          #colRow = vsgv_ba_lm_adjAbun.vsgv.color,
          #key.xlab = "High in retained             ←  Beta coefficient  →             High in deleted",
          key.xlab = "Beta coefficient",
          key.par=list(mar=c(4,0,3,0), cex.axis = 1, cex.lab = 1), 
          lm=rbind( c(0, 4, 3), c(2, 1, 0 )), lhei = c(0.8, 4),lwid=c(0.5, 3, 4 ),key.title = NA,
          margins=c(10,1) # ("margin.Y", "margin.X")
)
dev.off()

```

#### 3.2.2 Circos plot

```{r 3.2.2}
dsv_ba_lm_adjAbun.sig.ba  <- dsv_ba_lm_adjAbun_res.sig.edge$BA %>%
  as.character(.) %>%
  .[!duplicated(.)]
dsv_ba_lm_adjAbun.sig.dsv <- dsv_ba_lm_adjAbun_res.sig.edge$SV %>%
  as.character(.) %>%
  .[!duplicated(.)] %>%
  sort(.,decreasing = F)


## circos plot
dsv_ba_count<-NULL
for (pheno in dsv_ba_lm_adjAbun.sig.ba) {
  #pheno <-"C4"
  dsv_ba_df<-dsv_ba_lm_adjAbun_res.sig.edge[dsv_ba_lm_adjAbun_res.sig.edge$BA==pheno,]$SV %>%
    str_replace_all(.,"\\:\\d+_\\d+.*", "") %>%
    table %>%
    as.data.frame
  colnames(dsv_ba_df)<-c("Species", "Count")
  dsv_ba_df<-data.frame(BA = rep(pheno,nrow(dsv_ba_df)), dsv_ba_df)
  dsv_ba_count<-rbind(dsv_ba_count,dsv_ba_df)
}

dsv_ba_count$Species<-info$Short_name[match(dsv_ba_count$Species, info$organism)]
dsv_ba_count <- dsv_ba_count[order(dsv_ba_count$Count),]

dsv_ba_count_species_order<-dsv_ba_count %>% group_by(Species) %>% summarise(sum(Count)) %>% .[order(.$`sum(Count)`, decreasing = T),]
dsv_ba_count_ba_order<-dsv_ba_count %>% group_by(BA) %>% summarise(sum(Count)) %>% .[order(.$`sum(Count)`, decreasing = T),]

dsv_ba_count<-dsv_ba_count[order(match(dsv_ba_count$BA, dsv_ba_count_ba_order$BA),decreasing = T),]
#dsv_ba_count<-dsv_ba_count[order(match(dsv_ba_count$Species, dsv_ba_count_species_order$Species),decreasing = T),]


dsv_ba_count_species_order_str<-as.character(dsv_ba_count_species_order$Species)
dsv_ba_count_ba_order_str<-as.character(dsv_ba_count_ba_order$BA)



pdf("09.Microbial_GWAS/dsv_ba_lm_adjAbun.circos.pdf", width = 20, height = 20)
circos.par(start.degree = 0)
chordDiagram(dsv_ba_count,annotationTrack = "grid",
             grid.col =  c(wes_palette("Darjeeling1", length(dsv_ba_count_ba_order_str), type = "continuous"),rep('grey',length(dsv_ba_count_species_order_str))),
             order = c(rev(dsv_ba_count_ba_order_str),rev(dsv_ba_count_species_order_str)),
             big.gap = 10,
             preAllocateTracks = list(track.margin = c(0, uh(70, "mm")), 
                                      track.height = max(strwidth(unlist(dimnames(dsv_ba_count)))))
             )
circos.track(track.index = 1, panel.fun = function(x, y) {
  circos.text(CELL_META$xcenter, CELL_META$ylim[1], CELL_META$sector.index,
              #label = log(c(dsv_ba_count_ba_order$`sum(Count)`,dsv_ba_count_species_order$`sum(Count)`))+0.5,
              facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

dev.off()
circos.clear()
```






### 3.3 Combine vSV and dSV associations

```{r 3.3}
sv_ba_lm_adjAbun_res.sig.edge<-rbind(vsv_ba_lm_adjAbun_res.sig.edge,dsv_ba_lm_adjAbun_res.sig.edge)

sv_ba_lm_adjAbun.sig.ba  <- sv_ba_lm_adjAbun_res.sig.edge$BA %>%
  as.character(.) %>%
  .[!duplicated(.)]
sv_ba_lm_adjAbun.sig.sv <- sv_ba_lm_adjAbun_res.sig.edge$SV %>%
  as.character(.) %>%
  .[!duplicated(.)] %>%
  sort(.,decreasing = F)


## circos plot
sv_ba_count<-NULL
for (pheno in sv_ba_lm_adjAbun.sig.ba) {
  #pheno <-"C4"
  sv_ba_df<-sv_ba_lm_adjAbun_res.sig.edge[sv_ba_lm_adjAbun_res.sig.edge$BA==pheno,]$SV %>%
    str_replace_all(.,"\\:\\d+_\\d+.*", "") %>%
    table %>%
    as.data.frame
  colnames(sv_ba_df)<-c("Species", "Count")
  sv_ba_df<-data.frame(BA = rep(pheno,nrow(sv_ba_df)), sv_ba_df)
  sv_ba_count<-rbind(sv_ba_count,sv_ba_df)
}

sv_ba_count$Species<-info$Short_name[match(sv_ba_count$Species, info$organism)]
sv_ba_count <- sv_ba_count[order(sv_ba_count$Count),]

sv_ba_count_species_order<-sv_ba_count %>% group_by(Species) %>% summarise(sum(Count)) %>% .[order(.$`sum(Count)`, decreasing = T),]
sv_ba_count_ba_order<-sv_ba_count %>% group_by(BA) %>% summarise(sum(Count)) %>% .[order(.$`sum(Count)`, decreasing = T),]

sv_ba_count<-sv_ba_count[order(match(sv_ba_count$BA, sv_ba_count_ba_order$BA),decreasing = T),]
#sv_ba_count<-sv_ba_count[order(match(sv_ba_count$Species, sv_ba_count_species_order$Species),decreasing = T),]


sv_ba_count_species_order_str<-as.character(sv_ba_count_species_order$Species)
sv_ba_count_ba_order_str<-as.character(sv_ba_count_ba_order$BA)



pdf("09.Microbial_GWAS/sv_ba_lm_adjAbun.circos.pdf", width = 26, height = 26)
circos.par(start.degree = 0, "clock.wise" = F) # ,xaxis.clock.wise = F
chordDiagram(sv_ba_count,annotationTrack = "grid",
             grid.col =  c(rev(wes_palette("Darjeeling1", length(sv_ba_count_ba_order_str), type = "continuous")),
                           rep('grey',length(sv_ba_count_species_order_str))),
             order = c(sv_ba_count_ba_order_str,
                       rev(sv_ba_count_species_order_str)),
             big.gap = 5,
             preAllocateTracks = list(track.margin = c(0, uh(90, "mm")), 
                                      track.height = max(strwidth(unlist(dimnames(sv_ba_count)))))
             )
circos.track(track.index = 1, panel.fun = function(x, y) {
  circos.text(CELL_META$xcenter, CELL_META$ylim[1], CELL_META$sector.index,cex = 2.5,
              facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

dev.off()
circos.clear()
```


## 4 Examples

### 4.1 Heatmap of certain species

```{r 4.1}
all_sv_ba_lm_adjAbun.r    <- rbind(all_vsv_ba_lm_adjAbun_res$beta,all_dsv_ba_lm_adjAbun_res$beta)
all_sv_ba_lm_adjAbun.p    <- rbind(all_vsv_ba_lm_adjAbun_res$p,all_dsv_ba_lm_adjAbun_res$p)
all_sv_ba_lm_adjAbun.fdr  <- rbind(all_vsv_ba_lm_adjAbun_res$fdr,all_dsv_ba_lm_adjAbun_res$fdr)
all_sv_ba_lm_adjAbun.bon  <- rbind(all_vsv_ba_lm_adjAbun_res$bonferroni,all_dsv_ba_lm_adjAbun_res$bonferroni)

lld_sv_ba_lm_adjAbun.p    <- rbind(lld_vsv_ba_lm_adjAbun_res$p, lld_dsv_ba_lm_adjAbun_res$p)
lld_sv_ba_lm_adjAbun.r    <- rbind(lld_vsv_ba_lm_adjAbun_res$beta, lld_dsv_ba_lm_adjAbun_res$beta)

ob_sv_ba_lm_adjAbun.p    <- rbind(ob_vsv_ba_lm_adjAbun_res$p, ob_dsv_ba_lm_adjAbun_res$p)
ob_sv_ba_lm_adjAbun.r    <- rbind(ob_vsv_ba_lm_adjAbun_res$beta, ob_dsv_ba_lm_adjAbun_res$beta)

sv_ba_lm_adjAbun_res.edge<-rbind(vsv_ba_lm_adjAbun_res.edge, dsv_ba_lm_adjAbun_res.edge)

sv_ba_lm_adjAbun_res.sig.edge.plot<-sv_ba_lm_adjAbun_res.edge[
  sv_ba_lm_adjAbun_res.edge$Meta.fdr.p < 0.05 & 
    sv_ba_lm_adjAbun_res.edge$LLD.p < 0.05 &
    sv_ba_lm_adjAbun_res.edge$X300OB.p < 0.05 &
    sv_ba_lm_adjAbun_res.edge$LLD.Beta*sv_ba_lm_adjAbun_res.edge$X300OB.Beta>0 &
    # abs(sv_ba_lm_adjAbun_res.edge$Meta.beta)>0.1 &
    grepl("wexlerae",sv_ba_lm_adjAbun_res.edge$SV) &
    sv_ba_lm_adjAbun_res.edge$Meta.hetero.p>0.05,]

all_sv_ba_lm_adjAbun.sign<-as.data.frame(matrix(NA,ncol = ncol(all_sv_ba_lm_adjAbun.p),nrow = nrow(all_sv_ba_lm_adjAbun.p)))
#colnames(all_sv_ba_lm_adjAbun.sign)<-colnames(all_sv_ba_lm_adjAbun.p); rownames(all_sv_ba_lm_adjAbun.sign)<-rownames(all_sv_ba_lm_adjAbun.p)
all_sv_ba_lm_adjAbun.sign[all_sv_ba_lm_adjAbun.p    < 0.05 & (lld_sv_ba_lm_adjAbun.p<0.05 & ob_sv_ba_lm_adjAbun.p < 0.05) & (lld_sv_ba_lm_adjAbun.r * ob_sv_ba_lm_adjAbun.r > 0) ] <- "*" 
all_sv_ba_lm_adjAbun.sign[all_sv_ba_lm_adjAbun.fdr < 0.05  & (lld_sv_ba_lm_adjAbun.p<0.05 & ob_sv_ba_lm_adjAbun.p < 0.05) & (lld_sv_ba_lm_adjAbun.r * ob_sv_ba_lm_adjAbun.r > 0) ] <- "☆" 
all_sv_ba_lm_adjAbun.sign[all_sv_ba_lm_adjAbun.bon < 0.05  & (lld_sv_ba_lm_adjAbun.p<0.05 & ob_sv_ba_lm_adjAbun.p < 0.05) & (lld_sv_ba_lm_adjAbun.r * ob_sv_ba_lm_adjAbun.r > 0) ] <- "★" 

sv_ba_lm_adjAbun.plot.ba  <- sv_ba_lm_adjAbun_res.sig.edge.plot$BA %>%
  as.character(.) %>%
  .[!duplicated(.)]
sv_ba_lm_adjAbun.plot.sv <- sv_ba_lm_adjAbun_res.sig.edge.plot$SV %>%
  as.character(.) %>%
  .[!duplicated(.)] %>%
  sort(.,decreasing = F)


sv_ba_lm_adjAbun.r.plot    <- all_sv_ba_lm_adjAbun.r %>%
  .[match(sv_ba_lm_adjAbun.plot.sv,rownames(.)),match(sv_ba_lm_adjAbun.plot.ba,colnames(.))]
sv_ba_lm_adjAbun.sign.plot <- all_sv_ba_lm_adjAbun.sign %>%
  .[match(sv_ba_lm_adjAbun.plot.sv,rownames(all_sv_ba_lm_adjAbun.r)),
    match(sv_ba_lm_adjAbun.plot.ba,colnames(all_sv_ba_lm_adjAbun.r))]

rownames(sv_ba_lm_adjAbun.r.plot)<-str_replace_all(rownames(sv_ba_lm_adjAbun.r.plot), "Blautia wexlerae DSM 19850:", "")


i  <- 256
myBreaks <- c(seq(min(sv_ba_lm_adjAbun.r.plot), 0, length.out=ceiling(i/2) + 1), 
              seq(max(sv_ba_lm_adjAbun.r.plot)/i, max(sv_ba_lm_adjAbun.r.plot), length.out=floor(i/2)))
pdf("09.Microbial_GWAS/B.wexlerae_sv_ba_lm_adjAbun.heatmap.pdf", width = 6, height = 10)
 heatmap.2(sv_ba_lm_adjAbun.r.plot,
          col=colorRampPalette(c("#02CBFB","#FFFFFF","#F20C34"))(i), breaks = ,
          trace = "none", Rowv = F, Colv = F, dendrogram = "none",
          density.info="none",
          cexCol = 1, srtCol = 45, cexRow = 1,
          cellnote = sv_ba_lm_adjAbun.sign.plot, notecol = "grey50",notecex = 1,
          #colRow = vsgv_ba_lm_adjAbun.vsgv.color,
          #key.xlab = "High in retained             ←  Beta coefficient  →             High in deleted",
          key.xlab = "Beta coefficient",
          key.par=list(mar=c(4,4,6.5,4), cex.axis = 1, cex.lab = 1), 
          lm=rbind( c(0, 4, 3), c(2, 1, 0 )), lhei = c(0.8, 4),lwid=c(0.5, 4, 2 ),key.title = NA,
          margins=c(10,1) # ("margin.Y", "margin.X")
)
dev.off()

```

### 4.2 Scatter plots

```{r 4.2}
all_abun_clr<-abundances(x=as.data.frame(na.omit(all_abun)), transform="clr") %>%as.data.frame
all_abun_clr <- all_abun_clr[match(rownames(all_abun), rownames(all_abun_clr)),]
rownames(all_abun_clr) <- rownames(all_abun)

## Most significant association:Coprococcus.comes.ATCC.27758.2932_2935.2935_2937) and secondary primary BA ratio
df<-data.frame(phen = all_ba$Secondary_primary_ratio, 
               all_covar,
               Cohort = all_basic$Cohort,
               sv=all_vsv$`Coprococcus comes ATCC 27758:2932_2935;2935_2937`,
               abun = all_abun_clr$s__Coprococcus_comes) %>% 
  na.omit

df[,c(1,2,3,4,6,8,11,12)] <- apply(df[,c(1,2,3,4,6,8,11,12)], 2, qtrans) %>% 
  as.data.frame

df_lm<- summary(lm(phen~Age+Gender+Cohort+BMI+Reads_number+abun,data = df))

df_density <- get_density(df_lm$residuals, df$sv, n = 200)

es_cor<-cor.test(df_lm$residuals, df$sv, method = "spearman")
text_r<-paste("C.comes:2932_2935;2935_2937","Beta=0.36, P=4.77E-34",sep = "\n")

pdf("09.Microbial_GWAS/Example_C.comes_2932_Secondary_primary_ratio.pdf", height = 4, width = 4.5)
ggplot(df, aes(sv, phen,color = Cohort.1))+
  geom_point(size = 3,alpha = 0.5)+
  geom_smooth(method = 'lm', color = 'white', linetype = 'dashed')+
  scale_color_manual(breaks = c("LLD","300OB"),
                     labels = c("LLD", "300OB"),
                     values = mycolor2_blue_yellow)+
  ggtitle(text_r)+
  xlab("Standardized region coverage")+
  ylab("Residuals of Secondary/primary BA ratio")+
  theme_classic2()+
  theme(legend.position = 'none',
        plot.title = element_text(hjust = 0.5,size = 10))

dev.off()

## Most significant association in B.wexlerae: 1715_1716 and CA_dehydro_deconju_ratio
df<-data.frame(phen = all_ba$CA_dehydro_deconju_ratio, 
               all_covar,
               Cohort = all_basic$Cohort,
               sv=all_vsv$`Blautia wexlerae DSM 19850:1715_1716`,
               abun = all_abun_clr$s__Blautia_wexlerae) %>% 
  na.omit

df[,c(1,2,3,4,6,8,11,12)] <- apply(df[,c(1,2,3,4,6,8,11,12)], 2, qtrans) %>% 
  as.data.frame

df_lm<- summary(lm(phen~Age+Gender+Cohort+BMI+Reads_number+abun,data = df))

df_density <- get_density(df_lm$residuals, df$sv, n = 200)

es_cor<-cor.test(df_lm$residuals, df$sv, method = "spearman")
text_r<-paste("B.wexlerae:1715_1716","Beta=-0.29, P=2.18E-23",sep = "\n")

pdf("09.Microbial_GWAS/Example_B.wexlerae_1715_CA_dehydro_deconju_ratio.pdf", height = 4, width = 4.5)
ggplot(df, aes(sv, phen,color = Cohort.1))+
  geom_point(size = 3,alpha = 0.5)+
  geom_smooth(method = 'lm', color = 'white', linetype = 'dashed')+
  scale_color_manual(breaks = c("LLD","300OB"),
                     labels = c("LLD", "300OB"),
                     values = mycolor2_blue_yellow)+
  ggtitle(text_r)+
  xlab("Standardized region coverage")+
  ylab("Residuals of CA dehydroxylation/deconjugation ratio")+
  theme_classic2()+
  theme(legend.position = 'none',
        plot.title = element_text(hjust = 0.5,size = 10))

dev.off()



## Secondly significant association:Coprococcus.comes.ATCC.27758.2932_2935.2935_2937) and secondary primary BA ratio
df<-data.frame(phen = all_ba$DCA_p,  ##
               all_covar,
               Cohort = all_basic$Cohort,
               sv=all_vsv$`Coprococcus comes ATCC 27758:2932_2935;2935_2937`,
               abun = all_abun_clr$s__Coprococcus_comes) %>% 
  na.omit

df[,c(1,2,3,4,6,8,11,12)] <- apply(df[,c(1,2,3,4,6,8,11,12)], 2, qtrans) %>% 
  as.data.frame

df_lm<- summary(lm(phen~Age+Gender+Cohort+BMI+Reads_number+abun,data = df))

df_density <- get_density(df_lm$residuals, df$sv, n = 200)

es_cor<-cor.test(df_lm$residuals, df$sv, method = "spearman")
text_r<-paste("C.comes:2932_2935;2935_2937","Beta=0.33, P=1.20E-27",sep = "\n") ##

pdf("09.Microbial_GWAS/Example_C.comes_2932_DCA_p.pdf", height = 4, width = 4.5)
ggplot(df, aes(sv, phen,color = Cohort.1))+
  geom_point(size = 3,alpha = 0.5)+
  geom_smooth(method = 'lm', color = 'white', linetype = 'dashed')+
  scale_color_manual(breaks = c("LLD","300OB"),
                     labels = c("LLD", "300OB"),
                     values = mycolor2_blue_yellow)+
  ggtitle(text_r)+
  xlab("Standardized region coverage")+
  ylab("Residuals of DCA proportion")+ ##
  theme_classic2()+
  theme(legend.position = 'none',
        plot.title = element_text(hjust = 0.5,size = 10))

dev.off()


## Thirdly significant association:Blautia wexlerae DSM 19850:2081_2082) and DCA
df<-data.frame(phen = all_ba$DCA,  ##
               all_covar,
               Cohort = all_basic$Cohort,
               sv=all_vsv$`Blautia wexlerae DSM 19850:2081_2082`, ##
               abun = all_abun_clr$s__Blautia_wexlerae) %>%  ##
  na.omit

df[,c(1,2,3,4,6,8,11,12)] <- apply(df[,c(1,2,3,4,6,8,11,12)], 2, qtrans) %>% 
  as.data.frame

df_lm<- summary(lm(phen~Age+Gender+Cohort+BMI+Reads_number+abun,data = df))

df_density <- get_density(df_lm$residuals, df$sv, n = 200)

es_cor<-cor.test(df_lm$residuals, df$sv, method = "spearman")
text_r<-paste("B.wexlerae:2081_2082","Beta=-0.23, P=1.67E-16",sep = "\n") ##

pdf("09.Microbial_GWAS/Example_B.wexlerae_2081_DCA.pdf", height = 4, width = 4.5)
ggplot(df, aes(sv, phen,color = Cohort.1))+
  geom_point(size = 3,alpha = 0.5)+
  geom_smooth(method = 'lm', color = 'white', linetype = 'dashed')+
  scale_color_manual(breaks = c("LLD","300OB"),
                     labels = c("LLD", "300OB"),
                     values = mycolor2_blue_yellow)+
  ggtitle(text_r)+
  xlab("Standardized region coverage")+
  ylab("Residuals of DCA")+ ##
  theme_classic2()+
  theme(legend.position = 'none',
        plot.title = element_text(hjust = 0.5,size = 10))

dev.off()

## Blautia wexlerae DSM 19850:2083_2084;2086_2090 and CA_dehydro_deconju_ratio
df<-data.frame(phen = all_ba$CA_dehydro_deconju_ratio,  ##
               all_covar,
               Cohort = all_basic$Cohort,
               sv=all_vsv$`Blautia wexlerae DSM 19850:2083_2084;2086_2090`, ##
               abun = all_abun_clr$s__Blautia_wexlerae) %>% ##
  na.omit

df[,c(1,2,3,4,6,8,11,12)] <- apply(df[,c(1,2,3,4,6,8,11,12)], 2, qtrans) %>% 
  as.data.frame

df_lm<- summary(lm(phen~Age+Gender+Cohort+BMI+Reads_number+abun,data = df))

df_density <- get_density(df_lm$residuals, df$sv, n = 200)

es_cor<-cor.test(df_lm$residuals, df$sv, method = "spearman")
text_r<-paste("B.wexlerae:2083_2084;2086_2090","Beta=-0.21, P=1.32E-12",sep = "\n") ##

pdf("09.Microbial_GWAS/Example_B.wexlerae_2083_CA_dehydro_deconju_ratio.pdf", height = 4, width = 4.5) ##
ggplot(df, aes(sv, phen,color = Cohort.1))+
  geom_point(size = 3,alpha = 0.5)+
  geom_smooth(method = 'lm', color = 'white', linetype = 'dashed')+
  scale_color_manual(breaks = c("LLD","300OB"),
                     labels = c("LLD", "300OB"),
                     values = mycolor2_blue_yellow)+
  ggtitle(text_r)+
  xlab("Standardized region coverage")+
  ylab("Residuals of CA dehydroxylation/deconjugation ratio")+ ##
  theme_classic2()+
  theme(legend.position = 'none',
        plot.title = element_text(hjust = 0.5,size = 10))

dev.off()

## Eubacterium ventriosum ATCC 27560:1512_1517 and CA_dehydro_deconju_ratio
df<-data.frame(phen = all_ba$Secondary_primary_ratio,  ##
               all_covar,
               Cohort = all_basic$Cohort,
               sv=all_vsv$`Eubacterium ventriosum ATCC 27560:1512_1517`, ##
               abun = all_abun_clr$s__Eubacterium_ventriosum) %>% ##
  na.omit

df[,c(1,2,3,4,6,8,11,12)] <- apply(df[,c(1,2,3,4,6,8,11,12)], 2, qtrans) %>% 
  as.data.frame

df_lm<- summary(lm(phen~Age+Gender+Cohort+BMI+Reads_number+abun,data = df))

df_density <- get_density(df_lm$residuals, df$sv, n = 200)

es_cor<-cor.test(df_lm$residuals, df$sv, method = "spearman")
text_r<-paste("E.ventriosum:1512_1517","Beta=-0.41, P=1.06E-7",sep = "\n") ##

pdf("09.Microbial_GWAS/Example_E.ventriosum_1512_Secondary_primary_ratio.pdf", height = 4, width = 4.5) ##
ggplot(df, aes(sv, phen,color = Cohort.1))+
  geom_point(size = 3,alpha = 0.5)+
  geom_smooth(method = 'lm', color = 'white', linetype = 'dashed')+
  scale_color_manual(breaks = c("LLD","300OB"),
                     labels = c("LLD", "300OB"),
                     values = mycolor2_blue_yellow)+
  ggtitle(text_r)+
  xlab("Standardized region coverage")+
  ylab("Residuals of Secondary/primary BA ratio")+ ##
  theme_classic2()+
  theme(legend.position = 'none',
        plot.title = element_text(hjust = 0.5,size = 10))

dev.off()
```


### 4.3 boxplots

```{r 4.3}
all_abun_clr<-abundances(x=as.data.frame(na.omit(all_abun)), transform="clr") %>%as.data.frame
all_abun_clr <- all_abun_clr[match(rownames(all_abun), rownames(all_abun_clr)),]
rownames(all_abun_clr) <- rownames(all_abun)

## [Eubacterium] hallii DSM 3353:2969_2983 and Residuals of CA dehydroxylation/deconjugation ratio
df<-data.frame(phen = all_ba$CA_dehydro_deconju_ratio, 
               all_covar,
               Cohort = all_basic$Cohort,
               sv=all_dsv$`[Eubacterium] hallii DSM 3353:2969_2983`,
               abun = all_abun_clr$s__Eubacterium_hallii) %>% 
  na.omit

df[,c(1,2,3,4,6,8,12)] <- apply(df[,c(1,2,3,4,6,8,12)], 2, qtrans) %>% 
  as.data.frame

df_lm<- summary(lm(phen~Age+Gender+Cohort+BMI+Reads_number+abun,data = df))

df_density <- get_density(df_lm$residuals, df$sv, n = 200)

es_cor<-wilcox.test(df_lm$residuals~as.factor(df$sv))
text_r<-paste("E.hallii:2969_2983","Wilcoxon test, P=2.02E-15",sep = "\n")

my_comparisons <- list(c(0,1))
pdf("09.Microbial_GWAS/Example_E.hallii_2969_CA_dehydro_deconju_ratio.pdf", height = 4, width = 4.5)
ggviolin(df, x = "sv", y = "phen", fill = "sv",color = "sv", 
         title = text_r,
         #palette = blue_yellow_green_red, 
         add.width = 0.005,width = 0.7,
         add = "boxplot", add.params = list(fill = "white", width = 0.1))+
  stat_compare_means(comparisons = my_comparisons, label = "p.signif")+ # Add significance levels
  scale_color_manual(breaks = c(0,1),
                     labels = c("Absence", "Presence"),
                     values = mycolor2_green_blue)+
  scale_fill_manual(breaks = c(0,1),
                    labels = c("Absence", "Presence"),
                    values = mycolor2_green_blue)+
  scale_x_discrete(breaks = c(0,1),
                   labels = c("Absence", "Presence"))+
  xlab(NULL)+
  ylab("Residuals of CA dehydroxylation/deconjugation ratio")+ # xxx  ARGs Shannon index   ARGs count
  theme_classic2()+
  theme(legend.position = 'none',
        plot.title = element_text(hjust = 0.5,size = 10))

dev.off()


```
